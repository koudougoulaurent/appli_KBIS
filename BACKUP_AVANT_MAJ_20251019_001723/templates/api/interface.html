{% extends 'base.html' %}
{% load static %}

{% block title %}API Interface - Gestion Immobilière{% endblock %}

{% block extra_css %}
<style>
    .api-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .api-card {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .api-endpoint {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        margin: 0.5rem 0;
    }
    
    .response-area {
        background: #34495e;
        color: #ecf0f1;
        padding: 1rem;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
    
    .btn-api {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        border: none;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    
    .btn-api:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        color: white;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        border-radius: 15px;
        padding: 1.5rem;
        color: white;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .search-box {
        background: rgba(255,255,255,0.9);
        border-radius: 25px;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="api-section">
                <h1 class="text-center mb-4">
                    <i class="bi bi-house-gear"></i>
                    Centre de Navigation - Gestion Immobilière
                </h1>
                <p class="text-center mb-0">
                    Accédez rapidement à toutes les fonctionnalités de l'application ou testez l'API REST
                </p>
            </div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="total-users">-</div>
                <div>Utilisateurs</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="total-proprietes">-</div>
                <div>Propriétés</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="total-bailleurs">-</div>
                <div>Bailleurs</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="total-locataires">-</div>
                <div>Locataires</div>
            </div>
        </div>
    </div>

    <!-- Navigation rapide -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="search-box">
                <h5 class="mb-3"><i class="bi bi-lightning"></i> Navigation Rapide</h5>
                <div class="row">
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="window.location.href='/dashboard/'">
                            <i class="bi bi-speedometer2"></i><br>Dashboard
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="window.location.href='/proprietes/'">
                            <i class="bi bi-house"></i><br>Propriétés
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-info w-100 mb-2" onclick="window.location.href='/contrats/liste/'">
                            <i class="bi bi-file-text"></i><br>Contrats
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-warning w-100 mb-2" onclick="window.location.href='/paiements/liste/'">
                            <i class="bi bi-credit-card"></i><br>Paiements
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100 mb-2" onclick="window.location.href='/utilisateurs/liste/'">
                            <i class="bi bi-people"></i><br>Utilisateurs
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-danger w-100 mb-2" onclick="window.location.href='/admin/'">
                            <i class="bi bi-gear"></i><br>Administration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de recherche -->
    <div class="row">
        <div class="col-12">
            <div class="search-box">
                <h5 class="mb-3"><i class="bi bi-search"></i> Recherche Globale</h5>
                <div class="row">
                    <div class="col-md-4">
                        <select class="form-select" id="search-type" title="Type de recherche">
                            <option value="utilisateurs">Utilisateurs</option>
                            <option value="proprietes">Propriétés</option>
                            <option value="bailleurs">Bailleurs</option>
                            <option value="locataires">Locataires</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="search-query" placeholder="Rechercher...">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="performSearch()">
                            <i class="bi bi-search"></i> Rechercher
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sections API -->
    <div class="row">
        <!-- Utilisateurs -->
        <div class="col-md-6">
            <div class="api-section">
                <h3><i class="bi bi-people"></i> API Utilisateurs</h3>
                
                <div class="api-card">
                    <h5>Liste des utilisateurs</h5>
                    <div class="api-endpoint">Interface: /utilisateurs/liste/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('utilisateurs', 'list')">
                        <i class="bi bi-list"></i> Voir la liste
                    </button>
                    <button class="btn btn-api ms-2" onclick="getUsers()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="users-response"></div>
                </div>

                <div class="api-card">
                    <h5>Statistiques utilisateurs</h5>
                    <div class="api-endpoint">Interface: /utilisateurs/statistiques/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('utilisateurs', 'stats')">
                        <i class="bi bi-graph-up"></i> Voir statistiques
                    </button>
                    <button class="btn btn-api ms-2" onclick="getUserStats()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="user-stats-response"></div>
                </div>

                <div class="api-card">
                    <h5>Utilisateur connecté</h5>
                    <div class="api-endpoint">Interface: /utilisateurs/profil/</div>
                    <button class="btn btn-api" onclick="window.location.href='/utilisateurs/profil/'">
                        <i class="bi bi-person"></i> Mon profil
                    </button>
                    <button class="btn btn-api ms-2" onclick="getCurrentUser()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="current-user-response"></div>
                </div>
            </div>
        </div>

        <!-- Propriétés -->
        <div class="col-md-6">
            <div class="api-section">
                <h3><i class="bi bi-house"></i> API Propriétés</h3>
                
                <div class="api-card">
                    <h5>Liste des propriétés</h5>
                    <div class="api-endpoint">Interface: /proprietes/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('proprietes', 'list')">
                        <i class="bi bi-list"></i> Voir la liste
                    </button>
                    <button class="btn btn-api ms-2" onclick="getProperties()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="properties-response"></div>
                </div>

                <div class="api-card">
                    <h5>Statistiques propriétés</h5>
                    <div class="api-endpoint">Interface: /proprietes/statistiques/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('proprietes', 'stats')">
                        <i class="bi bi-graph-up"></i> Voir statistiques
                    </button>
                    <button class="btn btn-api ms-2" onclick="getPropertyStats()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="property-stats-response"></div>
                </div>

                <div class="api-card">
                    <h5>Propriétés disponibles</h5>
                    <div class="api-endpoint">Interface: /proprietes/disponibles/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('proprietes', 'disponibles')">
                        <i class="bi bi-check-circle"></i> Voir disponibles
                    </button>
                    <button class="btn btn-api ms-2" onclick="getAvailableProperties()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="available-properties-response"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Bailleurs -->
        <div class="col-md-6">
            <div class="api-section">
                <h3><i class="bi bi-person-badge"></i> API Bailleurs</h3>
                
                <div class="api-card">
                    <h5>Liste des bailleurs</h5>
                    <div class="api-endpoint">Interface: /proprietes/bailleurs/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('bailleurs', 'list')">
                        <i class="bi bi-list"></i> Voir la liste
                    </button>
                    <button class="btn btn-api ms-2" onclick="getBailleurs()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="bailleurs-response"></div>
                </div>

                <div class="api-card">
                    <h5>Statistiques bailleurs</h5>
                    <div class="api-endpoint">Interface: /proprietes/bailleurs/statistiques/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('bailleurs', 'stats')">
                        <i class="bi bi-graph-up"></i> Voir statistiques
                    </button>
                    <button class="btn btn-api ms-2" onclick="getBailleurStats()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="bailleur-stats-response"></div>
                </div>
            </div>
        </div>

        <!-- Locataires -->
        <div class="col-md-6">
            <div class="api-section">
                <h3><i class="bi bi-person-check"></i> API Locataires</h3>
                
                <div class="api-card">
                    <h5>Liste des locataires</h5>
                    <div class="api-endpoint">Interface: /proprietes/locataires/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('locataires', 'list')">
                        <i class="bi bi-list"></i> Voir la liste
                    </button>
                    <button class="btn btn-api ms-2" onclick="getLocataires()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="locataires-response"></div>
                </div>

                <div class="api-card">
                    <h5>Statistiques locataires</h5>
                    <div class="api-endpoint">Interface: /proprietes/locataires/statistiques/</div>
                    <button class="btn btn-api" onclick="redirectToInterface('locataires', 'stats')">
                        <i class="bi bi-graph-up"></i> Voir statistiques
                    </button>
                    <button class="btn btn-api ms-2" onclick="getLocataireStats()">
                        <i class="bi bi-code"></i> API Test
                    </button>
                    <div class="response-area mt-2" id="locataire-stats-response"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuration de l'API
const API_BASE = '';

// Fonctions utilitaires
function displayResponse(elementId, data) {
    const element = document.getElementById(elementId);
    element.textContent = JSON.stringify(data, null, 2);
}

function handleError(elementId, error) {
    const element = document.getElementById(elementId);
    element.textContent = `Erreur: ${error.message}`;
}

// Fonction pour rediriger vers l'interface applicative
function redirectToInterface(type, action = 'list') {
    const routes = {
        'utilisateurs': {
            'list': '/utilisateurs/liste/',
            'create': '/utilisateurs/ajouter/',
            'stats': '/utilisateurs/statistiques/'
        },
        'proprietes': {
            'list': '/proprietes/',
            'create': '/proprietes/ajouter/',
            'stats': '/proprietes/statistiques/',
            'disponibles': '/proprietes/disponibles/'
        },
        'bailleurs': {
            'list': '/proprietes/bailleurs/',
            'create': '/proprietes/bailleurs/ajouter/',
            'stats': '/proprietes/bailleurs/statistiques/'
        },
        'locataires': {
            'list': '/proprietes/locataires/',
            'create': '/proprietes/locataires/ajouter/',
            'stats': '/proprietes/locataires/statistiques/'
        },
        'contrats': {
            'list': '/contrats/liste/',
            'create': '/contrats/ajouter/',
            'stats': '/contrats/statistiques/'
        },
        'paiements': {
            'list': '/paiements/liste/',
            'create': '/paiements/ajouter/',
            'stats': '/paiements/statistiques/'
        }
    };
    
    if (routes[type] && routes[type][action]) {
        window.location.href = routes[type][action];
    } else {
        console.error(`Route non trouvée pour ${type}/${action}`);
    }
}

// Fonctions API Utilisateurs
async function getUsers() {
    try {
        const response = await fetch(`${API_BASE}/utilisateurs/api/`);
        const data = await response.json();
        displayResponse('users-response', data);
    } catch (error) {
        handleError('users-response', error);
    }
}

async function getUserStats() {
    try {
        const response = await fetch(`${API_BASE}/utilisateurs/api/stats/`);
        const data = await response.json();
        displayResponse('user-stats-response', data);
        
        // Mettre à jour les statistiques globales
        document.getElementById('total-users').textContent = data.total_users || '-';
    } catch (error) {
        handleError('user-stats-response', error);
    }
}

async function getCurrentUser() {
    try {
        const response = await fetch(`${API_BASE}/utilisateurs/api/me/`);
        const data = await response.json();
        displayResponse('current-user-response', data);
    } catch (error) {
        handleError('current-user-response', error);
    }
}

// Fonctions API Propriétés
async function getProperties() {
    try {
        const response = await fetch(`${API_BASE}/proprietes/api/proprietes/`);
        const data = await response.json();
        displayResponse('properties-response', data);
    } catch (error) {
        handleError('properties-response', error);
    }
}

async function getPropertyStats() {
    try {
        const response = await fetch(`${API_BASE}/proprietes/api/proprietes/stats/`);
        const data = await response.json();
        displayResponse('property-stats-response', data);
        
        // Mettre à jour les statistiques globales
        document.getElementById('total-proprietes').textContent = data.total_proprietes || '-';
    } catch (error) {
        handleError('property-stats-response', error);
    }
}

async function getAvailableProperties() {
    try {
        const response = await fetch(`${API_BASE}/proprietes/api/proprietes/disponibles/`);
        const data = await response.json();
        displayResponse('available-properties-response', data);
    } catch (error) {
        handleError('available-properties-response', error);
    }
}

// Fonctions API Bailleurs
async function getBailleurs() {
    try {
        const response = await fetch(`${API_BASE}/proprietes/api/bailleurs/`);
        const data = await response.json();
        displayResponse('bailleurs-response', data);
    } catch (error) {
        handleError('bailleurs-response', error);
    }
}

async function getBailleurStats() {
    try {
        const response = await fetch(`${API_BASE}/proprietes/api/bailleurs/stats/`);
        const data = await response.json();
        displayResponse('bailleur-stats-response', data);
        
        // Mettre à jour les statistiques globales
        document.getElementById('total-bailleurs').textContent = data.total_bailleurs || '-';
    } catch (error) {
        handleError('bailleur-stats-response', error);
    }
}

// Fonctions API Locataires
async function getLocataires() {
    try {
        const response = await fetch(`${API_BASE}/proprietes/api/locataires/`);
        const data = await response.json();
        displayResponse('locataires-response', data);
    } catch (error) {
        handleError('locataires-response', error);
    }
}

async function getLocataireStats() {
    try {
        const response = await fetch(`${API_BASE}/proprietes/api/locataires/stats/`);
        const data = await response.json();
        displayResponse('locataire-stats-response', data);
        
        // Mettre à jour les statistiques globales
        document.getElementById('total-locataires').textContent = data.total_locataires || '-';
    } catch (error) {
        handleError('locataire-stats-response', error);
    }
}

// Fonction de recherche
async function performSearch() {
    const searchType = document.getElementById('search-type').value;
    const query = document.getElementById('search-query').value;
    
    if (!query) {
        alert('Veuillez entrer un terme de recherche');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/${searchType}/api/${searchType}/search/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        // Afficher les résultats dans la section appropriée
        const responseId = `${searchType}-response`;
        displayResponse(responseId, data);
    } catch (error) {
        alert(`Erreur lors de la recherche: ${error.message}`);
    }
}

// Charger les statistiques au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    getUserStats();
    getPropertyStats();
    getBailleurStats();
    getLocataireStats();
});
</script>
{% endblock %} 