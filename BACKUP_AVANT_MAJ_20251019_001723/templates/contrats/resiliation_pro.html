{% extends 'base.html' %}
{% load static %}

{% block title %}Formulaire de Résiliation Professionnel{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-file-earmark-text text-primary"></i> Formulaire de Résiliation Professionnel
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Tableau de bord</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'contrats:liste' %}">Contrats</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'contrats:liste_resiliations' %}">Résiliations</a></li>
                    <li class="breadcrumb-item active">Formulaire Pro</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'contrats:liste' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
            <button onclick="window.print()" class="btn btn-primary">
                <i class="bi bi-printer"></i> Imprimer
            </button>
            <a href="{% url 'contrats:telecharger_resiliation_pdf' contrat.pk %}" class="btn btn-success">
                <i class="bi bi-download"></i> Télécharger PDF
            </a>
        </div>
    </div>

    <!-- Formulaire de résiliation professionnel -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-text"></i> Formulaire de Résiliation de Bail
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Informations de l'entreprise -->
                    {% if config_entreprise %}
                    <div class="entreprise-header mb-4 p-3" style="background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid {{ config_entreprise.couleur_principale|default:'#2c3e50' }};">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 style="color: {{ config_entreprise.couleur_principale|default:'#2c3e50' }}; margin-bottom: 0.5rem;">
                                    {{ config_entreprise.nom_entreprise }}
                                </h4>
                                {% if config_entreprise.slogan %}
                                <p style="font-style: italic; color: #6c757d; margin-bottom: 0.5rem;">{{ config_entreprise.slogan }}</p>
                                {% endif %}
                                <div style="font-size: 0.9rem; color: #495057;">
                                    <div>{{ config_entreprise.get_adresse_complete }}</div>
                                    <div>{{ config_entreprise.get_contact_complet }}</div>
                                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem;">
                                        {{ config_entreprise.get_informations_legales }}
                                    </div>
                                </div>
                            </div>
                            {% if config_entreprise.logo_url %}
                            <div class="col-md-4 text-end">
                                <img src="{{ config_entreprise.logo_url }}" alt="Logo {{ config_entreprise.nom_entreprise }}" 
                                     style="max-height: 80px; max-width: 150px;">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <form method="post" id="resiliationForm">
                        {% csrf_token %}
                        
                        <!-- Informations du contrat -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-info-circle"></i> Informations du Contrat
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Numéro de Contrat</label>
                                    <input type="text" class="form-control" value="{{ contrat.numero_contrat }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Date de Création</label>
                                    <input type="text" class="form-control" value="{{ contrat.date_creation|date:'d/m/Y' }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Informations du bailleur -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-person-badge"></i> Informations du Bailleur
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Nom et Prénom</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.bailleur.nom }} {{ contrat.propriete.bailleur.prenom }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Adresse</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.bailleur.adresse }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Téléphone</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.bailleur.telephone }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.bailleur.email }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Informations du locataire -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-person"></i> Informations du Locataire
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Nom et Prénom</label>
                                    <input type="text" class="form-control" value="{{ contrat.locataire.nom }} {{ contrat.locataire.prenom }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Adresse</label>
                                    <input type="text" class="form-control" value="{{ contrat.locataire.adresse }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Téléphone</label>
                                    <input type="text" class="form-control" value="{{ contrat.locataire.telephone }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <input type="text" class="form-control" value="{{ contrat.locataire.email }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Informations du bien -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-house"></i> Informations du Bien
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Adresse du Bien</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.adresse }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ville</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.ville }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Code Postal</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.code_postal }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Type de Bien</label>
                                    <input type="text" class="form-control" value="{{ contrat.propriete.get_type_display }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Détails du contrat -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-calendar-check"></i> Détails du Contrat
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Date de Début</label>
                                    <input type="text" class="form-control" value="{{ contrat.date_debut|date:'d/m/Y' }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Date de Fin Initiale</label>
                                    <input type="text" class="form-control" value="{{ contrat.date_fin|date:'d/m/Y' }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Loyer Mensuel</label>
                                    <input type="text" class="form-control" value="{{ contrat.get_loyer_mensuel_formatted }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Charges Mensuelles</label>
                                    <input type="text" class="form-control" value="{{ contrat.get_charges_mensuelles_formatted }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Informations de résiliation -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-x-circle"></i> Informations de Résiliation
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date_resiliation" class="form-label fw-bold">Date de Résiliation *</label>
                                    <input type="date" class="form-control" id="date_resiliation" name="date_resiliation" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date_liberation" class="form-label fw-bold">Date de Libération *</label>
                                    <input type="date" class="form-control" id="date_liberation" name="date_liberation" required>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="motif_resiliation" class="form-label fw-bold">Motif de Résiliation *</label>
                                    <textarea class="form-control" id="motif_resiliation" name="motif_resiliation" rows="4" required 
                                              placeholder="Précisez le motif de la résiliation..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Conditions de résiliation -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-list-check"></i> Conditions de Résiliation
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="delai_preavis" class="form-label fw-bold">Délai de Préavis (mois)</label>
                                    <select class="form-select" id="delai_preavis" name="delai_preavis" required>
                                        <option value="">Sélectionner...</option>
                                        <option value="1">1 mois</option>
                                        <option value="2">2 mois</option>
                                        <option value="3">3 mois</option>
                                        <option value="6">6 mois</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="type_resiliation" class="form-label fw-bold">Type de Résiliation</label>
                                    <select class="form-select" id="type_resiliation" name="type_resiliation" required>
                                        <option value="">Sélectionner...</option>
                                        <option value="AM">A l'amiable</option>
                                        <option value="JUD">Judiciaire</option>
                                        <option value="EXP">Expiration du bail</option>
                                        <option value="AUT">Autre</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Gestion des cautions et charges -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-cash-coin"></i> Gestion Financière
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="caution_remboursee" class="form-label fw-bold">Caution Remboursée</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="caution_remboursee" name="caution_remboursee">
                                        <label class="form-check-label" for="caution_remboursee">
                                            La caution sera remboursée
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="charges_reglees" class="form-label fw-bold">Charges Réglées</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="charges_reglees" name="charges_reglees">
                                        <label class="form-check-label" for="charges_reglees">
                                            Les charges sont réglées
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="observations" class="form-label fw-bold">Observations Complémentaires</label>
                                    <textarea class="form-control" id="observations" name="observations" rows="3" 
                                              placeholder="Observations, conditions particulières..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Signatures -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="bi bi-pen"></i> Signatures
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Signature du Gérant</label>
                                    <div class="border rounded p-3 text-center" style="min-height: 100px;">
                                        <small class="text-muted">Signature du Gérant</small>
                                    </div>
                                    <small class="text-muted">Date: _____________</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Signature du Locataire</label>
                                    <div class="border rounded p-3 text-center" style="min-height: 100px;">
                                        <small class="text-muted">Signature du locataire</small>
                                    </div>
                                    <small class="text-muted">Date: _____________</small>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="row">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary btn-lg me-3">
                                    <i class="bi bi-check-circle"></i> Valider la Résiliation
                                </button>
                                <a href="{% url 'contrats:liste' %}" class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-x-circle"></i> Annuler
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles pour l'impression -->
<style media="print">
    @page {
        size: A4;
        margin: 2cm;
    }
    
    .btn, .breadcrumb, .card-header {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-body {
        padding: 0 !important;
    }
    
    h1, h6 {
        color: #000 !important;
    }
    
    .text-primary {
        color: #000 !important;
    }
    
    .border-bottom {
        border-bottom: 2px solid #000 !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validation du formulaire
    const form = document.getElementById('resiliationForm');
    const dateResiliation = document.getElementById('date_resiliation');
    const dateLiberation = document.getElementById('date_liberation');
    
    // Définir la date de résiliation par défaut à aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    dateResiliation.value = today;
    
    // Calculer la date de libération (1 mois après)
    const liberationDate = new Date();
    liberationDate.setMonth(liberationDate.getMonth() + 1);
    dateLiberation.value = liberationDate.toISOString().split('T')[0];
    
    // Validation des dates
    dateResiliation.addEventListener('change', function() {
        if (dateLiberation.value && dateResiliation.value > dateLiberation.value) {
            alert('La date de résiliation ne peut pas être postérieure à la date de libération');
            dateResiliation.value = '';
        }
    });
    
    dateLiberation.addEventListener('change', function() {
        if (dateResiliation.value && dateResiliation.value > dateLiberation.value) {
            alert('La date de libération doit être postérieure à la date de résiliation');
            dateLiberation.value = '';
        }
    });
    
    // Validation avant soumission
    form.addEventListener('submit', function(e) {
        if (!dateResiliation.value || !dateLiberation.value || !document.getElementById('motif_resiliation').value) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs obligatoires');
        }
    });
});
</script>
{% endblock %}
