{% extends 'base.html' %}
{% load static %}

{% block title %}Debug Formulaire Unité Locative{% endblock %}

{% block extra_css %}
<style>
    .debug-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
    }
    
    .debug-section {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .debug-title {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    .form-field-debug {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
    }
    
    .field-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    .error-field {
        border-color: #dc3545 !important;
        background-color: #f8d7da !important;
    }
    
    .valid-field {
        border-color: #198754 !important;
        background-color: #d1e7dd !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="debug-container">
    <h1 class="text-center mb-4">Debug Formulaire Unité Locative</h1>
    
    <div class="debug-section">
        <h2 class="debug-title">Test de Validation des Champs</h2>
        <p>Ce formulaire de test vous permet de diagnostiquer les problèmes de validation.</p>
        
        <form method="post" class="needs-validation" novalidate id="debug-form">
            {% csrf_token %}
            
            <div class="form-field-debug">
                <label for="id_propriete" class="form-label">Propriété *</label>
                <select id="id_propriete" name="propriete" class="form-select" required>
                    <option value="">Sélectionnez une propriété</option>
                    <option value="1">Test Propriété 1</option>
                    <option value="2">Test Propriété 2</option>
                </select>
                <div class="field-info">
                    <strong>Required:</strong> <span id="propriete-required">true</span> | 
                    <strong>Valid:</strong> <span id="propriete-valid">false</span>
                </div>
            </div>
            
            <div class="form-field-debug">
                <label for="id_numero_unite" class="form-label">Numéro d'unité *</label>
                <input type="text" id="id_numero_unite" name="numero_unite" class="form-control" required>
                <div class="field-info">
                    <strong>Required:</strong> <span id="numero-required">true</span> | 
                    <strong>Valid:</strong> <span id="numero-valid">false</span>
                </div>
            </div>
            
            <div class="form-field-debug">
                <label for="id_nom" class="form-label">Nom *</label>
                <input type="text" id="id_nom" name="nom" class="form-control" required>
                <div class="field-info">
                    <strong>Required:</strong> <span id="nom-required">true</span> | 
                    <strong>Valid:</strong> <span id="nom-valid">false</span>
                </div>
            </div>
            
            <div class="form-field-debug">
                <label for="id_type_unite" class="form-label">Type d'unité *</label>
                <select id="id_type_unite" name="type_unite" class="form-select" required>
                    <option value="">Sélectionnez un type</option>
                    <option value="appartement">Appartement</option>
                    <option value="maison">Maison</option>
                    <option value="bureau">Bureau</option>
                    <option value="commerce">Commerce</option>
                </select>
                <div class="field-info">
                    <strong>Required:</strong> <span id="type-required">true</span> | 
                    <strong>Valid:</strong> <span id="type-valid">false</span>
                </div>
            </div>
            
            <div class="form-field-debug">
                <label for="id_loyer_mensuel" class="form-label">Loyer mensuel *</label>
                <input type="number" id="id_loyer_mensuel" name="loyer_mensuel" class="form-control" required step="0.01">
                <div class="field-info">
                    <strong>Required:</strong> <span id="loyer-required">true</span> | 
                    <strong>Valid:</strong> <span id="loyer-valid">false</span>
                </div>
            </div>
            
            <div class="form-field-debug">
                <label for="id_charges_mensuelles" class="form-label">Charges mensuelles</label>
                <input type="number" id="id_charges_mensuelles" name="charges_mensuelles" class="form-control" step="0.01">
                <div class="field-info">
                    <strong>Required:</strong> <span id="charges-required">false</span> | 
                    <strong>Valid:</strong> <span id="charges-valid">true</span>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> Tester la soumission
            </button>
        </form>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">Logs de Debug</h2>
        <div id="debug-logs" style="background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">
            <div>Prêt pour les tests...</div>
        </div>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">Instructions</h2>
        <ol>
            <li>Remplissez les champs obligatoires (marqués d'un *)</li>
            <li>Cliquez sur "Tester la soumission"</li>
            <li>Observez les logs de debug pour voir ce qui se passe</li>
            <li>Vérifiez que les champs se colorent correctement (vert = valide, rouge = invalide)</li>
        </ol>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('debug-form');
    const logs = document.getElementById('debug-logs');
    
    function addLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        logs.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        logs.scrollTop = logs.scrollHeight;
    }
    
    function updateFieldStatus(fieldId, isValid) {
        const field = document.getElementById(fieldId);
        const validSpan = document.getElementById(fieldId.replace('id_', '').replace('_', '-') + '-valid');
        
        if (isValid) {
            field.classList.remove('error-field');
            field.classList.add('valid-field');
            validSpan.textContent = 'true';
        } else {
            field.classList.remove('valid-field');
            field.classList.add('error-field');
            validSpan.textContent = 'false';
        }
    }
    
    // Validation en temps réel
    const requiredFields = ['id_propriete', 'id_numero_unite', 'id_nom', 'id_type_unite', 'id_loyer_mensuel'];
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.addEventListener('blur', function() {
            const isValid = this.checkValidity();
            updateFieldStatus(fieldId, isValid);
            addLog(`Champ ${fieldId}: ${isValid ? 'valide' : 'invalide'}`);
        });
    });
    
    // Validation du formulaire
    form.addEventListener('submit', function(e) {
        addLog('=== DÉBUT DE LA VALIDATION ===');
        
        let isValid = true;
        let invalidFields = [];
        
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const fieldValid = field.checkValidity();
            
            addLog(`Validation ${fieldId}: ${fieldValid ? 'OK' : 'ÉCHEC'}`);
            
            if (!fieldValid) {
                isValid = false;
                invalidFields.push(fieldId);
                updateFieldStatus(fieldId, false);
            } else {
                updateFieldStatus(fieldId, true);
            }
        });
        
        if (!isValid) {
            addLog(`❌ VALIDATION ÉCHOUÉE - Champs invalides: ${invalidFields.join(', ')}`);
            addLog('Soumission bloquée');
            e.preventDefault();
            e.stopPropagation();
        } else {
            addLog('✅ VALIDATION RÉUSSIE - Soumission autorisée');
        }
        
        addLog('=== FIN DE LA VALIDATION ===');
    });
    
    addLog('Debug initialisé');
});
</script>
{% endblock %}

