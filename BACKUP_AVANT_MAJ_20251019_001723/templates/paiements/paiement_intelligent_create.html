{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet" />
<style>
    .contexte-panel {
        transition: all 0.3s ease;
    }
    
    .contexte-panel.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .contexte-panel.d-none {
        opacity: 0;
        transform: translateY(-20px);
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .card-header {
        border-radius: 0.5rem 0.5rem 0 0 !important;
        font-weight: 600;
    }
    
    .badge {
        font-size: 0.875em;
        padding: 0.5em 0.75em;
    }
    
    .form-control-lg, .form-select-lg {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    .alert {
        border-radius: 0.5rem;
        border: none;
    }
    
    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .contexte-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    @media (max-width: 768px) {
        .contexte-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Formulaire principal -->
        <div class="col-lg-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus-circle"></i> {{ title }}
                    </h4>
                    <p class="mb-0 text-white-50">{{ subtitle }}</p>
                </div>
                <div class="card-body">
                    <form method="post" id="form-paiement-intelligent">
                        {% csrf_token %}
                        
                        <!-- Sélection du contrat -->
                        <div class="mb-4">
                            <label for="{{ form.contrat.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-search"></i> Sélectionnez un contrat
                            </label>
                            {{ form.contrat }}
                            {% if form.contrat.help_text %}
                                <div class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> {{ form.contrat.help_text }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Champs suggérés (en lecture seule) -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.montant_suggere.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-lightbulb"></i> Montant suggéré
                                </label>
                                {{ form.montant_suggere }}
                                {% if form.montant_suggere.help_text %}
                                    <div class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> {{ form.montant_suggere.help_text }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.libelle_suggere.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-lightbulb"></i> Libellé suggéré
                                </label>
                                {{ form.libelle_suggere }}
                                {% if form.libelle_suggere.help_text %}
                                    <div class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> {{ form.libelle_suggere.help_text }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Champs de saisie -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.montant.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-money-bill-wave"></i> Montant du paiement
                                </label>
                                {{ form.montant }}
                                {% if form.montant.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.montant.errors %}
                                            <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.date_paiement.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-calendar"></i> Date de paiement
                                </label>
                                {{ form.date_paiement }}
                                {% if form.date_paiement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.date_paiement.errors %}
                                            <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.type_paiement.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-tags"></i> Type de paiement
                                </label>
                                {{ form.type_paiement }}
                                {% if form.type_paiement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.type_paiement.errors %}
                                            <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.mode_paiement.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-credit-card"></i> Mode de paiement
                                </label>
                                {{ form.mode_paiement }}
                                {% if form.mode_paiement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.mode_paiement.errors %}
                                            <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.reference_paiement.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-hashtag"></i> Référence
                                </label>
                                {{ form.reference_paiement }}
                                {% if form.reference_paiement.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.reference_paiement.errors %}
                                            <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.statut.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-check-circle"></i> Statut
                                </label>
                                {{ form.statut }}
                                {% if form.statut.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.statut.errors %}
                                            <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.libelle.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-edit"></i> Libellé personnalisé
                            </label>
                            {{ form.libelle }}
                            {% if form.libelle.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.libelle.errors %}
                                        <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Champ caché pour le contexte -->
                        {{ form.contexte_contrat }}
                        
                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'paiements:liste' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left"></i> Retour
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Créer le paiement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Panneau de contexte intelligent -->
        <div class="col-lg-6">
            <div id="panneau-contexte" class="contexte-panel d-none">
                <!-- Le contenu sera chargé dynamiquement par JavaScript -->
            </div>
            
            <!-- Instructions -->
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Comment ça marche ?
                    </h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li><strong>Sélectionnez un contrat</strong> dans la liste déroulante</li>
                        <li><strong>Toutes les informations</strong> s'affichent automatiquement</li>
                        <li><strong>Les suggestions</strong> vous aident à remplir le formulaire</li>
                        <li><strong>Le contexte complet</strong> vous donne une vue d'ensemble</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="{% static 'js/contexte_intelligent.js' %}"></script>

<script>
$(document).ready(function() {
    // Initialisation de Select2
    $('#contrat-select').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Recherchez un contrat...',
        allowClear: true,
        language: 'fr'
    });
    
    // Validation du formulaire
    $('#form-paiement-intelligent').on('submit', function(e) {
        const contrat = $('#contrat-select').val();
        if (!contrat) {
            e.preventDefault();
            alert('Veuillez sélectionner un contrat avant de soumettre le formulaire.');
            $('#contrat-select').focus();
            return false;
        }
    });
    
    // Mise à jour automatique de la date si vide
    if (!$('#date-paiement').val()) {
        $('#date-paiement').val(new Date().toISOString().split('T')[0]);
    }
});
</script>
{% endblock %}
