{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Créer un Plan de Paiement Partiel - Version Pro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" media="print" onload="this.media='all'">
<style>
    .wizard-container {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 3rem;
        position: relative;
    }
    
    .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
    }
    
    .wizard-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #e2e8f0;
        z-index: 1;
    }
    
    .wizard-step.active:not(:last-child)::after {
        background: #667eea;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e2e8f0;
        color: #718096;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .wizard-step.active .step-circle {
        background: #667eea;
        color: white;
    }
    
    .wizard-step.completed .step-circle {
        background: #38a169;
        color: white;
    }
    
    .step-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #718096;
        text-align: center;
    }
    
    .wizard-step.active .step-label {
        color: #667eea;
    }
    
    .wizard-step.completed .step-label {
        color: #38a169;
    }
    
    .wizard-content {
        min-height: 400px;
    }
    
    .form-section {
        background: #f8f9fc;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e3e6f0;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-title i {
        color: #667eea;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }
    
    .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-control.is-invalid {
        border-color: #e53e3e;
    }
    
    .form-control.is-valid {
        border-color: #38a169;
    }
    
    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #e53e3e;
    }
    
    .valid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #38a169;
    }
    
    .smart-suggestions {
        background: #e6fffa;
        border: 1px solid #38a169;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .suggestion-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #d1fae5;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .suggestion-item:hover {
        background: #d1fae5;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .suggestion-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #38a169;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 0.8rem;
    }
    
    .calculation-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .calc-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .calc-item:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .preview-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .preview-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .preview-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }
    
    .preview-subtitle {
        color: #718096;
    }
    
    .preview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .preview-stat {
        text-align: center;
        padding: 1rem;
        background: #f8f9fc;
        border-radius: 10px;
    }
    
    .preview-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }
    
    .preview-stat-label {
        font-size: 0.875rem;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e2e8f0;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.75rem;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e2e8f0;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #e2e8f0;
    }
    
    .timeline-item.active::before {
        background: #667eea;
        box-shadow: 0 0 0 2px #667eea;
    }
    
    .timeline-item.completed::before {
        background: #38a169;
        box-shadow: 0 0 0 2px #38a169;
    }
    
    .timeline-content {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .btn-wizard {
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-wizard-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }
    
    .btn-wizard-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .btn-wizard-secondary {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        color: #718096;
    }
    
    .btn-wizard-secondary:hover {
        background: #edf2f7;
        border-color: #cbd5e0;
        color: #4a5568;
    }
    
    .wizard-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 2rem;
        border-top: 1px solid #e2e8f0;
    }
    
    .mobile-optimized {
        display: none;
    }
    
    @media (max-width: 768px) {
        .wizard-steps {
            flex-direction: column;
            gap: 1rem;
        }
        
        .wizard-step:not(:last-child)::after {
            display: none;
        }
        
        .preview-stats {
            grid-template-columns: 1fr;
        }
        
        .wizard-actions {
            flex-direction: column;
            gap: 1rem;
        }
        
        .wizard-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-12">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h2 mb-2">
                    <i class="fas fa-calendar-check text-primary me-3"></i>
                    Créer un Plan de Paiement Partiel
                </h1>
                <p class="text-muted">Assistant intelligent pour créer des plans de paiement professionnels</p>
            </div>

            <!-- Assistant de Création -->
            <div class="wizard-container">
                <!-- Étapes -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Informations</div>
                    </div>
                    <div class="wizard-step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Montants</div>
                    </div>
                    <div class="wizard-step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Échéances</div>
                    </div>
                    <div class="wizard-step" data-step="4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Validation</div>
                    </div>
                </div>

                <!-- Contenu des Étapes -->
                <div class="wizard-content">
                    <form method="post" id="planForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Étape 1: Informations -->
                        <div class="wizard-step-content" id="step1">
                            <div class="form-section">
                                <h3 class="section-title">
                                    <i class="fas fa-info-circle"></i>
                                    Informations du Plan
                                </h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.contrat.id_for_label }}" class="form-label">
                                                Contrat <span class="text-danger">*</span>
                                            </label>
                                            {{ form.contrat }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.nom_plan.id_for_label }}" class="form-label">
                                                Nom du Plan <span class="text-danger">*</span>
                                            </label>
                                            {{ form.nom_plan }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.description.id_for_label }}" class="form-label">
                                        Description
                                    </label>
                                    {{ form.description }}
                                    <div class="help-text">Description détaillée du plan de paiement partiel (optionnel)</div>
                                </div>
                                
                                <!-- Suggestions intelligentes -->
                                <div class="smart-suggestions" id="smartSuggestions" style="display: none;">
                                    <h6 class="mb-3">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        Suggestions intelligentes
                                    </h6>
                                    <div class="suggestion-item" onclick="applySuggestion('monthly')">
                                        <div class="suggestion-icon">
                                            <i class="fas fa-calendar"></i>
                                        </div>
                                        <div>
                                            <strong>Plan mensuel</strong>
                                            <br>
                                            <small>Paiements échelonnés sur 3-6 mois</small>
                                        </div>
                                    </div>
                                    <div class="suggestion-item" onclick="applySuggestion('quarterly')">
                                        <div class="suggestion-icon">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        <div>
                                            <strong>Plan trimestriel</strong>
                                            <br>
                                            <small>Paiements tous les 3 mois</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 2: Montants -->
                        <div class="wizard-step-content" id="step2" style="display: none;">
                            <div class="form-section">
                                <h3 class="section-title">
                                    <i class="fas fa-calculator"></i>
                                    Montants et Calculs
                                </h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.montant_total.id_for_label }}" class="form-label">
                                                Montant à Payer <span class="text-danger">*</span>
                                            </label>
                                            {{ form.montant_total }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.statut.id_for_label }}" class="form-label">
                                                Statut Initial
                                            </label>
                                            {{ form.statut }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Calculs automatiques -->
                                <div class="calculation-panel">
                                    <h5 class="mb-3">
                                        <i class="fas fa-calculator me-2"></i>
                                        Calculs Automatiques
                                    </h5>
                                    <div class="calc-item">
                                        <span>Montant total du plan</span>
                                        <span id="calcTotal">0 FCFA</span>
                                    </div>
                                    <div class="calc-item">
                                        <span>Nombre d'échéances suggérées</span>
                                        <span id="calcEcheances">0</span>
                                    </div>
                                    <div class="calc-item">
                                        <span>Montant par échéance</span>
                                        <span id="calcEcheance">0 FCFA</span>
                                    </div>
                                    <div class="calc-item">
                                        <span>Durée estimée</span>
                                        <span id="calcDuree">0 mois</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 3: Échéances -->
                        <div class="wizard-step-content" id="step3" style="display: none;">
                            <div class="form-section">
                                <h3 class="section-title">
                                    <i class="fas fa-calendar-alt"></i>
                                    Planification des Échéances
                                </h3>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.date_debut.id_for_label }}" class="form-label">
                                                Date de Début <span class="text-danger">*</span>
                                            </label>
                                            {{ form.date_debut }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.date_fin_prevue.id_for_label }}" class="form-label">
                                                Date Limite <span class="text-danger">*</span>
                                            </label>
                                            {{ form.date_fin_prevue }}
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Timeline des échéances -->
                                <div class="preview-card">
                                    <div class="preview-header">
                                        <h5 class="preview-title">Timeline des Échéances</h5>
                                        <p class="preview-subtitle">Aperçu du plan de paiement</p>
                                    </div>
                                    
                                    <div class="timeline" id="echeancesTimeline">
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                                            <p>Remplissez les informations pour voir la timeline</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 4: Validation -->
                        <div class="wizard-step-content" id="step4" style="display: none;">
                            <div class="form-section">
                                <h3 class="section-title">
                                    <i class="fas fa-check-circle"></i>
                                    Validation et Aperçu
                                </h3>
                                
                                <div class="preview-card">
                                    <div class="preview-header">
                                        <h5 class="preview-title" id="previewTitle">Aperçu du Plan</h5>
                                        <p class="preview-subtitle" id="previewSubtitle">Vérifiez les informations avant de créer le plan</p>
                                    </div>
                                    
                                    <div class="preview-stats">
                                        <div class="preview-stat">
                                            <div class="preview-stat-value" id="previewMontant">0 FCFA</div>
                                            <div class="preview-stat-label">Montant Total</div>
                                        </div>
                                        <div class="preview-stat">
                                            <div class="preview-stat-value" id="previewEcheances">0</div>
                                            <div class="preview-stat-label">Échéances</div>
                                        </div>
                                        <div class="preview-stat">
                                            <div class="preview-stat-value" id="previewDuree">0 mois</div>
                                            <div class="preview-stat-label">Durée</div>
                                        </div>
                                        <div class="preview-stat">
                                            <div class="preview-stat-value" id="previewEcheance">0 FCFA</div>
                                            <div class="preview-stat-label">Par Échéance</div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Rappel :</strong> Une fois créé, le plan sera visible dans le dashboard et pourra être géré depuis la liste des plans.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="wizard-actions">
                            <button type="button" class="btn btn-wizard-secondary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                                <i class="fas fa-arrow-left me-2"></i>Précédent
                            </button>
                            
                            <div class="d-flex gap-2">
                                <a href="{% url 'paiements:liste_plans_partiels' %}" class="btn btn-wizard-secondary">
                                    <i class="fas fa-times me-2"></i>Annuler
                                </a>
                                <button type="button" class="btn btn-wizard-primary" id="nextBtn" onclick="changeStep(1)">
                                    Suivant <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                                <button type="submit" class="btn btn-wizard-primary" id="submitBtn" style="display: none;">
                                    <i class="fas fa-save me-2"></i>Créer le Plan
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Chargement asynchrone de Flatpickr
function loadFlatpickr() {
    return new Promise((resolve, reject) => {
        if (typeof flatpickr !== 'undefined') {
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/flatpickr';
        script.async = true;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

let currentStep = 1;
const totalSteps = 4;

document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    setupValidation();
    
    // Charger Flatpickr de manière asynchrone
    loadFlatpickr().then(() => {
        initializeDatePickers();
    }).catch(() => {
        console.warn('Erreur lors du chargement de Flatpickr');
        // Fallback vers les inputs date natifs
        document.querySelectorAll('input[type="date"]').forEach(input => {
            input.style.display = 'block';
        });
    });
});

function initializeForm() {
    // Initialiser les champs
    const form = document.getElementById('planForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
        input.addEventListener('change', updateCalculations);
        input.addEventListener('input', updateCalculations);
    });
}

function initializeDatePickers() {
    // Initialiser les sélecteurs de date
    flatpickr("#id_date_debut", {
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function(selectedDates, dateStr, instance) {
            updateCalculations();
            updateDateLimits();
        }
    });
    
    flatpickr("#id_date_fin_prevue", {
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: function(selectedDates, dateStr, instance) {
            updateCalculations();
        }
    });
}

function setupValidation() {
    const form = document.getElementById('planForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (validateForm()) {
            form.submit();
        }
    });
}

function changeStep(direction) {
    if (direction === 1 && currentStep < totalSteps) {
        if (validateCurrentStep()) {
            currentStep++;
            updateWizardUI();
        }
    } else if (direction === -1 && currentStep > 1) {
        currentStep--;
        updateWizardUI();
    }
}

function updateWizardUI() {
    // Mettre à jour les étapes
    document.querySelectorAll('.wizard-step').forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber < currentStep) {
            step.classList.add('completed');
        } else if (stepNumber === currentStep) {
            step.classList.add('active');
        }
    });
    
    // Mettre à jour le contenu
    document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
        content.style.display = index + 1 === currentStep ? 'block' : 'none';
    });
    
    // Mettre à jour les boutons
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    nextBtn.style.display = currentStep < totalSteps ? 'block' : 'none';
    submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none';
    
    // Mettre à jour les calculs
    updateCalculations();
}

function validateCurrentStep() {
    const currentStepContent = document.querySelector(`#step${currentStep}`);
    const requiredFields = currentStepContent.querySelectorAll('[required]');
    
    let isValid = true;
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    return isValid;
}

function validateForm() {
    const form = document.getElementById('planForm');
    const requiredFields = form.querySelectorAll('[required]');
    
    let isValid = true;
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    return isValid;
}

function updateCalculations() {
    const montantTotal = parseFloat(document.getElementById('id_montant_total').value) || 0;
    const dateDebut = document.getElementById('id_date_debut').value;
    const dateFin = document.getElementById('id_date_fin_prevue').value;
    
    // Calculs automatiques
    document.getElementById('calcTotal').textContent = montantTotal.toLocaleString() + ' FCFA';
    
    if (dateDebut && dateFin) {
        const debut = new Date(dateDebut);
        const fin = new Date(dateFin);
        const diffTime = Math.abs(fin - debut);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const diffMonths = Math.ceil(diffDays / 30);
        
        const echeances = Math.max(1, Math.min(diffMonths, 12)); // Entre 1 et 12 échéances
        const montantEcheance = montantTotal / echeances;
        
        document.getElementById('calcEcheances').textContent = echeances;
        document.getElementById('calcEcheance').textContent = montantEcheance.toLocaleString() + ' FCFA';
        document.getElementById('calcDuree').textContent = diffMonths + ' mois';
        
        // Mettre à jour la preview
        document.getElementById('previewMontant').textContent = montantTotal.toLocaleString() + ' FCFA';
        document.getElementById('previewEcheances').textContent = echeances;
        document.getElementById('previewDuree').textContent = diffMonths + ' mois';
        document.getElementById('previewEcheance').textContent = montantEcheance.toLocaleString() + ' FCFA';
        
        // Générer la timeline
        generateTimeline(dateDebut, echeances, montantEcheance);
    }
}

function generateTimeline(dateDebut, echeances, montantEcheance) {
    const timeline = document.getElementById('echeancesTimeline');
    const debut = new Date(dateDebut);
    
    let timelineHTML = '';
    for (let i = 0; i < echeances; i++) {
        const echeanceDate = new Date(debut);
        echeanceDate.setMonth(echeanceDate.getMonth() + i);
        
        const isActive = i === 0;
        const isCompleted = false;
        
        timelineHTML += `
            <div class="timeline-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Échéance ${i + 1}</h6>
                            <small class="text-muted">${echeanceDate.toLocaleDateString('fr-FR')}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${montantEcheance.toLocaleString()} FCFA</div>
                            <small class="text-muted">${isActive ? 'Prochaine' : isCompleted ? 'Payée' : 'À venir'}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    timeline.innerHTML = timelineHTML;
}

function updateDateLimits() {
    const dateDebut = document.getElementById('id_date_debut').value;
    if (dateDebut) {
        const finPicker = flatpickr("#id_date_fin_prevue");
        finPicker.set('minDate', dateDebut);
    }
}

function applySuggestion(type) {
    const nomPlan = document.getElementById('id_nom_plan');
    const description = document.getElementById('id_description');
    const montantTotal = document.getElementById('id_montant_total');
    
    if (type === 'monthly') {
        nomPlan.value = 'Plan de paiement mensuel - ' + new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        description.value = 'Paiement échelonné sur 3-6 mois avec échéances mensuelles';
        montantTotal.value = '150000';
    } else if (type === 'quarterly') {
        nomPlan.value = 'Plan de paiement trimestriel - ' + new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        description.value = 'Paiement échelonné sur 6-12 mois avec échéances trimestrielles';
        montantTotal.value = '300000';
    }
    
    updateCalculations();
    document.getElementById('smartSuggestions').style.display = 'none';
}

// Afficher les suggestions quand un contrat est sélectionné
document.getElementById('id_contrat').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('smartSuggestions').style.display = 'block';
    } else {
        document.getElementById('smartSuggestions').style.display = 'none';
    }
});
</script>
{% endblock %}
