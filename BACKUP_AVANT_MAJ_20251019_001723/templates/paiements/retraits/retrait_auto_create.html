{% extends 'base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}Création Automatique des Retraits - KBIS IMMOBILIER{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-magic text-warning me-2"></i>
                        Création Automatique des Retraits
                    </h1>
                    <p class="text-muted mb-0">
                        Générer automatiquement les retraits pour tous les bailleurs
                    </p>
                </div>
                <div>
                    <a href="{% url 'paiements:liste_retraits_bailleur' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i> Retour à la liste
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Configuration de la création automatique -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-gear me-2"></i> Configuration
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="autoCreateForm">
                        {% csrf_token %}
                        
                        <div class="row g-3">
                            <!-- Mois de retrait -->
                            <div class="col-md-6">
                                <label for="mois_retrait" class="form-label">
                                    Mois de retrait <span class="text-danger">*</span>
                                </label>
                                <input type="month" name="mois_retrait" id="mois_retrait" 
                                       class="form-control" required>
                                <div class="form-text">Mois pour lequel générer les retraits</div>
                            </div>

                            <!-- Type de retrait -->
                            <div class="col-md-6">
                                <label for="type_retrait" class="form-label">
                                    Type de retrait <span class="text-danger">*</span>
                                </label>
                                <select name="type_retrait" id="type_retrait" class="form-select" required>
                                    <option value="mensuel">Mensuel</option>
                                    <option value="trimestriel">Trimestriel</option>
                                    <option value="semestriel">Semestriel</option>
                                    <option value="annuel">Annuel</option>
                                </select>
                            </div>

                            <!-- Mode de retrait par défaut -->
                            <div class="col-md-6">
                                <label for="mode_retrait_default" class="form-label">
                                    Mode de retrait par défaut
                                </label>
                                <select name="mode_retrait_default" id="mode_retrait_default" class="form-select">
                                    <option value="virement">Virement bancaire</option>
                                    <option value="cheque">Chèque</option>
                                    <option value="especes">Espèces</option>
                                    <option value="mobile_money">Mobile Money</option>
                                </select>
                            </div>

                            <!-- Inclure les charges déductibles -->
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" 
                                           name="inclure_charges" id="inclure_charges" checked>
                                    <label class="form-check-label" for="inclure_charges">
                                        Inclure les charges déductibles
                                    </label>
                                </div>
                                <div class="form-text">Déduire automatiquement les charges du mois</div>
                            </div>

                            <!-- Bailleurs à inclure -->
                            <div class="col-12">
                                <label class="form-label">Bailleurs à inclure</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="tous_bailleurs" id="tous_bailleurs" checked>
                                    <label class="form-check-label" for="tous_bailleurs">
                                        Tous les bailleurs avec des propriétés louées
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="seulement_actifs" id="seulement_actifs" checked>
                                    <label class="form-check-label" for="seulement_actifs">
                                        Seulement les contrats actifs
                                    </label>
                                </div>
                            </div>

                            <!-- Options avancées -->
                            <div class="col-12">
                                <div class="accordion" id="optionsAvancees">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOptions">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseOptions">
                                                <i class="bi bi-gear-wide-connected me-2"></i>
                                                Options avancées
                                            </button>
                                        </h2>
                                        <div id="collapseOptions" class="accordion-collapse collapse" 
                                             data-bs-parent="#optionsAvancees">
                                            <div class="accordion-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   name="generer_recus" id="generer_recus" checked>
                                                            <label class="form-check-label" for="generer_recus">
                                                                Générer automatiquement les reçus
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   name="notifier_bailleurs" id="notifier_bailleurs">
                                                            <label class="form-check-label" for="notifier_bailleurs">
                                                                Notifier les bailleurs
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   name="valider_automatiquement" id="valider_automatiquement">
                                                            <label class="form-check-label" for="valider_automatiquement">
                                                                Valider automatiquement
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   name="forcer_regeneration" id="forcer_regeneration">
                                                            <label class="form-check-label" for="forcer_regeneration">
                                                                Forcer la régénération
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{% url 'paiements:liste_retraits_bailleur' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-2"></i> Annuler
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-magic me-2"></i> Générer les Retraits
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Aperçu des bailleurs -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-people me-2"></i> Aperçu des Bailleurs
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Total bailleurs:</strong> 
                        <span class="badge bg-primary">{{ total_bailleurs }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Bailleurs avec propriétés louées:</strong> 
                        <span class="badge bg-success">{{ bailleurs_avec_proprietes }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Contrats actifs:</strong> 
                        <span class="badge bg-info">{{ contrats_actifs }}</span>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">Bailleurs concernés:</h6>
                    <div class="list-group list-group-flush" id="bailleursList">
                        {% for bailleur in bailleurs_concernes %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ bailleur.get_nom_complet }}</strong>
                                <br>
                                <small class="text-muted">{{ bailleur.code_bailleur }}</small>
                            </div>
                            <span class="badge bg-success">{{ bailleur.nombre_proprietes }} propriété(s)</span>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-info-circle fa-2x mb-2"></i>
                            <p class="mb-0">Aucun bailleur trouvé</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Aide -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i> Aide
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-info-circle text-info me-2"></i>
                            Cette fonction génère automatiquement les retraits pour tous les bailleurs
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-info-circle text-info me-2"></i>
                            Les montants sont calculés à partir des loyers perçus
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-info-circle text-info me-2"></i>
                            Les charges déductibles sont automatiquement soustraites
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Vérifiez les paramètres avant de lancer la génération
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation de la création automatique</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Attention !</strong> Cette action va créer des retraits pour tous les bailleurs concernés.
                </div>
                
                <h6>Résumé de l'opération :</h6>
                <ul>
                    <li><strong>Mois :</strong> <span id="moisResume"></span></li>
                    <li><strong>Type :</strong> <span id="typeResume"></span></li>
                    <li><strong>Bailleurs concernés :</strong> <span id="bailleursResume"></span></li>
                    <li><strong>Mode par défaut :</strong> <span id="modeResume"></span></li>
                </ul>
                
                <p class="text-muted">
                    Êtes-vous sûr de vouloir procéder à la création automatique des retraits ?
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="confirmGeneration">
                    <i class="bi bi-magic me-2"></i> Confirmer la génération
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('autoCreateForm');
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    
    // Définir le mois actuel par défaut
    const today = new Date();
    const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
    document.getElementById('mois_retrait').value = currentMonth;
    
    let isSubmitting = false;
    
    // Gérer la soumission du formulaire
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (isSubmitting) {
            return;
        }
        
        // Récupérer les valeurs pour l'aperçu
        const mois = document.getElementById('mois_retrait').value;
        const type = document.getElementById('type_retrait').value;
        const mode = document.getElementById('mode_retrait_default').value;
        const bailleurs = {{ bailleurs_avec_proprietes }};
        
        // Mettre à jour l'aperçu
        document.getElementById('moisResume').textContent = new Date(mois + '-01').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        document.getElementById('typeResume').textContent = type.charAt(0).toUpperCase() + type.slice(1);
        document.getElementById('bailleursResume').textContent = bailleurs + ' bailleur(s)';
        document.getElementById('modeResume').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
        
        // Afficher la modal de confirmation
        confirmationModal.show();
    });
    
    // Confirmer la génération
    document.getElementById('confirmGeneration').addEventListener('click', function() {
        if (isSubmitting) {
            return;
        }
        
        isSubmitting = true;
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Génération en cours...';
        
        // Soumettre le formulaire
        form.submit();
    });
    
    // Mettre à jour l'aperçu des bailleurs en temps réel
    const moisInput = document.getElementById('mois_retrait');
    moisInput.addEventListener('change', function() {
        // Ici vous pourriez faire un appel AJAX pour mettre à jour l'aperçu
        // en fonction du mois sélectionné
    });
});
</script>
{% endblock %}
