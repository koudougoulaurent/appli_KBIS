{% extends 'base_with_quick_actions.html' %}
{% load static %}
{% load humanize %}

{% block page_icon %}<i class="bi bi-cash-coin text-success"></i>{% endblock %}
{% block page_title %}Retraits de {{ bailleur.get_nom_complet }}{% endblock %}
{% block page_subtitle %}
    <p class="text-muted mb-0">
        <i class="bi bi-building"></i> {{ bailleur.code_bailleur }} | 
        <i class="bi bi-calendar"></i> {{ stats.total_retraits }} retrait{{ stats.total_retraits|pluralize }} au total
    </p>
{% endblock %}

{% block main_content %}
<!-- Actions rapides universelles -->
{% include 'includes/universal_quick_actions.html' %}

<!-- Statistiques des retraits -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient-success text-white">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Statistiques des Retraits
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ stats.total_retraits }}</h4>
                            <p class="text-muted mb-0">Total Retraits</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">{{ stats.montant_total_brut|floatformat:0|intcomma }} F CFA</h4>
                            <p class="text-muted mb-0">Loyers Bruts</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ stats.montant_total_charges|floatformat:0|intcomma }} F CFA</h4>
                            <p class="text-muted mb-0">Charges Déduites</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ stats.montant_total_net|floatformat:0|intcomma }} F CFA</h4>
                            <p class="text-muted mb-0">Montant Net</p>
                        </div>
                    </div>
                </div>
                
                <!-- Répartition par statut -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-center gap-4">
                            <span class="badge bg-success">{{ stats.retraits_payes }} Payés</span>
                            <span class="badge bg-primary">{{ stats.retraits_valides }} Validés</span>
                            <span class="badge bg-warning">{{ stats.retraits_en_attente }} En attente</span>
                            <span class="badge bg-danger">{{ stats.retraits_annules }} Annulés</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtres et recherche -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="mois" class="form-label">Mois</label>
                        <input type="month" class="form-control" id="mois" name="mois" value="{{ mois_search }}">
                    </div>
                    <div class="col-md-3">
                        <label for="statut" class="form-label">Statut</label>
                        <select class="form-select" id="statut" name="statut">
                            <option value="">Tous les statuts</option>
                            <option value="en_attente" {% if statut_filter == 'en_attente' %}selected{% endif %}>En attente</option>
                            <option value="valide" {% if statut_filter == 'valide' %}selected{% endif %}>Validé</option>
                            <option value="paye" {% if statut_filter == 'paye' %}selected{% endif %}>Payé</option>
                            <option value="annule" {% if statut_filter == 'annule' %}selected{% endif %}>Annulé</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="type_retrait" class="form-label">Type</label>
                        <select class="form-select" id="type_retrait" name="type_retrait">
                            <option value="">Tous les types</option>
                            <option value="mensuel" {% if type_filter == 'mensuel' %}selected{% endif %}>Mensuel</option>
                            <option value="trimestriel" {% if type_filter == 'trimestriel' %}selected{% endif %}>Trimestriel</option>
                            <option value="annuel" {% if type_filter == 'annuel' %}selected{% endif %}>Annuel</option>
                            <option value="exceptionnel" {% if type_filter == 'exceptionnel' %}selected{% endif %}>Exceptionnel</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filtrer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Liste des retraits -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i> Liste des Retraits
                    <span class="badge bg-primary ms-2">{{ page_obj.paginator.count }}</span>
                </h6>
            </div>
            <div class="card-body p-0">
                {% if page_obj %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Mois</th>
                                    <th>Type</th>
                                    <th>Loyers Bruts</th>
                                    <th>Charges Déduites</th>
                                    <th>Montant Net</th>
                                    <th>Statut</th>
                                    <th>Mode</th>
                                    <th>Date Demande</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for retrait in page_obj %}
                                <tr>
                                    <td>
                                        <strong>{{ retrait.mois_retrait|date:"F Y" }}</strong>
                                        <br>
                                        <small class="text-muted">{{ retrait.mois_retrait|date:"d/m/Y" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ retrait.get_type_retrait_display }}</span>
                                    </td>
                                    <td>
                                        <strong class="text-primary">{{ retrait.montant_loyers_bruts|floatformat:0|intcomma }} F CFA</strong>
                                    </td>
                                    <td>
                                        <span class="text-warning">{{ retrait.montant_charges_deductibles|floatformat:0|intcomma }} F CFA</span>
                                    </td>
                                    <td>
                                        <strong class="text-success">{{ retrait.montant_net_a_payer|floatformat:0|intcomma }} F CFA</strong>
                                    </td>
                                    <td>
                                        {% if retrait.statut == 'paye' %}
                                            <span class="badge bg-success">{{ retrait.get_statut_display }}</span>
                                        {% elif retrait.statut == 'valide' %}
                                            <span class="badge bg-primary">{{ retrait.get_statut_display }}</span>
                                        {% elif retrait.statut == 'en_attente' %}
                                            <span class="badge bg-warning">{{ retrait.get_statut_display }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ retrait.get_statut_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <i class="bi bi-{% if retrait.mode_retrait == 'virement' %}credit-card{% elif retrait.mode_retrait == 'cheque' %}receipt{% else %}cash{% endif %}"></i>
                                        {{ retrait.get_mode_retrait_display }}
                                    </td>
                                    <td>
                                        {{ retrait.date_demande|date:"d/m/Y" }}
                                        {% if retrait.date_versement %}
                                            <br>
                                            <small class="text-success">Versé le {{ retrait.date_versement|date:"d/m/Y" }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'paiements:detail_retrait_bailleur' retrait.pk %}" 
                                               class="btn btn-outline-primary" 
                                               title="Voir détails">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if retrait.statut == 'en_attente' %}
                                                <a href="{% url 'paiements:valider_retrait' retrait.pk %}" 
                                                   class="btn btn-outline-success" 
                                                   title="Valider">
                                                    <i class="bi bi-check-circle"></i>
                                                </a>
                                            {% endif %}
                                            {% if retrait.statut == 'valide' %}
                                                <a href="{% url 'paiements:marquer_paye_retrait' retrait.pk %}" 
                                                   class="btn btn-outline-success" 
                                                   title="Marquer comme payé">
                                                    <i class="bi bi-cash-coin"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <div class="card-footer">
                        <nav aria-label="Pagination des retraits">
                            <ul class="pagination pagination-sm justify-content-center mb-0">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% if mois_search %}&mois={{ mois_search }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if type_filter %}&type_retrait={{ type_filter }}{% endif %}">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if mois_search %}&mois={{ mois_search }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if type_filter %}&type_retrait={{ type_filter }}{% endif %}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                <li class="page-item active">
                                    <span class="page-link">
                                        Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>
                                
                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if mois_search %}&mois={{ mois_search }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if type_filter %}&type_retrait={{ type_filter }}{% endif %}">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if mois_search %}&mois={{ mois_search }}{% endif %}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}{% if type_filter %}&type_retrait={{ type_filter }}{% endif %}">
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h5 class="mt-3">Aucun retrait trouvé</h5>
                        <p class="text-muted">Ce bailleur n'a pas encore de retraits enregistrés.</p>
                        <a href="{% url 'paiements:ajouter_retrait_bailleur' bailleur.pk %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Créer le premier retrait
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Graphique des retraits par mois -->
{% if retraits_par_mois %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Évolution des Retraits (12 derniers mois)
                </h6>
            </div>
            <div class="card-body">
                <canvas id="retraitsChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Message d'information pour les futurs retraits -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Aucun Retrait Enregistré
                </h6>
            </div>
            <div class="card-body">
                <div class="text-center py-4">
                    <i class="bi bi-cash-coin display-1 text-muted"></i>
                    <h5 class="mt-3">Aucun retrait n'a encore été enregistré</h5>
                    <p class="text-muted mb-4">
                        Les retraits de {{ bailleur.get_nom_complet }} apparaîtront ici une fois qu'ils auront été créés.
                    </p>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="bi bi-plus-circle text-primary fs-1"></i>
                                <h6 class="mt-2">Créer un Retrait</h6>
                                <p class="text-muted small">Ajouter manuellement un retrait pour ce bailleur</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="bi bi-graph-up text-success fs-1"></i>
                                <h6 class="mt-2">Suivi Automatique</h6>
                                <p class="text-muted small">Les retraits seront suivis automatiquement</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="bi bi-file-earmark-text text-info fs-1"></i>
                                <h6 class="mt-2">Rapports</h6>
                                <p class="text-muted small">Génération automatique de rapports</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graphique des retraits par mois
    {% if retraits_par_mois %}
    const ctx = document.getElementById('retraitsChart').getContext('2d');
    const retraitsData = {{ retraits_par_mois|safe }};
    
    // Convertir les données pour le graphique
    const chartData = retraitsData.map(item => ({
        label: new Date(item.mois_annee, item.mois_mois - 1).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }),
        value: parseFloat(item.total_net || 0)
    }));
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(item => item.label),
            datasets: [{
                label: 'Montant Net (F CFA)',
                data: chartData.map(item => item.value),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return Math.round(value).toLocaleString('fr-FR', {maximumFractionDigits: 0}) + ' F CFA';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Montant Net: ' + Math.round(context.parsed.y).toLocaleString('fr-FR', {maximumFractionDigits: 0}) + ' F CFA';
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
