{% extends 'base.html' %}

{% block title %}Suppression Définitive - {{ locataire.nom }} {{ locataire.prenom }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- En-tête d'alerte -->
            <div class="card border-danger mb-4">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> 
                        ⚠️ SUPPRESSION DÉFINITIVE ⚠️
                    </h4>
                </div>
                <div class="card-body">
                    <h5 class="text-danger mb-3">
                        <strong>{{ locataire.get_nom_complet }}</strong>
                    </h5>
                    <p class="mb-0 text-danger">
                        <strong>ATTENTION :</strong> Cette action supprimera définitivement le locataire de la base de données. 
                        Cette action est IRRÉVERSIBLE et ne peut pas être annulée.
                    </p>
                </div>
            </div>

            <!-- Vérification des contrats actifs -->
            <div class="card border-warning mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-shield-exclamation"></i> Vérification de Sécurité</h5>
                </div>
                <div class="card-body">
                    {% if a_des_contrats_actifs %}
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">
                                <i class="bi bi-x-circle"></i> Suppression Impossible
                            </h6>
                            <p class="mb-2">
                                <strong>Ce locataire a des contrats actifs et ne peut pas être supprimé définitivement.</strong>
                            </p>
                            <p class="mb-0">
                                Vous devez d'abord résilier ou transférer tous les contrats actifs avant de pouvoir 
                                supprimer définitivement ce locataire.
                            </p>
                        </div>
                        
                        <h6>Contrats actifs :</h6>
                        <ul class="list-group mb-3">
                            {% for contrat in contrats_actifs %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ contrat.numero_contrat }}</strong> - {{ contrat.propriete.titre }}
                                        <br>
                                        <small class="text-muted">
                                            Du {{ contrat.date_debut|date:"d/m/Y" }} 
                                            au {{ contrat.date_fin|date:"d/m/Y" }}
                                        </small>
                                    </div>
                                    <span class="badge bg-danger">Actif</span>
                                </li>
                            {% endfor %}
                        </ul>
                        
                        <div class="text-center">
                            <a href="{% url 'proprietes:locataires_liste' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Retour à la Liste
                            </a>
                            <a href="{% url 'proprietes:detail_locataire' locataire.pk %}" class="btn btn-outline-primary">
                                <i class="bi bi-eye"></i> Voir le Détail
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <h6 class="alert-heading">
                                <i class="bi bi-check-circle"></i> Vérification Réussie
                            </h6>
                            <p class="mb-0">
                                Ce locataire n'a aucun contrat actif et peut être supprimé définitivement.
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Formulaire de suppression définitive (seulement si pas de contrats actifs) -->
            {% if peut_etre_supprime_definitivement %}
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-trash"></i> Confirmation de Suppression Définitive</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="deleteForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="permanent_delete">
                        
                        <!-- Informations du locataire -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Informations du Locataire</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Nom :</strong> {{ locataire.nom }}</li>
                                    <li><strong>Prénom :</strong> {{ locataire.prenom }}</li>
                                    <li><strong>Email :</strong> {{ locataire.email|default:"Non renseigné" }}</li>
                                    <li><strong>Téléphone :</strong> {{ locataire.telephone }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Statistiques</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Date de création :</strong> {{ locataire.date_creation|date:"d/m/Y H:i" }}</li>
                                    <li><strong>Statut :</strong> 
                                        <span class="badge bg-{% if locataire.statut == 'actif' %}success{% else %}secondary{% endif %}">
                                            {{ locataire.get_statut_display }}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Confirmations multiples -->
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">
                                <i class="bi bi-shield-check"></i> Confirmations de Sécurité Requises
                            </h6>
                            <p class="mb-3">
                                Pour effectuer une suppression définitive, vous devez confirmer les trois points suivants :
                            </p>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="confirmation_1" id="confirmation_1" required>
                                <label class="form-check-label" for="confirmation_1">
                                    <strong>1.</strong> Je confirme que ce locataire n'a aucun contrat actif et peut être supprimé en toute sécurité.
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="confirmation_2" id="confirmation_2" required>
                                <label class="form-check-label" for="confirmation_2">
                                    <strong>2.</strong> Je comprends que cette action est IRRÉVERSIBLE et que toutes les données du locataire seront définitivement perdues.
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="confirmation_3" id="confirmation_3" required>
                                <label class="form-check-label" for="confirmation_3">
                                    <strong>3.</strong> J'ai vérifié que ce locataire n'est associé à aucun paiement en attente ou autre référence importante.
                                </label>
                            </div>
                        </div>

                        <!-- Mot de passe de confirmation -->
                        <div class="mb-4">
                            <label for="password_confirmation" class="form-label">
                                <i class="bi bi-key"></i> Mot de passe de confirmation
                            </label>
                            <input type="password" class="form-control" name="password_confirmation" id="password_confirmation" 
                                   placeholder="Entrez votre mot de passe pour confirmer" required>
                            <div class="form-text">
                                Vous devez entrer votre mot de passe actuel pour confirmer cette action.
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'proprietes:locataires_liste' %}" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left"></i> Annuler
                            </a>
                            <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled
                                    onclick="return confirm('Êtes-vous sûr de vouloir supprimer définitivement ce locataire ? Cette action est irréversible !')">
                                <i class="bi bi-trash"></i> Supprimer Définitivement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const confirmations = document.querySelectorAll('input[name^="confirmation_"]');
    const passwordField = document.getElementById('password_confirmation');
    
    function checkAllConfirmations() {
        const allChecked = Array.from(confirmations).every(cb => cb.checked);
        const passwordFilled = passwordField.value.trim() !== '';
        
        if (confirmDeleteBtn) {
            confirmDeleteBtn.disabled = !(allChecked && passwordFilled);
        }
    }
    
    // Vérifier les confirmations
    confirmations.forEach(cb => {
        cb.addEventListener('change', checkAllConfirmations);
    });
    
    // Vérifier le mot de passe
    passwordField.addEventListener('input', checkAllConfirmations);
    
    // Confirmation finale avant soumission
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            console.log('Bouton de suppression cliqué');
            
            const confirmMessage = `⚠️ ATTENTION ⚠️\n\n` +
                `Vous êtes sur le point de supprimer DÉFINITIVEMENT le locataire :\n` +
                `"{{ locataire.get_nom_complet }}"\n\n` +
                `Cette action est IRRÉVERSIBLE et supprimera toutes les données de ce locataire.\n\n` +
                `Êtes-vous ABSOLUMENT SÛR de vouloir continuer ?`;
            
            if (confirm(confirmMessage)) {
                console.log('Première confirmation acceptée');
                // Afficher une deuxième confirmation
                const secondConfirm = confirm(`Dernière chance !\n\n` +
                    `Vous confirmez la suppression définitive de "{{ locataire.get_nom_complet }}" ?\n\n` +
                    `Cette action ne peut PAS être annulée !`);
                
                if (secondConfirm) {
                    console.log('Deuxième confirmation acceptée, soumission du formulaire');
                    const form = document.getElementById('deleteForm');
                    if (form) {
                        form.submit();
                    } else {
                        console.error('Formulaire non trouvé !');
                        alert('Erreur : Formulaire non trouvé');
                    }
                } else {
                    console.log('Deuxième confirmation annulée');
                }
            } else {
                console.log('Première confirmation annulée');
            }
        });
    } else {
        console.error('Bouton de suppression non trouvé !');
    }
});
</script>
{% endblock %}
