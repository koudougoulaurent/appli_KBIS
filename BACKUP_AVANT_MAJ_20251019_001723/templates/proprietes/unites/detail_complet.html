{% extends 'base.html' %}
{% load static %}
{% load core_extras %}

{% block title %}{{ page_title }} - Détail complet{% endblock %}

{% block extra_css %}
<style>
    .unit-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        border-radius: 20px;
        color: white;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .unit-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        transform: translate(50%, -50%);
    }
    
    .status-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
    }
    
    .status-disponible { background: #27ae60; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); }
    .status-occupee { background: #e74c3c; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
    .status-reservee { background: #f39c12; color: #000; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3); }
    .status-en_renovation { background: #9b59b6; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); }
    .status-hors_service { background: #7f8c8d; box-shadow: 0 4px 15px rgba(127, 140, 141, 0.3); }
    
    .info-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .info-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .info-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
        padding: 1.5rem;
    }
    
    .info-card .card-header h5 {
        margin: 0;
        color: #495057;
        font-weight: 600;
    }
    
    .info-card .card-body {
        padding: 2rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .stat-item:hover {
        transform: scale(1.05);
    }
    
    .stat-item h4 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-item p {
        margin: 0;
        font-weight: 500;
        opacity: 0.8;
    }
    
    .stat-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
    .stat-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }
    .stat-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; }
    .stat-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; }
    .stat-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
    
    .feature-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        background: #f8f9fa;
        transition: background-color 0.2s ease;
    }
    
    .feature-item:hover {
        background: #e9ecef;
    }
    
    .feature-item.active {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    
    .feature-item.inactive {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
    }
    
    .feature-icon {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 0.9rem;
    }
    
    .feature-icon.active { background: #28a745; color: white; }
    .feature-icon.inactive { background: #dc3545; color: white; }
    .feature-icon.neutral { background: #6c757d; color: white; }
    
    .piece-item {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .piece-item:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,123,255,0.1);
    }
    
    .piece-disponible { border-left: 4px solid #28a745; }
    .piece-occupee { border-left: 4px solid #dc3545; }
    .piece-en_renovation { border-left: 4px solid #6f42c1; }
    .piece-hors_service { border-left: 4px solid #6c757d; }
    
    .contrat-timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .contrat-timeline::before {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #007bff, #6c757d);
    }
    
    .contrat-item {
        position: relative;
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .contrat-item::before {
        content: '';
        position: absolute;
        left: -2.25rem;
        top: 1.5rem;
        width: 12px;
        height: 12px;
        background: #007bff;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .contrat-actuel {
        border-left-color: #28a745;
    }
    
    .contrat-actuel::before {
        background: #28a745;
    }
    
    .alert-custom {
        border: none;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .paiement-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #28a745;
        transition: all 0.2s ease;
    }
    
    .paiement-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    
    .echeance-item {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #ffc107;
    }
    
    .landlord-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .landlord-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 2rem;
        font-weight: bold;
    }
    
    .property-link {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border-radius: 15px;
        padding: 1.5rem;
        text-decoration: none;
        color: inherit;
        display: block;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    .property-link:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        color: inherit;
        text-decoration: none;
    }
    
    .btn-action {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    @media (max-width: 768px) {
        .unit-header {
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
        }
        
        .unit-header .fs-2 {
            font-size: 1.5rem !important;
        }
        
        .info-card .card-body {
            padding: 1.5rem;
        }
        
        .stat-item {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-item h4 {
            font-size: 1.2rem;
        }
        
        .contrat-timeline {
            padding-left: 1.5rem;
        }
        
        .btn-action {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .alert-custom {
            padding: 1rem;
            font-size: 0.9rem;
        }
        
        .landlord-avatar {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 576px) {
        .unit-header {
            padding: 1rem;
            text-align: center;
        }
        
        .status-badge {
            position: static;
            margin-bottom: 1rem;
        }
        
        .stat-item h4 {
            font-size: 1rem;
        }
        
        .feature-item {
            flex-direction: column;
            text-align: center;
            padding: 1rem;
        }
        
        .feature-icon {
            margin-right: 0;
            margin-bottom: 0.5rem;
        }
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Styles d'impression pour production */
    @media print {
        .btn, .btn-action, .alert-custom {
            display: none !important;
        }
        
        .unit-header {
            background: #2c3e50 !important;
            color: white !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .info-card {
            break-inside: avoid;
            margin-bottom: 1rem;
            box-shadow: none;
            border: 1px solid #dee2e6;
        }
        
        .stat-item {
            break-inside: avoid;
            border: 1px solid #dee2e6;
            margin-bottom: 0.5rem;
        }
        
        .contrat-timeline::before {
            background: #007bff !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        body {
            font-size: 12px;
        }
        
        h1, h2, h3, h4, h5 {
            color: #000 !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête de l'unité -->
    <div class="unit-header">
        <div class="status-badge">
            <span class="badge badge-lg status-{{ unite.statut }}">
                <i class="bi bi-circle-fill me-1"></i>
                {{ unite.get_statut_display }}
            </span>
        </div>
        
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-{{ page_icon }} fs-1 me-3"></i>
                    <div>
                        <h1 class="mb-0">{{ unite.numero_unite }}</h1>
                        <h4 class="mb-0 opacity-75">{{ unite.nom }}</h4>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-house-door me-2"></i>
                            <span>{{ unite.get_type_unite_display }}</span>
                        </div>
                        {% if unite.etage is not None %}
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-layers me-2"></i>
                            <span>Étage {{ unite.etage }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-door-closed me-2"></i>
                            <span>{{ unite.nombre_pieces }} pièce{{ unite.nombre_pieces|pluralize }}</span>
                        </div>
                        {% if unite.surface %}
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-rulers me-2"></i>
                            <span>{{ unite.surface }} m²</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 text-end">
                <div class="mb-3">
                    <div class="fs-2 fw-bold">{{ unite.loyer_mensuel|currency_format }}</div>
                    <div class="opacity-75">Loyer mensuel</div>
                    {% if unite.charges_mensuelles > 0 %}
                    <div class="fs-6">+ {{ unite.charges_mensuelles|currency_format }} charges</div>
                    {% endif %}
                </div>
                
                <!-- Actions rapides -->
                <div class="d-flex flex-wrap justify-content-end">
                    <button onclick="window.print()" class="btn btn-outline-light btn-action">
                        <i class="bi bi-printer me-1"></i>Imprimer
                    </button>
                    <button onclick="exportToPDF()" class="btn btn-outline-light btn-action">
                        <i class="bi bi-file-pdf me-1"></i>PDF
                    </button>
                    <a href="{% url 'proprietes:unite_edit' unite.pk %}" class="btn btn-outline-light btn-action">
                        <i class="bi bi-pencil me-1"></i>Modifier
                    </a>
                    {% if unite.statut == 'disponible' %}
                    <a href="{% url 'proprietes:reservation_create' unite.pk %}" class="btn btn-light btn-action">
                        <i class="bi bi-calendar-plus me-1"></i>Réserver
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes et notifications intelligentes -->
    <div class="row mb-4">
        <div class="col-12">
            <!-- Alertes système -->
            {% if alertes %}
                {% for alerte in alertes %}
                <div class="alert alert-{{ alerte.type }} alert-custom d-flex align-items-center">
                    <i class="bi bi-{% if alerte.type == 'danger' %}exclamation-triangle{% elif alerte.type == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-3 fs-5"></i>
                    <span>{{ alerte.message }}</span>
                </div>
                {% endfor %}
            {% endif %}
            
            <!-- Alertes intelligentes basées sur les données -->
            {% if unite.statut == 'disponible' and not contrat_actuel %}
            <div class="alert alert-info alert-custom d-flex align-items-center">
                <i class="bi bi-lightbulb me-3 fs-5"></i>
                <div>
                    <strong>Unité disponible</strong> - Cette unité est prête à être louée. 
                    <a href="{% url 'proprietes:reservation_create' unite.pk %}" class="alert-link">Créer une réservation</a>
                </div>
            </div>
            {% endif %}
            
            {% if stats_unite.taux_occupation < 50 %}
            <div class="alert alert-warning alert-custom d-flex align-items-center">
                <i class="bi bi-graph-down me-3 fs-5"></i>
                <div>
                    <strong>Taux d'occupation faible</strong> - Le taux d'occupation de cette unité est de {{ stats_unite.taux_occupation|floatformat:1 }}%. 
                    Considérez réviser le loyer ou améliorer la promotion.
                </div>
            </div>
            {% endif %}
            
            {% if unite.caution_demandee and unite.caution_demandee > unite.loyer_mensuel|floatformat:0|add:500 %}
            <div class="alert alert-info alert-custom d-flex align-items-center">
                <i class="bi bi-shield-check me-3 fs-5"></i>
                <div>
                    <strong>Caution élevée</strong> - La caution demandée ({{ unite.caution_demandee|currency_format }}) 
                    est supérieure au loyer mensuel, ce qui peut décourager certains locataires.
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Colonne principale -->
        <div class="col-lg-8">
            <!-- Statistiques financières -->
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-currency-exchange me-2"></i>Performance financière</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="stat-item stat-primary">
                                        <h4>{{ stats_unite.revenus_annuels_potentiels|currency_format }}</h4>
                                        <p>Revenus annuels potentiels</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stat-item stat-success">
                                        <h4>{{ stats_unite.taux_occupation|floatformat:1 }}%</h4>
                                        <p>Taux d'occupation</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="stat-item stat-info">
                                        <h4>{{ stats_unite.nombre_contrats_total }}</h4>
                                        <p>Contrat{{ stats_unite.nombre_contrats_total|pluralize }}</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stat-item stat-warning">
                                        <h4>{{ stats_unite.duree_moyenne_occupation|floatformat:1 }} mois</h4>
                                        <p>Durée moyenne occupation</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Détails financiers -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded bg-light">
                                <i class="bi bi-house-door fs-3 text-primary mb-2"></i>
                                <div><strong>{{ unite.get_loyer_total|currency_format }}</strong></div>
                                <div class="text-muted">Loyer total mensuel</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded bg-light">
                                <i class="bi bi-graph-up fs-3 text-success mb-2"></i>
                                <div><strong>{{ unite.get_revenus_potentiels_annuels|currency_format }}</strong></div>
                                <div class="text-muted">Revenus annuels</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 border rounded bg-light">
                                <i class="bi bi-percent fs-3 text-info mb-2"></i>
                                <div><strong>{{ unite.get_taux_occupation|floatformat:1 }}%</strong></div>
                                <div class="text-muted">Taux occupation actuel</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Équipements et caractéristiques -->
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-gear me-2"></i>Équipements et caractéristiques</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="feature-item {% if unite.meuble %}active{% else %}inactive{% endif %}">
                                <div class="feature-icon {% if unite.meuble %}active{% else %}inactive{% endif %}">
                                    <i class="bi bi-house-gear"></i>
                                </div>
                                <div>
                                    <strong>Meublé</strong>
                                    <div class="text-muted">{% if unite.meuble %}Oui{% else %}Non{% endif %}</div>
                                </div>
                            </div>
                            
                            <div class="feature-item {% if unite.balcon %}active{% else %}inactive{% endif %}">
                                <div class="feature-icon {% if unite.balcon %}active{% else %}inactive{% endif %}">
                                    <i class="bi bi-tree"></i>
                                </div>
                                <div>
                                    <strong>Balcon/Terrasse</strong>
                                    <div class="text-muted">{% if unite.balcon %}Oui{% else %}Non{% endif %}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="feature-item {% if unite.parking_inclus %}active{% else %}inactive{% endif %}">
                                <div class="feature-icon {% if unite.parking_inclus %}active{% else %}inactive{% endif %}">
                                    <i class="bi bi-car-front"></i>
                                </div>
                                <div>
                                    <strong>Parking inclus</strong>
                                    <div class="text-muted">{% if unite.parking_inclus %}Oui{% else %}Non{% endif %}</div>
                                </div>
                            </div>
                            
                            <div class="feature-item {% if unite.climatisation %}active{% else %}inactive{% endif %}">
                                <div class="feature-icon {% if unite.climatisation %}active{% else %}inactive{% endif %}">
                                    <i class="bi bi-thermometer"></i>
                                </div>
                                <div>
                                    <strong>Climatisation</strong>
                                    <div class="text-muted">{% if unite.climatisation %}Oui{% else %}Non{% endif %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Autres caractéristiques -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="bi bi-door-closed fs-3 text-primary mb-2"></i>
                                <div><strong>{{ unite.nombre_chambres }}</strong></div>
                                <div class="text-muted">Chambre{{ unite.nombre_chambres|pluralize }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="bi bi-droplet fs-3 text-info mb-2"></i>
                                <div><strong>{{ unite.nombre_salles_bain }}</strong></div>
                                <div class="text-muted">Salle{{ unite.nombre_salles_bain|pluralize }} de bain</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="bi bi-shield-check fs-3 text-success mb-2"></i>
                                <div><strong>{{ unite.caution_demandee|currency_format }}</strong></div>
                                <div class="text-muted">Caution</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pièces de l'unité -->
            {% if pieces_unite %}
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-door-open me-2"></i>Pièces de l'unité ({{ pieces_unite.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for piece in pieces_unite %}
                        <div class="col-md-6">
                            <div class="piece-item piece-{{ piece.statut }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi bi-door-open me-2"></i>
                                            {{ piece.nom }}
                                        </h6>
                                        <div class="text-muted">{{ piece.get_type_piece_display }}</div>
                                        {% if piece.surface %}
                                        <div class="text-muted">{{ piece.surface }} m²</div>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-{% if piece.statut == 'disponible' %}success{% elif piece.statut == 'occupee' %}danger{% elif piece.statut == 'en_renovation' %}warning{% else %}secondary{% endif %}">
                                            {{ piece.get_statut_display }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Historique des contrats -->
            {% if contrats %}
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-file-text me-2"></i>Historique des contrats ({{ contrats.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="contrat-timeline">
                        {% for contrat in contrats %}
                        <div class="contrat-item {% if contrat == contrat_actuel %}contrat-actuel{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">
                                        {% if contrat == contrat_actuel %}
                                        <i class="bi bi-circle-fill text-success me-2"></i>
                                        {% endif %}
                                        {{ contrat.locataire.nom }} {{ contrat.locataire.prenom }}
                                        {% if contrat == contrat_actuel %}
                                        <span class="badge bg-success ms-2">Actuel</span>
                                        {% endif %}
                                    </h6>
                                    <div class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        {{ contrat.date_debut|date:"d/m/Y" }} - 
                                        {% if contrat.date_fin %}
                                            {{ contrat.date_fin|date:"d/m/Y" }}
                                        {% else %}
                                            En cours
                                        {% endif %}
                                    </div>
                                    <div class="text-muted">
                                        <i class="bi bi-cash me-1"></i>
                                        {{ contrat.loyer_mensuel|currency_format }}/mois
                                    </div>
                                </div>
                                <div class="text-end">
                                    <a href="#" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye me-1"></i>Voir
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Historique des paiements récents -->
            {% if historique_paiements %}
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-credit-card me-2"></i>Paiements récents</h5>
                </div>
                <div class="card-body">
                    {% for paiement in historique_paiements %}
                    <div class="paiement-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ paiement.montant|currency_format }}</strong>
                                <div class="text-muted">{{ paiement.date_paiement|date:"d/m/Y" }}</div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{% if paiement.statut == 'valide' %}success{% elif paiement.statut == 'en_attente' %}warning{% else %}danger{% endif %}">
                                    {{ paiement.get_statut_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if contrat_actuel %}
                    <div class="text-center mt-3">
                        <a href="#" class="btn btn-outline-primary">
                            <i class="bi bi-list me-1"></i>Voir tous les paiements
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Colonne secondaire -->
        <div class="col-lg-4">
            <!-- Bailleur -->
            <div class="info-card">
                <div class="card-body">
                    <div class="landlord-card">
                        <div class="landlord-avatar">
                            {{ bailleur_effectif.nom.0 }}{{ bailleur_effectif.prenom.0 }}
                        </div>
                        <h5>{{ bailleur_effectif.nom }} {{ bailleur_effectif.prenom }}</h5>
                        <p class="text-muted mb-3">
                            {% if unite.bailleur %}
                                Bailleur spécifique
                            {% else %}
                                Bailleur de la propriété
                            {% endif %}
                        </p>
                        
                        {% if bailleur_effectif.telephone %}
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="bi bi-telephone me-2"></i>
                            <a href="tel:{{ bailleur_effectif.telephone }}">{{ bailleur_effectif.telephone }}</a>
                        </div>
                        {% endif %}
                        
                        {% if bailleur_effectif.email %}
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="bi bi-envelope me-2"></i>
                            <a href="mailto:{{ bailleur_effectif.email }}">{{ bailleur_effectif.email }}</a>
                        </div>
                        {% endif %}
                        
                        <a href="{% url 'proprietes:detail_bailleur' bailleur_effectif.pk %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-person me-1"></i>Voir le profil
                        </a>
                    </div>
                </div>
            </div>

            <!-- Propriété parente -->
            <div class="info-card">
                <div class="card-body p-0">
                    <a href="{% url 'proprietes:detail' unite.propriete.pk %}" class="property-link">
                        <div class="text-center">
                            <i class="bi bi-building fs-1 text-primary mb-3"></i>
                            <h5>{{ unite.propriete.titre }}</h5>
                            {% if unite.propriete.adresse %}
                            <p class="text-muted mb-2">{{ unite.propriete.adresse }}</p>
                            {% endif %}
                            {% if unite.propriete.ville %}
                            <p class="text-muted mb-3">{{ unite.propriete.ville }}</p>
                            {% endif %}
                            
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fs-5 fw-bold text-primary">{{ propriete_stats.total_unites }}</div>
                                    <div class="text-muted">Unités</div>
                                </div>
                                <div class="col-6">
                                    <div class="fs-5 fw-bold text-success">{{ propriete_stats.taux_occupation_propriete|floatformat:1 }}%</div>
                                    <div class="text-muted">Occupation</div>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Réservations actives -->
            {% if reservations_actives %}
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-calendar-check me-2"></i>Réservations actives</h5>
                </div>
                <div class="card-body">
                    {% for reservation in reservations_actives %}
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>{{ reservation.locataire_potentiel.nom }} {{ reservation.locataire_potentiel.prenom }}</h6>
                                <div class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>
                                    {{ reservation.date_reservation|date:"d/m/Y" }}
                                </div>
                                {% if reservation.date_expiration %}
                                <div class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    Expire le {{ reservation.date_expiration|date:"d/m/Y" }}
                                </div>
                                {% endif %}
                            </div>
                            <span class="badge bg-{% if reservation.statut == 'confirmee' %}success{% else %}warning{% endif %}">
                                {{ reservation.get_statut_display }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Prochaines échéances -->
            {% if prochaines_echeances %}
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-calendar-event me-2"></i>Prochaines échéances</h5>
                </div>
                <div class="card-body">
                    {% for echeance in prochaines_echeances %}
                    <div class="echeance-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ echeance.type }}</strong>
                                <div class="text-muted">{{ echeance.date|date:"d/m/Y" }}</div>
                            </div>
                            <div class="text-end">
                                <strong>{{ echeance.montant|currency_format }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Locataire actuel -->
            {% if locataire_actuel %}
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-person me-2"></i>Locataire actuel</h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="landlord-avatar mx-auto" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            {{ locataire_actuel.nom.0 }}{{ locataire_actuel.prenom.0 }}
                        </div>
                    </div>
                    <h5>{{ locataire_actuel.nom }} {{ locataire_actuel.prenom }}</h5>
                    
                    {% if locataire_actuel.telephone %}
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="bi bi-telephone me-2"></i>
                        <a href="tel:{{ locataire_actuel.telephone }}">{{ locataire_actuel.telephone }}</a>
                    </div>
                    {% endif %}
                    
                    {% if locataire_actuel.email %}
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <i class="bi bi-envelope me-2"></i>
                        <a href="mailto:{{ locataire_actuel.email }}">{{ locataire_actuel.email }}</a>
                    </div>
                    {% endif %}
                    
                    <a href="{% url 'proprietes:detail_locataire' locataire_actuel.pk %}" class="btn btn-success btn-sm">
                        <i class="bi bi-person me-1"></i>Voir le profil
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Actions rapides -->
            <div class="info-card">
                <div class="card-header">
                    <h5><i class="bi bi-lightning me-2"></i>Actions rapides</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'proprietes:unite_edit' unite.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil me-2"></i>Modifier l'unité
                        </a>
                        
                        {% if unite.statut == 'disponible' %}
                        <a href="{% url 'proprietes:reservation_create' unite.pk %}" class="btn btn-outline-success">
                            <i class="bi bi-calendar-plus me-2"></i>Créer une réservation
                        </a>
                        {% endif %}
                        
                        {% if contrat_actuel %}
                        <a href="#" class="btn btn-outline-info">
                            <i class="bi bi-file-earmark-plus me-2"></i>Nouveau paiement
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'proprietes:recherche_unites' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-search me-2"></i>Retour à la recherche
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des cartes au chargement
    const cards = document.querySelectorAll('.info-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Gestion des tooltips pour les statuts
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Animation des statistiques (compteur animé)
    const statNumbers = document.querySelectorAll('.stat-item h4');
    statNumbers.forEach(stat => {
        const finalValue = parseInt(stat.textContent.replace(/[^\d]/g, ''));
        if (!isNaN(finalValue) && finalValue > 0) {
            let currentValue = 0;
            const increment = finalValue / 50;
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= finalValue) {
                    currentValue = finalValue;
                    clearInterval(timer);
                }
                const suffix = stat.textContent.includes('F CFA') ? ' F CFA' : 
                              stat.textContent.includes('%') ? '%' : 
                              stat.textContent.includes('mois') ? ' mois' : '';
                stat.textContent = Math.floor(currentValue).toLocaleString('fr-FR') + suffix;
            }, 20);
        }
    });

    // Confirmation pour les actions importantes
    document.querySelectorAll('[data-confirm]').forEach(element => {
        element.addEventListener('click', function(e) {
            const message = this.dataset.confirm;
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });

    // Gestion du loading state pour les boutons
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.type === 'submit' || this.href) {
                const originalContent = this.innerHTML;
                this.innerHTML = '<span class="loading-spinner me-2"></span>Chargement...';
                this.disabled = true;
                
                // Restaurer après 3 secondes si pas de redirection
                setTimeout(() => {
                    this.innerHTML = originalContent;
                    this.disabled = false;
                }, 3000);
            }
        });
    });

    // Fonction d'export PDF
    window.exportToPDF = function() {
        // Masquer temporairement les éléments non nécessaires
        const elementsToHide = document.querySelectorAll('.btn, .alert-custom');
        elementsToHide.forEach(el => el.style.display = 'none');
        
        // Créer le titre du document
        const originalTitle = document.title;
        document.title = `Unite_{{ unite.numero_unite|escapejs }}_{{ unite.nom|escapejs }}_Detail_Complet`;
        
        // Lancer l'impression (qui peut être configurée pour sauvegarder en PDF)
        window.print();
        
        // Restaurer les éléments et le titre
        setTimeout(() => {
            elementsToHide.forEach(el => el.style.display = '');
            document.title = originalTitle;
        }, 1000);
    };
    
    // Fonction de formatage des devises pour JavaScript
    window.formatCurrency = function(amount) {
        if (amount === null || amount === undefined) return '0 F CFA';
        return new Intl.NumberFormat('fr-FR').format(amount) + ' F CFA';
    };
    
    // Mise à jour automatique des données (toutes les 5 minutes) - Optimisé pour production
    let updateInterval;
    function startAutoUpdate() {
        updateInterval = setInterval(() => {
            // Vérifier s'il y a des nouvelles notifications ou changements de statut
            fetch(`{% url 'proprietes:api_statistiques_propriete' unite.propriete.pk %}`)
                .then(response => response.json())
                .then(data => {
                    // Mettre à jour les statistiques si nécessaire
                    updateStatistics(data);
                })
                .catch(error => {
                    console.error('Erreur lors de la mise à jour:', error);
                    // Arrêter les mises à jour en cas d'erreur répétée
                    if (error.status === 404 || error.status === 403) {
                        clearInterval(updateInterval);
                    }
                });
        }, 300000); // 5 minutes
    }
    
    function updateStatistics(data) {
        // Mise à jour des statistiques en temps réel
        if (data.taux_occupation !== undefined) {
            const tauxElement = document.querySelector('[data-stat="taux-occupation"]');
            if (tauxElement) {
                tauxElement.textContent = data.taux_occupation.toFixed(1) + '%';
            }
        }
        
        // Afficher une notification de mise à jour
        showNotification('Données mises à jour', 'success');
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        // Supprimer automatiquement après 3 secondes
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
    
    // Démarrer les mises à jour automatiques
    startAutoUpdate();
    
    // Arrêter les mises à jour quand l'utilisateur quitte la page
    window.addEventListener('beforeunload', () => {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
});
</script>
{% endblock %}
