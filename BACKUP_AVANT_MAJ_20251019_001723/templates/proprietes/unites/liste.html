{% extends "base.html" %}
{% load static %}
{% load core_extras %}

{% block title %}Gestion des Unités Locatives{% endblock %}

{% block extra_css %}
<style>
.unite-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.unite-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.statut-badge {
    font-size: 0.8em;
    padding: 4px 8px;
    border-radius: 12px;
}

.statut-disponible { background-color: #d4edda; color: #155724; }
.statut-occupee { background-color: #f8d7da; color: #721c24; }
.statut-reservee { background-color: #fff3cd; color: #856404; }
.statut-en_renovation { background-color: #cce5ff; color: #004085; }
.statut-hors_service { background-color: #e2e3e5; color: #383d41; }

.stats-card {
    border-left: 4px solid;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
}

.stats-disponibles { border-left-color: #28a745; }
.stats-occupees { border-left-color: #dc3545; }
.stats-reservees { border-left-color: #ffc107; }
.stats-total { border-left-color: #007bff; }

.filter-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.unite-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.unite-details {
    font-size: 0.9em;
    color: #6c757d;
}

.loyer-info {
    font-weight: bold;
    color: #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- En-tête -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-building"></i> Gestion des Unités Locatives</h2>
                    <p class="text-muted mb-0">Gestion complète des unités dans vos propriétés</p>
                </div>
                <div>
                    <a href="{% url 'proprietes:unite_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Nouvelle Unité
                    </a>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card stats-total h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">Total Unités</h5>
                                    <h3 class="text-primary mb-0">{{ stats.total_unites }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-home fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card stats-disponibles h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">Disponibles</h5>
                                    <h3 class="text-success mb-0">{{ stats.unites_disponibles }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card stats-occupees h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">Occupées</h5>
                                    <h3 class="text-danger mb-0">{{ stats.unites_occupees }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-user-friends fa-2x text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card stats-reservees h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">Réservées</h5>
                                    <h3 class="text-warning mb-0">{{ stats.unites_reservees }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-clock fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filter-section">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="propriete" class="form-label">Propriété</label>
                        <select name="propriete" id="propriete" class="form-select">
                            <option value="">Toutes les propriétés</option>
                            {% for propriete in proprietes %}
                                <option value="{{ propriete.id }}" 
                                    {% if current_filters.propriete == propriete.id|stringformat:"s" %}selected{% endif %}>
                                    {{ propriete.titre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="statut" class="form-label">Statut</label>
                        <select name="statut" id="statut" class="form-select">
                            <option value="">Tous les statuts</option>
                            {% for statut_key, statut_label in statuts %}
                                <option value="{{ statut_key }}" 
                                    {% if current_filters.statut == statut_key %}selected{% endif %}>
                                    {{ statut_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="type_unite" class="form-label">Type</label>
                        <select name="type_unite" id="type_unite" class="form-select">
                            <option value="">Tous les types</option>
                            {% for type_key, type_label in types_unite %}
                                <option value="{{ type_key }}" 
                                    {% if current_filters.type_unite == type_key %}selected{% endif %}>
                                    {{ type_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="search" class="form-label">Recherche</label>
                        <input type="text" name="search" id="search" class="form-control" 
                               placeholder="Numéro, nom, propriété..." value="{{ current_filters.search }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i> Filtrer
                            </button>
                            <a href="{% url 'proprietes:unites_liste' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Liste des unités -->
            <div class="row">
                {% for unite in unites %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card unite-card h-100">
                        <div class="card-header bg-light">
                            <div class="unite-info">
                                <div>
                                    <h6 class="mb-0">
                                        <a href="{% url 'proprietes:unite_detail' unite.pk %}" 
                                           class="text-decoration-none">
                                            {{ unite.numero_unite }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">{{ unite.nom }}</small>
                                </div>
                                <span class="statut-badge statut-{{ unite.statut }}">
                                    {{ unite.get_statut_display }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="unite-details mb-3">
                                <div><i class="fas fa-building"></i> {{ unite.propriete.titre }}</div>
                                <div><i class="fas fa-tag"></i> {{ unite.get_type_unite_display }}</div>
                                {% if unite.etage is not None %}
                                    <div><i class="fas fa-layer-group"></i> 
                                        {% if unite.etage == 0 %}RDC{% elif unite.etage == -1 %}Sous-sol{% else %}{{ unite.etage }}ème étage{% endif %}
                                    </div>
                                {% endif %}
                                {% if unite.surface %}
                                    <div><i class="fas fa-ruler"></i> {{ unite.surface }} m²</div>
                                {% endif %}
                                <div><i class="fas fa-door-open"></i> {{ unite.nombre_pieces }} pièce{% if unite.nombre_pieces > 1 %}s{% endif %}</div>
                            </div>

                            <div class="loyer-info mb-3">
                                <div>Loyer: {{ unite.loyer_mensuel|format_currency_fcfa }}</div>
                                {% if unite.charges_mensuelles > 0 %}
                                    <div>Charges: {{ unite.charges_mensuelles|format_currency_fcfa }}</div>
                                    <div><strong>Total: {{ unite.get_loyer_total|format_currency_fcfa }}</strong></div>
                                {% endif %}
                            </div>

                            {% if unite.get_locataire_actuel %}
                                <div class="alert alert-info py-2 mb-2">
                                    <small>
                                        <i class="fas fa-user"></i> 
                                        {{ unite.get_locataire_actuel.nom }} {{ unite.get_locataire_actuel.prenom }}
                                    </small>
                                </div>
                            {% endif %}

                            <div class="d-flex gap-2 flex-wrap">
                                {% if unite.meuble %}<span class="badge bg-secondary">Meublé</span>{% endif %}
                                {% if unite.balcon %}<span class="badge bg-secondary">Balcon</span>{% endif %}
                                {% if unite.parking_inclus %}<span class="badge bg-secondary">Parking</span>{% endif %}
                                {% if unite.climatisation %}<span class="badge bg-secondary">Climatisation</span>{% endif %}
                                {% if unite.internet_inclus %}<span class="badge bg-secondary">Internet</span>{% endif %}
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'proprietes:unite_detail' unite.pk %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> Voir
                                </a>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'proprietes:unite_edit' unite.pk %}" 
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if unite.statut == 'disponible' %}
                                        <a href="{% url 'proprietes:reservation_create' unite.pk %}" 
                                           class="btn btn-sm btn-outline-warning">
                                            <i class="fas fa-calendar-plus"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h5>Aucune unité locative trouvée</h5>
                        <p>Aucune unité ne correspond aux critères de recherche.</p>
                        <a href="{% url 'proprietes:unite_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Créer la première unité
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <nav aria-label="Navigation des pages">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.propriete %}&propriete={{ request.GET.propriete }}{% endif %}{% if request.GET.statut %}&statut={{ request.GET.statut }}{% endif %}{% if request.GET.type_unite %}&type_unite={{ request.GET.type_unite }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.propriete %}&propriete={{ request.GET.propriete }}{% endif %}{% if request.GET.statut %}&statut={{ request.GET.statut }}{% endif %}{% if request.GET.type_unite %}&type_unite={{ request.GET.type_unite }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.propriete %}&propriete={{ request.GET.propriete }}{% endif %}{% if request.GET.statut %}&statut={{ request.GET.statut }}{% endif %}{% if request.GET.type_unite %}&type_unite={{ request.GET.type_unite }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.propriete %}&propriete={{ request.GET.propriete }}{% endif %}{% if request.GET.statut %}&statut={{ request.GET.statut }}{% endif %}{% if request.GET.type_unite %}&type_unite={{ request.GET.type_unite }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-submit du formulaire de filtrage lors du changement de sélection
    $('#propriete, #statut, #type_unite').change(function() {
        $(this).closest('form').submit();
    });
});
</script>
{% endblock %}
