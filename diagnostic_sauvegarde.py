#!/usr/bin/env python
"""
Diagnostic complet du probl√®me de sauvegarde
"""

import os
import sys
import django

# Configuration Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'gestion_immobiliere.settings')
django.setup()

from django.test import Client
from django.contrib.auth import authenticate
from utilisateurs.models import Utilisateur, GroupeTravail
from core.models import ConfigurationTableauBord
from core.utils import check_group_permissions

def diagnostic_complet():
    """Diagnostic complet du probl√®me de sauvegarde"""
    print("üîç Diagnostic complet du probl√®me de sauvegarde")
    print("=" * 60)
    
    try:
        # 1. V√©rifier la base de donn√©es
        print("\nüìä 1. V√©rification de la base de donn√©es:")
        print("-" * 40)
        
        # V√©rifier les mod√®les
        try:
            config_count = ConfigurationTableauBord.objects.count()
            print(f"‚úÖ ConfigurationTableauBord: {config_count} enregistrements")
        except Exception as e:
            print(f"‚ùå Erreur ConfigurationTableauBord: {str(e)}")
            return False
        
        try:
            user_count = Utilisateur.objects.count()
            print(f"‚úÖ Utilisateur: {user_count} enregistrements")
        except Exception as e:
            print(f"‚ùå Erreur Utilisateur: {str(e)}")
            return False
        
        try:
            groupe_count = GroupeTravail.objects.count()
            print(f"‚úÖ GroupeTravail: {groupe_count} enregistrements")
        except Exception as e:
            print(f"‚ùå Erreur GroupeTravail: {str(e)}")
            return False
        
        # 2. V√©rifier le groupe PRIVILEGE
        print("\nüë• 2. V√©rification du groupe PRIVILEGE:")
        print("-" * 40)
        
        try:
            groupe_privilege = GroupeTravail.objects.get(nom='PRIVILEGE')
            print(f"‚úÖ Groupe PRIVILEGE trouv√©: {groupe_privilege.nom}")
            print(f"   - Description: {groupe_privilege.description}")
            print(f"   - Actif: {groupe_privilege.actif}")
            print(f"   - Permissions: {groupe_privilege.permissions}")
        except GroupeTravail.DoesNotExist:
            print("‚ùå Groupe PRIVILEGE non trouv√© - Cr√©ation...")
            groupe_privilege = GroupeTravail.objects.create(
                nom='PRIVILEGE',
                description='Groupe avec privil√®ges sp√©ciaux',
                permissions={'modules': ['all']},
                actif=True
            )
            print(f"‚úÖ Groupe PRIVILEGE cr√©√©: {groupe_privilege.nom}")
        except Exception as e:
            print(f"‚ùå Erreur avec le groupe PRIVILEGE: {str(e)}")
            return False
        
        # 3. Cr√©er un utilisateur de test
        print("\nüë§ 3. Cr√©ation d'un utilisateur de test:")
        print("-" * 40)
        
        try:
            # Supprimer l'utilisateur de test s'il existe
            Utilisateur.objects.filter(username='test_privilege').delete()
            
            utilisateur_test = Utilisateur.objects.create(
                username='test_privilege',
                email='test@example.com',
                first_name='Test',
                last_name='Privilege',
                is_active=True
            )
            
            # D√©finir un mot de passe
            utilisateur_test.set_password('test123')
            utilisateur_test.save()
            
            print(f"‚úÖ Utilisateur de test cr√©√©: {utilisateur_test.username}")
            print(f"   - ID: {utilisateur_test.id}")
            print(f"   - Email: {utilisateur_test.email}")
            print(f"   - Actif: {utilisateur_test.is_active}")
            
        except Exception as e:
            print(f"‚ùå Erreur cr√©ation utilisateur: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
        
        # 4. Assigner l'utilisateur au groupe PRIVILEGE
        print("\nüîó 4. Assignment au groupe PRIVILEGE:")
        print("-" * 40)
        
        try:
            utilisateur_test.groupe_travail = groupe_privilege
            utilisateur_test.save()
            print(f"‚úÖ Utilisateur assign√© au groupe: {utilisateur_test.groupe_travail.nom}")
            
            # V√©rifier la relation
            utilisateur_refresh = Utilisateur.objects.get(id=utilisateur_test.id)
            print(f"‚úÖ V√©rification relation: {utilisateur_refresh.groupe_travail.nom}")
            
        except Exception as e:
            print(f"‚ùå Erreur assignment groupe: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
        
        # 5. Tester les permissions
        print("\nüîê 5. Test des permissions:")
        print("-" * 40)
        
        try:
            permissions = check_group_permissions(utilisateur_test, ['PRIVILEGE'], 'modify')
            print(f"‚úÖ Test permissions: {permissions}")
            
            if permissions['allowed']:
                print("‚úÖ Permissions OK - L'utilisateur peut modifier")
            else:
                print(f"‚ùå Permissions KO: {permissions['message']}")
                return False
                
        except Exception as e:
            print(f"‚ùå Erreur test permissions: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
        
        # 6. Test de cr√©ation de configuration
        print("\nüìù 6. Test de cr√©ation de configuration:")
        print("-" * 40)
        
        try:
            # Supprimer l'ancienne configuration si elle existe
            ConfigurationTableauBord.objects.filter(
                utilisateur=utilisateur_test,
                par_defaut=True
            ).delete()
            
            config = ConfigurationTableauBord.objects.create(
                utilisateur=utilisateur_test,
                nom_tableau="Tableau Test",
                par_defaut=True,
                widgets_actifs=['statistiques_generales'],
                masquer_montants_sensibles=True,
                affichage_anonymise=False,
                limite_donnees_recentes=30
            )
            
            print(f"‚úÖ Configuration cr√©√©e: {config.id}")
            print(f"   - Nom: {config.nom_tableau}")
            print(f"   - Utilisateur: {config.utilisateur.username}")
            print(f"   - Widgets: {config.widgets_actifs}")
            
        except Exception as e:
            print(f"‚ùå Erreur cr√©ation configuration: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
        
        # 7. Test de modification de configuration
        print("\n‚úèÔ∏è 7. Test de modification de configuration:")
        print("-" * 40)
        
        try:
            ancien_nom = config.nom_tableau
            config.nom_tableau = 'Tableau Modifi√©'
            config.save()
            
            print(f"‚úÖ Configuration modifi√©e: {ancien_nom} -> {config.nom_tableau}")
            
            # V√©rifier en base
            config_refresh = ConfigurationTableauBord.objects.get(id=config.id)
            print(f"‚úÖ V√©rification en base: {config_refresh.nom_tableau}")
            
        except Exception as e:
            print(f"‚ùå Erreur modification configuration: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
        
        # 8. Test via l'interface web
        print("\nüåê 8. Test via l'interface web:")
        print("-" * 40)
        
        try:
            client = Client()
            
            # Test de connexion
            login_success = client.login(username='test_privilege', password='test123')
            if login_success:
                print("‚úÖ Connexion r√©ussie")
            else:
                print("‚ùå √âchec de la connexion")
                return False
            
            # Test GET de la page de configuration
            response_get = client.get('/configuration-tableau/')
            print(f"‚úÖ GET /configuration-tableau/: {response_get.status_code}")
            
            if response_get.status_code != 200:
                print(f"‚ùå Erreur GET: {response_get.status_code}")
                print(f"   Contenu: {response_get.content[:500]}...")
                return False
            
            # Test POST de sauvegarde
            data_post = {
                'nom_tableau': 'Test Web POST',
                'widgets_actifs': ['statistiques_generales', 'activite_recente'],
                'masquer_montants': 'on',
                'affichage_anonymise': 'off',
                'limite_jours': '45'
            }
            
            response_post = client.post('/configuration-tableau/', data_post)
            print(f"‚úÖ POST /configuration-tableau/: {response_post.status_code}")
            
            if response_post.status_code == 302:  # Redirection apr√®s sauvegarde
                print("‚úÖ Sauvegarde r√©ussie (redirection)")
                
                # V√©rifier que la configuration a √©t√© sauvegard√©e
                config_sauvegardee = ConfigurationTableauBord.objects.filter(
                    utilisateur=utilisateur_test,
                    nom_tableau='Test Web POST'
                ).first()
                
                if config_sauvegardee:
                    print("‚úÖ Configuration trouv√©e en base apr√®s sauvegarde")
                    print(f"   - Nom: {config_sauvegardee.nom_tableau}")
                    print(f"   - Widgets: {config_sauvegardee.widgets_actifs}")
                    print(f"   - Limite jours: {config_sauvegardee.limite_donnees_recentes}")
                else:
                    print("‚ùå Configuration non trouv√©e apr√®s sauvegarde")
                    return False
                    
            else:
                print(f"‚ùå Erreur lors de la sauvegarde: {response_post.status_code}")
                if hasattr(response_post, 'content'):
                    print(f"   Contenu: {response_post.content[:500]}...")
                return False
                
        except Exception as e:
            print(f"‚ùå Erreur test web: {str(e)}")
            import traceback
            traceback.print_exc()
            return False
        
        # 9. Nettoyage
        print("\nüßπ 9. Nettoyage:")
        print("-" * 40)
        
        try:
            # Supprimer les configurations de test
            ConfigurationTableauBord.objects.filter(
                utilisateur=utilisateur_test
            ).delete()
            print("‚úÖ Configurations de test supprim√©es")
            
            # Supprimer l'utilisateur de test
            utilisateur_test.delete()
            print("‚úÖ Utilisateur de test supprim√©")
            
        except Exception as e:
            print(f"‚ö†Ô∏è Erreur lors du nettoyage: {str(e)}")
        
        print("\nüéâ Diagnostic termin√© avec succ√®s !")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur g√©n√©rale lors du diagnostic: {str(e)}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == '__main__':
    success = diagnostic_complet()
    if success:
        print("\n‚úÖ Tous les tests ont r√©ussi !")
    else:
        print("\n‚ùå Certains tests ont √©chou√©")
