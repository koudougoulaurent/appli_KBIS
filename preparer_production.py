#!/usr/bin/env python
"""
Script de pr√©paration √† la production - Nettoyage et configuration professionnelle
"""

import os
import sys
import django
from datetime import datetime

# Configuration Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'gestion_immobiliere.settings')
django.setup()

from django.db import connection, transaction
from django.contrib.auth import get_user_model
from utilisateurs.models import Utilisateur, GroupeTravail
from proprietes.models import Propriete, Bailleur, Locataire
from contrats.models import Contrat
from paiements.models import Paiement, Retrait, Recu
from contrats.models import Quittance
from core.id_generator import IDGenerator, IDConfiguration

Utilisateur = get_user_model()

def nettoyer_donnees_test():
    """Supprime toutes les donn√©es de test de la base"""
    
    print("üßπ NETTOYAGE DES DONN√âES DE TEST")
    print("=" * 60)
    
    # 1. Supprimer les utilisateurs de test
    print("\nüë• Suppression des utilisateurs de test...")
    utilisateurs_test = Utilisateur.objects.filter(
        username__startswith='test_'
    ).exclude(
        username='admin'  # Garder l'admin
    )
    
    count_utilisateurs = utilisateurs_test.count()
    if count_utilisateurs > 0:
        utilisateurs_test.delete()
        print(f"   ‚úÖ {count_utilisateurs} utilisateurs de test supprim√©s")
    else:
        print("   ‚ÑπÔ∏è Aucun utilisateur de test trouv√©")
    
    # 2. Supprimer les paiements de test (avant les contrats)
    print("\nüí∞ Suppression des paiements de test...")
    paiements_test = Paiement.objects.filter(
        contrat__propriete__adresse__icontains='test'
    )
    
    count_paiements = paiements_test.count()
    if count_paiements > 0:
        paiements_test.delete()
        print(f"   ‚úÖ {count_paiements} paiements de test supprim√©s")
    else:
        print("   ‚ÑπÔ∏è Aucun paiement de test trouv√©")
    
    # 3. Supprimer les re√ßus de test
    print("\nüßæ Suppression des re√ßus de test...")
    recus_test = Recu.objects.filter(
        paiement__contrat__propriete__adresse__icontains='test'
    )
    
    count_recus = recus_test.count()
    if count_recus > 0:
        recus_test.delete()
        print(f"   ‚úÖ {count_recus} re√ßus de test supprim√©s")
    else:
        print("   ‚ÑπÔ∏è Aucun re√ßu de test trouv√©")
    
    # 4. Supprimer les quittances de test
    print("\nüìÑ Suppression des quittances de test...")
    quittances_test = Quittance.objects.filter(
        contrat__propriete__adresse__icontains='test'
    )
    
    count_quittances = quittances_test.count()
    if count_quittances > 0:
        quittances_test.delete()
        print(f"   ‚úÖ {count_quittances} quittances de test supprim√©es")
    else:
        print("   ‚ÑπÔ∏è Aucune quittance de test trouv√©e")
    
    # 4.5. Supprimer les charges d√©ductibles de test
    print("\nüí∏ Suppression des charges d√©ductibles de test...")
    try:
        from paiements.models import ChargeDeductible
        charges_test = ChargeDeductible.objects.filter(
            contrat__propriete__adresse__icontains='test'
        )
        count_charges = charges_test.count()
        if count_charges > 0:
            charges_test.delete()
            print(f"   ‚úÖ {count_charges} charges d√©ductibles de test supprim√©es")
        else:
            print("   ‚ÑπÔ∏è Aucune charge d√©ductible de test trouv√©e")
    except ImportError:
        print("   ‚ÑπÔ∏è Mod√®le ChargeDeductible non disponible")
    
    # 4.6. Supprimer les autres d√©pendances de contrats
    print("\nüîó Suppression des autres d√©pendances de contrats...")
    try:
        from contrats.models import RenouvellementContrat
        renouvellements_test = RenouvellementContrat.objects.filter(
            contrat__propriete__adresse__icontains='test'
        )
        count_renouvellements = renouvellements_test.count()
        if count_renouvellements > 0:
            renouvellements_test.delete()
            print(f"   ‚úÖ {count_renouvellements} renouvellements de test supprim√©s")
        else:
            print("   ‚ÑπÔ∏è Aucun renouvellement de test trouv√©")
    except ImportError:
        print("   ‚ÑπÔ∏è Mod√®le RenouvellementContrat non disponible")
    
    # 5. Supprimer les contrats de test (apr√®s les paiements et d√©pendances)
    print("\nüìã Suppression des contrats de test...")
    contrats_test = Contrat.objects.filter(
        propriete__adresse__icontains='test'
    )
    
    count_contrats = contrats_test.count()
    if count_contrats > 0:
        contrats_test.delete()
        print(f"   ‚úÖ {count_contrats} contrats de test supprim√©s")
    else:
        print("   ‚ÑπÔ∏è Aucun contrat de test trouv√©")
    
    # 6. Maintenant supprimer les propri√©t√©s de test (apr√®s avoir supprim√© les contrats)
    print("\nüè† Suppression des propri√©t√©s de test...")
    proprietes_test = Propriete.objects.filter(
        adresse__icontains='test'
    )
    
    count_proprietes = proprietes_test.count()
    if count_proprietes > 0:
        proprietes_test.delete()
        print(f"   ‚úÖ {count_proprietes} propri√©t√©s de test supprim√©es")
    else:
        print("   ‚ÑπÔ∏è Aucune propri√©t√© de test trouv√©e")
    
    # 6.5. V√©rifier s'il reste des propri√©t√©s de test et les supprimer forc√©ment
    proprietes_restantes = Propriete.objects.filter(
        adresse__icontains='test'
    )
    if proprietes_restantes.exists():
        print("\n‚ö†Ô∏è  Suppression forc√©e des propri√©t√©s de test restantes...")
        for prop in proprietes_restantes:
            try:
                prop.delete()
                print(f"   ‚úÖ Propri√©t√© supprim√©e: {prop.adresse}")
            except Exception as e:
                print(f"   ‚ùå Erreur suppression {prop.adresse}: {e}")
                # Suppression forc√©e en base
                try:
                    from django.db import connection
                    with connection.cursor() as cursor:
                        cursor.execute("DELETE FROM proprietes_propriete WHERE id = %s", [prop.id])
                    print(f"   ‚úÖ Suppression forc√©e en base: {prop.adresse}")
                except Exception as e2:
                    print(f"   ‚ùå √âchec suppression forc√©e: {e2}")
    
    # 7. Enfin supprimer les bailleurs de test (apr√®s avoir supprim√© les propri√©t√©s)
    print("\nüë§ Suppression des bailleurs de test...")
    bailleurs_test = Bailleur.objects.filter(
        nom__icontains='test'
    ).exclude(
        nom__icontains='admin'
    )
    
    count_bailleurs = bailleurs_test.count()
    if count_bailleurs > 0:
        bailleurs_test.delete()
        print(f"   ‚úÖ {count_bailleurs} bailleurs de test supprim√©s")
    else:
        print("   ‚ÑπÔ∏è Aucun bailleur de test trouv√©")
    
    print("\n‚úÖ Nettoyage des donn√©es de test termin√© !")

def configurer_systeme_production():
    """Configure le syst√®me pour un usage professionnel"""
    
    print("\n‚öôÔ∏è CONFIGURATION DU SYST√àME PRODUCTION")
    print("=" * 60)
    
    # 1. V√©rifier la configuration des IDs
    print("\nüî¢ Configuration des identifiants uniques...")
    
    # Afficher la configuration actuelle
    print("   Configuration actuelle des IDs :")
    for entity_type, config in IDGenerator.ID_FORMATS.items():
        print(f"     {entity_type}: {config['format']}")
    
    # 2. V√©rifier la politique de r√©initialisation
    print("\nüìÖ Politique de r√©initialisation des s√©quences :")
    reset_policy = IDConfiguration.get_sequence_reset_policy()
    for entity, policy in reset_policy.items():
        print(f"     {entity}: {policy}")
    
    # 3. V√©rifier le pr√©fixe de l'entreprise
    company_prefix = IDConfiguration.get_company_prefix()
    print(f"\nüè¢ Pr√©fixe de l'entreprise: {company_prefix}")
    
    print("\n‚úÖ Configuration du syst√®me production termin√©e !")

def regenerer_ids_existants():
    """R√©g√©n√®re les IDs pour tous les enregistrements existants"""
    
    print("\nüîÑ R√âG√âN√âRATION DES IDENTIFIANTS EXISTANTS")
    print("=" * 60)
    
    with transaction.atomic():
        # 1. R√©g√©n√©rer les IDs des bailleurs
        print("\nüë§ R√©g√©n√©ration des IDs des bailleurs...")
        bailleurs_sans_id = Bailleur.objects.filter(numero_bailleur__isnull=True)
        count_bailleurs = bailleurs_sans_id.count()
        
        if count_bailleurs > 0:
            for bailleur in bailleurs_sans_id:
                bailleur.numero_bailleur = IDGenerator.generate_id('bailleur')
                bailleur.save(update_fields=['numero_bailleur'])
            print(f"   ‚úÖ {count_bailleurs} IDs de bailleurs r√©g√©n√©r√©s")
        else:
            print("   ‚ÑπÔ∏è Tous les bailleurs ont d√©j√† un ID")
        
        # 2. R√©g√©n√©rer les IDs des locataires
        print("\nüë• R√©g√©n√©ration des IDs des locataires...")
        locataires_sans_id = Locataire.objects.filter(numero_locataire__isnull=True)
        count_locataires = locataires_sans_id.count()
        
        if count_locataires > 0:
            for locataire in locataires_sans_id:
                locataire.numero_locataire = IDGenerator.generate_id('locataire')
                locataire.save(update_fields=['numero_locataire'])
            print(f"   ‚úÖ {count_locataires} IDs de locataires r√©g√©n√©r√©s")
        else:
            print("   ‚ÑπÔ∏è Tous les locataires ont d√©j√† un ID")
        
        # 3. R√©g√©n√©rer les IDs des propri√©t√©s
        print("\nüè† R√©g√©n√©ration des IDs des propri√©t√©s...")
        proprietes_sans_id = Propriete.objects.filter(numero_propriete__isnull=True)
        count_proprietes = proprietes_sans_id.count()
        
        if count_proprietes > 0:
            for propriete in proprietes_sans_id:
                propriete.numero_propriete = IDGenerator.generate_id('propriete')
                propriete.save(update_fields=['numero_propriete'])
            print(f"   ‚úÖ {count_proprietes} IDs de propri√©t√©s r√©g√©n√©r√©s")
        else:
            print("   ‚ÑπÔ∏è Toutes les propri√©t√©s ont d√©j√† un ID")
    
    print("\n‚úÖ R√©g√©n√©ration des identifiants termin√©e !")

def verifier_integrite_donnees():
    """V√©rifie l'int√©grit√© des donn√©es apr√®s nettoyage"""
    
    print("\nüîç V√âRIFICATION DE L'INT√âGRIT√â DES DONN√âES")
    print("=" * 60)
    
    # 1. Compter les enregistrements
    print("\nüìä Statistiques des donn√©es :")
    
    count_bailleurs = Bailleur.objects.count()
    count_locataires = Locataire.objects.count()
    count_proprietes = Propriete.objects.count()
    count_contrats = Contrat.objects.count()
    count_paiements = Paiement.objects.count()
    count_utilisateurs = Utilisateur.objects.count()
    
    print(f"   Bailleurs: {count_bailleurs}")
    print(f"   Locataires: {count_locataires}")
    print(f"   Propri√©t√©s: {count_proprietes}")
    print(f"   Contrats: {count_contrats}")
    print(f"   Paiements: {count_paiements}")
    print(f"   Utilisateurs: {count_utilisateurs}")
    
    # 2. V√©rifier les relations
    print("\nüîó V√©rification des relations :")
    
    proprietes_sans_bailleur = Propriete.objects.filter(bailleur__isnull=True).count()
    contrats_sans_propriete = Contrat.objects.filter(propriete__isnull=True).count()
    paiements_sans_contrat = Paiement.objects.filter(contrat__isnull=True).count()
    
    print(f"   Propri√©t√©s sans bailleur: {proprietes_sans_bailleur}")
    print(f"   Contrats sans propri√©t√©: {contrats_sans_propriete}")
    print(f"   Paiements sans contrat: {paiements_sans_contrat}")
    
    # 3. V√©rifier les IDs uniques
    print("\nüÜî V√©rification des identifiants uniques :")
    
    bailleurs_avec_id = Bailleur.objects.filter(numero_bailleur__isnull=False).count()
    locataires_avec_id = Locataire.objects.filter(numero_locataire__isnull=False).count()
    proprietes_avec_id = Propriete.objects.filter(numero_propriete__isnull=False).count()
    
    print(f"   Bailleurs avec ID: {bailleurs_avec_id}/{count_bailleurs}")
    print(f"   Locataires avec ID: {locataires_avec_id}/{count_locataires}")
    print(f"   Propri√©t√©s avec ID: {proprietes_avec_id}/{count_proprietes}")
    
    if (bailleurs_avec_id == count_bailleurs and 
        locataires_avec_id == count_locataires and 
        proprietes_avec_id == count_proprietes):
        print("   ‚úÖ Tous les enregistrements ont un ID unique")
    else:
        print("   ‚ö†Ô∏è Certains enregistrements n'ont pas d'ID unique")
    
    print("\n‚úÖ V√©rification de l'int√©grit√© termin√©e !")

def creer_utilisateur_admin_production():
    """Cr√©e un utilisateur administrateur pour la production"""
    
    print("\nüëë CR√âATION DE L'UTILISATEUR ADMINISTRATEUR")
    print("=" * 60)
    
    # V√©rifier si l'admin existe d√©j√†
    if Utilisateur.objects.filter(username='admin').exists():
        print("   ‚ÑπÔ∏è L'utilisateur admin existe d√©j√†")
        return
    
    # Cr√©er le groupe PRIVILEGE s'il n'existe pas
    groupe_privilege, created = GroupeTravail.objects.get_or_create(
        nom='PRIVILEGE',
        defaults={
            'description': 'Groupe avec tous les privil√®ges',
            'niveau_acces': 100
        }
    )
    
    if created:
        print(f"   ‚úÖ Groupe PRIVILEGE cr√©√©")
    else:
        print(f"   ‚ÑπÔ∏è Groupe PRIVILEGE d√©j√† pr√©sent")
    
    # Cr√©er l'utilisateur admin
    try:
        admin_user = Utilisateur.objects.create_user(
            username='admin',
            email='admin@gestionimmobiliere.com',
            password='Admin2024!',  # √Ä changer en production !
            first_name='Administrateur',
            last_name='Syst√®me',
            groupe_travail=groupe_privilege,
            is_staff=True,
            is_superuser=True
        )
        print(f"   ‚úÖ Utilisateur admin cr√©√©: {admin_user.username}")
        print("   ‚ö†Ô∏è MOT DE PASSE: Admin2024! - √Ä CHANGER EN PRODUCTION !")
        
    except Exception as e:
        print(f"   ‚ùå Erreur lors de la cr√©ation de l'admin: {e}")
    
    print("\n‚úÖ Configuration de l'utilisateur administrateur termin√©e !")

def afficher_instructions_production():
    """Affiche les instructions pour la production"""
    
    print("\nüìã INSTRUCTIONS POUR LA PRODUCTION")
    print("=" * 60)
    
    print("""
üöÄ L'application est maintenant pr√™te pour la production !

üìù ACTIONS REQUISES AVANT D√âPLOIEMENT :

1. üîê S√âCURIT√â :
   - Changer le mot de passe de l'utilisateur admin
   - Configurer HTTPS
   - Mettre √† jour les param√®tres de s√©curit√© Django

2. üóÑÔ∏è BASE DE DONN√âES :
   - Sauvegarder la base SQLite actuelle
   - Migrer vers PostgreSQL ou MySQL pour la production
   - Configurer les sauvegardes automatiques

3. ‚öôÔ∏è CONFIGURATION :
   - Modifier les param√®tres dans core/id_generator.py
   - Configurer le pr√©fixe de l'entreprise
   - Ajuster les formats d'IDs selon vos besoins

4. üìä DONN√âES :
   - Supprimer toutes les donn√©es de test
   - Importer vos donn√©es r√©elles
   - V√©rifier l'int√©grit√© des donn√©es

5. üöÄ D√âPLOIEMENT :
   - Configurer le serveur web (Nginx/Apache)
   - Configurer WSGI/ASGI
   - Mettre en place le monitoring

üìû SUPPORT :
   - Consultez la documentation Django
   - Testez toutes les fonctionnalit√©s
   - Pr√©parez la formation des utilisateurs
""")

def main():
    """Fonction principale"""
    
    print("üè¢ PR√âPARATION √Ä LA PRODUCTION - GESTION IMMOBILI√àRE")
    print("=" * 80)
    print(f"Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 80)
    
    try:
        # 1. Nettoyer les donn√©es de test
        nettoyer_donnees_test()
        
        # 2. Configurer le syst√®me pour la production
        configurer_systeme_production()
        
        # 3. R√©g√©n√©rer les IDs existants
        regenerer_ids_existants()
        
        # 4. V√©rifier l'int√©grit√© des donn√©es
        verifier_integrite_donnees()
        
        # 5. Cr√©er l'utilisateur admin
        creer_utilisateur_admin_production()
        
        # 6. Afficher les instructions
        afficher_instructions_production()
        
        print("\nüéâ PR√âPARATION √Ä LA PRODUCTION TERMIN√âE AVEC SUCC√àS !")
        print("L'application est maintenant pr√™te pour un usage professionnel.")
        
    except Exception as e:
        print(f"\n‚ùå ERREUR LORS DE LA PR√âPARATION: {e}")
        print("Veuillez v√©rifier les logs et r√©essayer.")
        return False
    
    return True

if __name__ == "__main__":
    main()
