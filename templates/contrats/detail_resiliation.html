{% extends 'base.html' %}
{% load static %}

{% block title %}Détail de la Résiliation - Gestion Immobilière{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-x-circle text-primary"></i>
        Détail de la Résiliation
    </h1>
    <div class="btn-group" role="group">
        <a href="{% url 'contrats:liste_resiliations' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour à la liste
        </a>
        {% if resiliation.statut == 'en_cours' %}
            <a href="{% url 'contrats:valider_resiliation' resiliation.id %}" 
               class="btn btn-success"
               onclick="return confirm('Êtes-vous sûr de vouloir valider cette résiliation ?')">
                <i class="bi bi-check-circle"></i> Valider
            </a>
        {% endif %}
        {% if resiliation.peut_etre_supprimee %}
            <a href="{% url 'contrats:supprimer_resiliation' resiliation.id %}" 
               class="btn btn-danger"
               onclick="return confirm('Attention ! Cette action supprimera définitivement le contrat et la résiliation. Êtes-vous sûr ?')">
                <i class="bi bi-trash"></i> Supprimer
            </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Informations de la résiliation -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Informations de la Résiliation
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Statut:</strong> 
                            {% if resiliation.statut == 'en_cours' %}
                                <span class="badge bg-warning">En cours</span>
                            {% elif resiliation.statut == 'validee' %}
                                <span class="badge bg-success">Validée</span>
                            {% elif resiliation.statut == 'annulee' %}
                                <span class="badge bg-danger">Annulée</span>
                            {% elif resiliation.statut == 'supprimee' %}
                                <span class="badge bg-secondary">Supprimée</span>
                            {% endif %}
                        </p>
                        <p><strong>Type:</strong> 
                            {% if resiliation.type_resiliation == 'locataire' %}
                                <span class="badge bg-info">Par le locataire</span>
                            {% elif resiliation.type_resiliation == 'bailleur' %}
                                <span class="badge bg-warning">Par le bailleur</span>
                            {% elif resiliation.type_resiliation == 'accord_mutuel' %}
                                <span class="badge bg-success">Accord mutuel</span>
                            {% elif resiliation.type_resiliation == 'expiration' %}
                                <span class="badge bg-secondary">Expiration naturelle</span>
                            {% elif resiliation.type_resiliation == 'judiciaire' %}
                                <span class="badge bg-danger">Judiciaire</span>
                            {% endif %}
                        </p>
                        <p><strong>Date de résiliation:</strong> {{ resiliation.date_resiliation|date:"d/m/Y" }}</p>
                        <p><strong>Date de création:</strong> {{ resiliation.date_creation|date:"d/m/Y H:i" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Créée par:</strong> 
                            {% if resiliation.cree_par %}
                                {{ resiliation.cree_par.get_full_name }}
                            {% else %}
                                <span class="text-muted">Non spécifié</span>
                            {% endif %}
                        </p>
                        <p><strong>Validée par:</strong> 
                            {% if resiliation.validee_par %}
                                {{ resiliation.validee_par.get_full_name }}
                            {% else %}
                                <span class="text-muted">Non validée</span>
                            {% endif %}
                        </p>
                        <p><strong>Dernière modification:</strong> {{ resiliation.date_modification|date:"d/m/Y H:i" }}</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Motif de résiliation:</h6>
                    <p class="border rounded p-3 bg-light">{{ resiliation.motif_resiliation }}</p>
                </div>
                
                {% if resiliation.etat_lieux_sortie %}
                <div class="mt-3">
                    <h6>État des lieux de sortie:</h6>
                    <p class="border rounded p-3 bg-light">{{ resiliation.etat_lieux_sortie }}</p>
                </div>
                {% endif %}
                
                {% if resiliation.notes %}
                <div class="mt-3">
                    <h6>Notes:</h6>
                    <p class="border rounded p-3 bg-light">{{ resiliation.notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Informations du contrat -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-contract"></i> Contrat Résilié
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Numéro de contrat:</strong> {{ resiliation.contrat.numero_contrat }}</p>
                        <p><strong>Date de signature:</strong> {{ resiliation.contrat.date_signature|date:"d/m/Y" }}</p>
                        <p><strong>Date de début:</strong> {{ resiliation.contrat.date_debut|date:"d/m/Y" }}</p>
                        <p><strong>Date de fin:</strong> {{ resiliation.contrat.date_fin|date:"d/m/Y" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Loyer mensuel:</strong> {{ resiliation.contrat.loyer_mensuel }} XOF</p>
                        <p><strong>Charges mensuelles:</strong> {{ resiliation.contrat.charges_mensuelles }} XOF</p>
                        <p><strong>Dépôt de garantie:</strong> {{ resiliation.contrat.depot_garantie }} XOF</p>
                        <p><strong>Avance de loyer:</strong> {{ resiliation.contrat.avance_loyer }} XOF</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Propriété:</h6>
                    <p><strong>{{ resiliation.contrat.propriete.titre }}</strong></p>
                    <p class="text-muted">{{ resiliation.contrat.propriete.adresse }}, {{ resiliation.contrat.propriete.ville }}</p>
                </div>
                
                <div class="mt-3">
                    <h6>Locataire:</h6>
                    <p><strong>{{ resiliation.contrat.locataire.get_nom_complet }}</strong></p>
                    <p class="text-muted">{{ resiliation.contrat.locataire.email }} - {{ resiliation.contrat.locataire.telephone }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Gestion de la caution -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i> Gestion de la Caution
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               id="caution_remboursee" 
                               {% if resiliation.caution_remboursee %}checked{% endif %} 
                               disabled
                               aria-label="Statut de remboursement de la caution">
                        <label class="form-check-label" for="caution_remboursee">
                            Caution remboursée
                        </label>
                    </div>
                </div>
                
                {% if resiliation.caution_remboursee %}
                    <p><strong>Montant remboursé:</strong> {{ resiliation.get_montant_remboursement_formatted }}</p>
                    <p><strong>Date de remboursement:</strong> {{ resiliation.date_remboursement|date:"d/m/Y" }}</p>
                {% else %}
                    <p class="text-muted">Caution non encore remboursée</p>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{% url 'contrats:detail_contrat_caution' resiliation.contrat.id %}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-shield-check"></i> Gérer la caution
                    </a>
                </div>
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> Actions Rapides
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'contrats:detail' resiliation.contrat.id %}" class="btn btn-outline-info">
                        <i class="bi bi-eye"></i> Voir le contrat
                    </a>
                    <a href="{% url 'contrats:detail_contrat_caution' resiliation.contrat.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-shield-check"></i> Gestion caution
                    </a>
                    <a href="{% url 'contrats:liste_resiliations' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-list"></i> Toutes les résiliations
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
