{% extends 'base.html' %}
{% load static %}

{% block title %}Configuration de l'Entreprise{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'core:dashboard' %}">
                                <i class="fas fa-tachometer-alt me-1"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Configuration Entreprise</li>
                    </ol>
                </nav>
                <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Retour
                </a>
            </div>

            {% if messages %}
            <div class="messages mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="row">
                <!-- Formulaire de configuration -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0">
                                <i class="fas fa-building me-2"></i>
                                Configuration de l'Entreprise
                            </h4>
                        </div>
                        <div class="card-body">
                            {% if can_modify %}
                                <form method="post">
                                    {% csrf_token %}
                                
                                <!-- Informations de base -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Informations de base
                                        </h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.nom_entreprise.id_for_label }}" class="form-label">
                                                Nom de l'entreprise *
                                            </label>
                                            {{ form.nom_entreprise }}
                                            {% if form.nom_entreprise.errors %}
                                            <div class="text-danger">{{ form.nom_entreprise.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.slogan.id_for_label }}" class="form-label">
                                                Slogan
                                            </label>
                                            {{ form.slogan }}
                                            {% if form.slogan.errors %}
                                            <div class="text-danger">{{ form.slogan.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Adresse -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-map-marker-alt me-2"></i>
                                            Adresse
                                        </h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.adresse_ligne1.id_for_label }}" class="form-label">
                                                Adresse ligne 1 *
                                            </label>
                                            {{ form.adresse_ligne1 }}
                                            {% if form.adresse_ligne1.errors %}
                                            <div class="text-danger">{{ form.adresse_ligne1.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.adresse_ligne2.id_for_label }}" class="form-label">
                                                Adresse ligne 2
                                            </label>
                                            {{ form.adresse_ligne2 }}
                                            {% if form.adresse_ligne2.errors %}
                                            <div class="text-danger">{{ form.adresse_ligne2.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.code_postal.id_for_label }}" class="form-label">
                                                Code postal
                                            </label>
                                            {{ form.code_postal }}
                                            {% if form.code_postal.errors %}
                                            <div class="text-danger">{{ form.code_postal.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.ville.id_for_label }}" class="form-label">
                                                Ville *
                                            </label>
                                            {{ form.ville }}
                                            {% if form.ville.errors %}
                                            <div class="text-danger">{{ form.ville.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.pays.id_for_label }}" class="form-label">
                                                Pays *
                                            </label>
                                            {{ form.pays }}
                                            {% if form.pays.errors %}
                                            <div class="text-danger">{{ form.pays.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-phone me-2"></i>
                                            Contact
                                        </h5>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.telephone.id_for_label }}" class="form-label">
                                                Téléphone *
                                            </label>
                                            {{ form.telephone }}
                                            {% if form.telephone.errors %}
                                            <div class="text-danger">{{ form.telephone.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.telephone_2.id_for_label }}" class="form-label">
                                                Téléphone 2
                                            </label>
                                            {{ form.telephone_2 }}
                                            {% if form.telephone_2.errors %}
                                            <div class="text-danger">{{ form.telephone_2.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                                Email *
                                            </label>
                                            {{ form.email }}
                                            {% if form.email.errors %}
                                            <div class="text-danger">{{ form.email.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.site_web.id_for_label }}" class="form-label">
                                                Site web
                                            </label>
                                            {{ form.site_web }}
                                            {% if form.site_web.errors %}
                                            <div class="text-danger">{{ form.site_web.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations légales -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-gavel me-2"></i>
                                            Informations légales
                                        </h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.rccm.id_for_label }}" class="form-label">
                                                RCCM
                                            </label>
                                            {{ form.rccm }}
                                            {% if form.rccm.errors %}
                                            <div class="text-danger">{{ form.rccm.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.ifu.id_for_label }}" class="form-label">
                                                IFU
                                            </label>
                                            {{ form.ifu }}
                                            {% if form.ifu.errors %}
                                            <div class="text-danger">{{ form.ifu.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.numero_compte_contribuable.id_for_label }}" class="form-label">
                                                N° Compte Contribuable
                                            </label>
                                            {{ form.numero_compte_contribuable }}
                                            {% if form.numero_compte_contribuable.errors %}
                                            <div class="text-danger">{{ form.numero_compte_contribuable.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Personnalisation -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-palette me-2"></i>
                                            Personnalisation des reçus
                                        </h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.entete_upload.id_for_label }}" class="form-label">
                                                En-tête complet uploadé
                                            </label>
                                            {{ form.entete_upload }}
                                            <small class="form-text text-muted">
                                                En-tête complet de votre entreprise (remplace le logo et le texte)
                                            </small>
                                            {% if form.entete_upload.errors %}
                                            <div class="text-danger">{{ form.entete_upload.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.logo_upload.id_for_label }}" class="form-label">
                                                Logo uploadé
                                            </label>
                                            {{ form.logo_upload }}
                                            <small class="form-text text-muted">
                                                Logo de votre entreprise (PNG, JPG, GIF - max 5MB)
                                            </small>
                                            {% if form.logo_upload.errors %}
                                            <div class="text-danger">{{ form.logo_upload.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.logo_url.id_for_label }}" class="form-label">
                                                URL du logo
                                            </label>
                                            {{ form.logo_url }}
                                            <small class="form-text text-muted">
                                                URL externe du logo (optionnel si vous uploadez un fichier)
                                            </small>
                                            {% if form.logo_url.errors %}
                                            <div class="text-danger">{{ form.logo_url.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.couleur_principale.id_for_label }}" class="form-label">
                                                Couleur principale
                                            </label>
                                            {{ form.couleur_principale }}
                                            {% if form.couleur_principale.errors %}
                                            <div class="text-danger">{{ form.couleur_principale.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.couleur_secondaire.id_for_label }}" class="form-label">
                                                Couleur secondaire
                                            </label>
                                            {{ form.couleur_secondaire }}
                                            {% if form.couleur_secondaire.errors %}
                                            <div class="text-danger">{{ form.couleur_secondaire.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations bancaires -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-university me-2"></i>
                                            Informations bancaires (optionnel)
                                        </h5>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.banque.id_for_label }}" class="form-label">
                                                Banque
                                            </label>
                                            {{ form.banque }}
                                            {% if form.banque.errors %}
                                            <div class="text-danger">{{ form.banque.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.iban.id_for_label }}" class="form-label">
                                                IBAN
                                            </label>
                                            {{ form.iban }}
                                            {% if form.iban.errors %}
                                            <div class="text-danger">{{ form.iban.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.bic.id_for_label }}" class="form-label">
                                                BIC
                                            </label>
                                            {{ form.bic }}
                                            {% if form.bic.errors %}
                                            <div class="text-danger">{{ form.bic.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Textes personnalisés -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-file-text me-2"></i>
                                            Textes personnalisés
                                        </h5>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.texte_contrat.id_for_label }}" class="form-label">
                                                Texte personnalisé pour les contrats
                                            </label>
                                            {{ form.texte_contrat }}
                                            <small class="form-text text-muted">
                                                Texte personnalisé pour les obligations et conditions des contrats de bail
                                            </small>
                                            {% if form.texte_contrat.errors %}
                                            <div class="text-danger">{{ form.texte_contrat.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.texte_resiliation.id_for_label }}" class="form-label">
                                                Texte personnalisé pour les résiliations
                                            </label>
                                            {{ form.texte_resiliation }}
                                            <small class="form-text text-muted">
                                                Texte personnalisé pour les conditions de sortie des résiliations
                                            </small>
                                            {% if form.texte_resiliation.errors %}
                                            <div class="text-danger">{{ form.texte_resiliation.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Boutons d'action -->
                                <div class="row">
                                    <div class="col-12">
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center">
                                            {% if can_modify %}
                                            <button type="button" id="resetDefaults" class="btn btn-outline-warning">
                                                <i class="fas fa-undo me-1"></i>
                                                Réinitialiser aux valeurs par défaut
                                            </button>
                                            {% endif %}
                                            {% if can_modify %}
                                            <div>
                                                <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary me-2">
                                                    Annuler
                                                </a>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-1"></i>
                                                    Enregistrer la configuration
                                                </button>
                                            </div>
                                            {% else %}
                                            <div>
                                                <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">
                                                    Retour au Dashboard
                                                </a>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </form>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Mode consultation uniquement :</strong> Vous pouvez consulter la configuration mais vous n'avez pas les permissions pour la modifier. Contactez un administrateur pour effectuer des changements.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Aperçu -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-eye me-2"></i>
                                Aperçu de l'en-tête
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="preview" class="border p-3 rounded">
                                <div class="text-center mb-3">
                                    <h5 id="preview-nom" class="mb-1">{{ config.nom_entreprise }}</h5>
                                    <small id="preview-slogan" class="text-muted">{{ config.slogan|default:"" }}</small>
                                </div>
                                <div class="text-center">
                                    <small id="preview-adresse" class="text-muted">
                                        {{ config.get_adresse_complete }}
                                    </small><br>
                                    <small id="preview-contact" class="text-muted">
                                        {{ config.get_contact_complet }}
                                    </small><br>
                                    <small id="preview-legal" class="text-muted">
                                        {{ config.get_informations_legales }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informations -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Informations
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Ces informations apparaîtront sur tous les reçus
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Les couleurs personnalisent l'apparence des reçus
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Le logo peut être hébergé sur un serveur externe
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Les informations bancaires sont optionnelles
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Mise à jour de l'aperçu en temps réel
    function updatePreview() {
        const nom = $('#id_nom_entreprise').val() || 'GESTIMMOB';
        const slogan = $('#id_slogan').val() || '';
        const adresseLigne1 = $('#id_adresse_ligne1').val() || 'Avenue de la République';
        const adresseLigne2 = $('#id_adresse_ligne2').val() || '';
        const codePostal = $('#id_code_postal').val() || '00225';
        const ville = $('#id_ville').val() || 'Abidjan';
        const pays = $('#id_pays').val() || 'Côte d\'Ivoire';
        const telephone = $('#id_telephone').val() || '+225 XX XX XX XX XX';
        const telephone2 = $('#id_telephone_2').val() || '';
        const email = $('#id_email').val() || 'contact@kbis-immobilier.ci';
        const siteWeb = $('#id_site_web').val() || 'www.kbis-immobilier.ci';
        const rccm = $('#id_rccm').val() || 'CI-ABJ-XXXX-X-XXXXX';
        const ifu = $('#id_ifu').val() || 'XXXXXXXXXX';
        const compteContribuable = $('#id_numero_compte_contribuable').val() || '';
        
        // Mise à jour de l'aperçu
        $('#preview-nom').text(nom);
        $('#preview-slogan').text(slogan);
        
        // Construction de l'adresse
        let adresseComplete = adresseLigne1;
        if (adresseLigne2) adresseComplete += `, ${adresseLigne2}`;
        if (codePostal && ville) adresseComplete += `, ${codePostal} ${ville}`;
        else if (codePostal) adresseComplete += `, ${codePostal}`;
        else if (ville) adresseComplete += `, ${ville}`;
        if (pays) adresseComplete += `, ${pays}`;
        $('#preview-adresse').text(adresseComplete);
        
        // Construction du contact
        let contact = `Tél: ${telephone}`;
        if (telephone2) contact += ` / ${telephone2}`;
        if (email) contact += ` | Email: ${email}`;
        if (siteWeb) contact += ` | Web: ${siteWeb}`;
        $('#preview-contact').text(contact);
        
        // Construction des informations légales
        let legal = `RCCM: ${rccm}`;
        if (ifu) legal += ` | IFU: ${ifu}`;
        if (compteContribuable) legal += ` | N° Compte: ${compteContribuable}`;
        $('#preview-legal').text(legal);
    }
    
    // Écouter les changements sur tous les champs
    $('input, textarea').on('input', updatePreview);
    
    // Réinitialiser aux valeurs par défaut
    $('#resetDefaults').click(function() {
        if (confirm('Êtes-vous sûr de vouloir réinitialiser toutes les informations aux valeurs par défaut ?')) {
            $('#id_nom_entreprise').val('KBIS IMMOBILIER');
            $('#id_slogan').val('Votre Partenaire Immobilier de Confiance');
            $('#id_adresse_ligne1').val('Avenue de la République');
            $('#id_adresse_ligne2').val('Quartier Centre-Ville');
            $('#id_code_postal').val('00225');
            $('#id_ville').val('Abidjan');
            $('#id_pays').val('Côte d\'Ivoire');
            $('#id_telephone').val('+225 XX XX XX XX XX');
            $('#id_telephone_2').val('');
            $('#id_email').val('contact@kbis-immobilier.ci');
            $('#id_site_web').val('www.kbis-immobilier.ci');
            $('#id_rccm').val('CI-ABJ-XXXX-X-XXXXX');
            $('#id_ifu').val('XXXXXXXXXX');
            $('#id_numero_compte_contribuable').val('');
            $('#id_logo_url').val('');
            $('#id_couleur_principale').val('#2c3e50');
            $('#id_couleur_secondaire').val('#3498db');
            $('#id_banque').val('');
            $('#id_iban').val('');
            $('#id_bic').val('');
            $('#id_texte_contrat').val('');
            $('#id_texte_resiliation').val('');
            
            updatePreview();
            alert('Configuration réinitialisée. Cliquez sur "Enregistrer" pour appliquer les changements.');
        }
    });
    
    // Initialiser l'aperçu
    updatePreview();
});
</script>
{% endblock %} 