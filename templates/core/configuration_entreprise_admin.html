{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Configuration de l'Entreprise - Admin{% endblock %}

{% block extra_css %}
<style>
    .upload-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px dashed #007cba;
        border-radius: 12px;
        padding: 30px;
        margin: 20px 0;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .upload-section:hover {
        border-color: #005a87;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
    }
    
    .upload-section.entete {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    }
    
    .upload-section.entete:hover {
        border-color: #c53030;
        background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
    }
    
    .upload-section.logo {
        border-color: #28a745;
        background: linear-gradient(135deg, #f0fff4 0%, #dcffe4 100%);
    }
    
    .upload-section.logo:hover {
        border-color: #1e7e34;
        background: linear-gradient(135deg, #dcffe4 0%, #c6f6d5 100%);
    }
    
    .file-input-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        margin: 20px 0;
    }
    
    .file-input-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
        opacity: 0;
        cursor: pointer;
    }
    
    .file-input-label {
        display: inline-block;
        padding: 12px 24px;
        background: #007cba;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .file-input-label:hover {
        background: #005a87;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    .file-input-label.entete {
        background: #dc3545;
    }
    
    .file-input-label.entete:hover {
        background: #c53030;
    }
    
    .file-input-label.logo {
        background: #28a745;
    }
    
    .file-input-label.logo:hover {
        background: #1e7e34;
    }
    
    .preview-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007cba;
    }
    
    .preview-image {
        max-width: 100%;
        max-height: 200px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .priority-indicator {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
    }
    
    .priority-absolute {
        background: #dc3545;
        color: white;
    }
    
    .priority-high {
        background: #28a745;
        color: white;
    }
    
    .priority-medium {
        background: #007cba;
        color: white;
    }
    
    .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 10px;
    }
    
    .btn-delete:hover {
        background: #c53030;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-cog text-primary"></i>
                    Configuration de l'Entreprise - Admin
                </h1>
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Retour au Dashboard
                </a>
            </div>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
            
            <form method="post" enctype="multipart/form-data" id="configForm">
                {% csrf_token %}
                
                <!-- Section Identité Visuelle -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-palette"></i>
                            Identité Visuelle
                        </h5>
                    </div>
                    <div class="card-body">
                        
                        <!-- En-tête personnalisé -->
                        <div class="upload-section entete">
                            <h6 class="text-danger mb-3">
                                <i class="fas fa-crown"></i>
                                En-tête Complet Personnalisé
                                <span class="priority-indicator priority-absolute">PRIORITÉ ABSOLUE</span>
                            </h6>
                            <p class="text-muted mb-3">
                                L'en-tête personnalisé remplace complètement le logo et le texte sur tous vos documents.
                                <br><strong>Formats acceptés :</strong> PNG, JPG, JPEG | <strong>Taille max :</strong> 10MB
                            </p>
                            
                            {% if config.entete_upload %}
                                <div class="preview-section">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-check-circle"></i>
                                        En-tête actuel :
                                    </h6>
                                    <img src="{{ config.entete_upload.url }}" alt="En-tête actuel" class="preview-image">
                                    <form method="post" action="{% url 'supprimer_entete' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-delete" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet en-tête ?')">
                                            <i class="fas fa-trash"></i> Supprimer
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                            
                            <div class="file-input-wrapper">
                                <input type="file" name="entete_upload" id="entete_upload" accept="image/*" class="form-control-file">
                                <label for="entete_upload" class="file-input-label entete">
                                    <i class="fas fa-upload"></i>
                                    {% if config.entete_upload %}
                                        Remplacer l'en-tête
                                    {% else %}
                                        Choisir un en-tête personnalisé
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        
                        <!-- Logo -->
                        <div class="upload-section logo">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-image"></i>
                                Logo de l'Entreprise
                                <span class="priority-indicator priority-high">PRIORITÉ ÉLEVÉE</span>
                            </h6>
                            <p class="text-muted mb-3">
                                Le logo apparaîtra à côté des informations textuelles si aucun en-tête personnalisé n'est configuré.
                                <br><strong>Formats acceptés :</strong> PNG, JPG, GIF | <strong>Taille max :</strong> 5MB
                            </p>
                            
                            {% if config.logo_upload %}
                                <div class="preview-section">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-check-circle"></i>
                                        Logo actuel :
                                    </h6>
                                    <img src="{{ config.logo_upload.url }}" alt="Logo actuel" class="preview-image">
                                    <form method="post" action="{% url 'supprimer_logo' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-delete" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce logo ?')">
                                            <i class="fas fa-trash"></i> Supprimer
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                            
                            <div class="file-input-wrapper">
                                <input type="file" name="logo_upload" id="logo_upload" accept="image/*" class="form-control-file">
                                <label for="logo_upload" class="file-input-label logo">
                                    <i class="fas fa-upload"></i>
                                    {% if config.logo_upload %}
                                        Remplacer le logo
                                    {% else %}
                                        Choisir un logo
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        
                        <!-- URL externe du logo -->
                        <div class="mb-3">
                            <label for="logo_url" class="form-label">
                                <i class="fas fa-link"></i>
                                URL externe du logo
                                <span class="priority-indicator priority-medium">PRIORITÉ MOYENNE</span>
                            </label>
                            <input type="url" class="form-control" id="logo_url" name="logo_url" 
                                   value="{{ config.logo_url|default:'' }}" 
                                   placeholder="https://exemple.com/logo.png">
                            <div class="form-text">
                                URL externe du logo (optionnel si vous uploadez un fichier)
                            </div>
                        </div>
                        
                        <!-- Couleurs -->
                        <div class="row">
                            <div class="col-md-6">
                                <label for="couleur_principale" class="form-label">
                                    <i class="fas fa-palette"></i>
                                    Couleur principale
                                </label>
                                <input type="color" class="form-control form-control-color" id="couleur_principale" 
                                       name="couleur_principale" value="{{ config.couleur_principale|default:'#2c3e50' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="couleur_secondaire" class="form-label">
                                    <i class="fas fa-palette"></i>
                                    Couleur secondaire
                                </label>
                                <input type="color" class="form-control form-control-color" id="couleur_secondaire" 
                                       name="couleur_secondaire" value="{{ config.couleur_secondaire|default:'#3498db' }}">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Autres sections du formulaire -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i>
                            Informations de Base
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="nom_entreprise" class="form-label">
                                    <i class="fas fa-building"></i>
                                    Nom de l'entreprise *
                                </label>
                                <input type="text" class="form-control" id="nom_entreprise" name="nom_entreprise" 
                                       value="{{ config.nom_entreprise }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="slogan" class="form-label">
                                    <i class="fas fa-quote-left"></i>
                                    Slogan
                                </label>
                                <input type="text" class="form-control" id="slogan" name="slogan" 
                                       value="{{ config.slogan|default:'' }}">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Boutons d'action -->
                <div class="d-flex justify-content-between mb-4">
                    <button type="button" class="btn btn-warning" onclick="resetToDefaults()">
                        <i class="fas fa-undo"></i>
                        Réinitialiser aux valeurs par défaut
                    </button>
                    <div>
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times"></i>
                            Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Enregistrer la configuration
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des changements de fichiers
    const enteteInput = document.getElementById('entete_upload');
    const logoInput = document.getElementById('logo_upload');
    
    enteteInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            validateFile(file, 'entete');
        }
    });
    
    logoInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            validateFile(file, 'logo');
        }
    });
});

function validateFile(file, type) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('type', type);
    
    fetch('{% url "valider_fichier_upload" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.valid) {
            alert('Erreur de validation : ' + data.message);
            // Réinitialiser le champ
            if (type === 'entete') {
                document.getElementById('entete_upload').value = '';
            } else {
                document.getElementById('logo_upload').value = '';
            }
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
    });
}

function resetToDefaults() {
    if (confirm('Êtes-vous sûr de vouloir réinitialiser toutes les valeurs aux valeurs par défaut ?')) {
        // Réinitialiser les champs
        document.getElementById('nom_entreprise').value = 'GESTIMMOB';
        document.getElementById('slogan').value = '';
        document.getElementById('couleur_principale').value = '#2c3e50';
        document.getElementById('couleur_secondaire').value = '#3498db';
        // Ajouter d'autres champs selon besoin
    }
}
</script>
{% endblock %}
