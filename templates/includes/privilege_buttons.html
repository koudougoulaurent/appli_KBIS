{% load core_extras %}
{% comment %}
Template pour afficher les boutons de privilège (modifier, supprimer, désactiver)
pour les utilisateurs du groupe PRIVILEGE dans les listes d'éléments.
{% endcomment %}

{% if is_privilege_user and privilege_actions and privilege_actions|get_item:object.id %}
    <div class="privilege-actions-container" data-object-id="{{ object.id }}">
        <div class="btn-group privilege-btn-group" role="group" aria-label="Actions de privilège">
            {% for action in privilege_actions|get_item:object.id %}
                {% if action.type == 'edit' %}
                    <!-- Bouton Modifier -->
                    <a href="{{ action.url }}" 
                       class="btn btn-sm btn-{{ action.style }} {{ action.class }}"
                       title="{{ action.title }}"
                       data-bs-toggle="tooltip"
                       data-bs-placement="top">
                        <i class="bi bi-{{ action.icon }}"></i>
                        <span class="d-none d-sm-inline">Modifier</span>
                    </a>
                
                {% elif action.type == 'delete' %}
                    <!-- Bouton Supprimer -->
                    <button type="button"
                            class="btn btn-sm btn-{{ action.style }} {{ action.class }}"
                            title="{{ action.title }}"
                            data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            data-object-id="{{ action.data.object_id }}"
                            data-object-name="{{ action.data.object_name }}"
                            data-model-name="{{ action.data.model_name }}"
                            data-can-delete="{{ action.data.can_delete }}"
                            onclick="confirmPrivilegeDelete(this)">
                        <i class="bi bi-{{ action.icon }}"></i>
                        <span class="d-none d-sm-inline">Supprimer</span>
                    </button>
                
                {% elif action.type == 'disable' %}
                    <!-- Bouton Désactiver -->
                    <button type="button"
                            class="btn btn-sm btn-{{ action.style }} {{ action.class }}"
                            title="{{ action.title }}"
                            data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            data-object-id="{{ action.data.object_id }}"
                            data-object-name="{{ action.data.object_name }}"
                            data-model-name="{{ action.data.model_name }}"
                            data-can-delete="{{ action.data.can_delete }}"
                            {% if action.data.reason %}data-reason="{{ action.data.reason }}"{% endif %}
                            onclick="confirmPrivilegeDisable(this)">
                        <i class="bi bi-{{ action.icon }}"></i>
                        <span class="d-none d-sm-inline">Désactiver</span>
                    </button>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Indicateur de statut PRIVILEGE -->
        <div class="privilege-status-indicator">
            <small class="text-muted">
                <i class="bi bi-shield-check text-success"></i>
                Actions PRIVILEGE
            </small>
        </div>
    </div>
{% endif %}

<style>
.privilege-actions-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
}

.privilege-btn-group {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 6px;
    overflow: hidden;
}

.privilege-btn-group .btn {
    border: none;
    transition: all 0.2s ease;
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
}

.privilege-btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-edit-privilege:hover {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #000 !important;
}

.btn-delete-privilege:hover {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: #fff !important;
}

.btn-disable-privilege:hover {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: #fff !important;
}

.privilege-status-indicator {
    font-size: 0.7rem;
    opacity: 0.7;
}

.privilege-status-indicator .bi-shield-check {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .privilege-btn-group .btn span {
        display: none !important;
    }
    
    .privilege-btn-group .btn {
        padding: 0.375rem;
        min-width: 32px;
    }
    
    .privilege-status-indicator {
        display: none;
    }
}
</style>

<script>
// Fonction pour confirmer la suppression d'un élément
function confirmPrivilegeDelete(button) {
    const objectId = button.dataset.objectId;
    const objectName = button.dataset.objectName;
    const modelName = button.dataset.modelName;
    const canDelete = button.dataset.canDelete === 'true';
    
    if (!canDelete) {
        showPrivilegeAlert('warning', 'Suppression impossible', 
            'Cet élément ne peut pas être supprimé car il est référencé ailleurs.');
        return;
    }
    
    const confirmMessage = `Êtes-vous sûr de vouloir supprimer définitivement "${objectName}" ?\n\nCette action est irréversible et sera tracée dans l'audit.`;
    
    if (confirm(confirmMessage)) {
        performPrivilegeAction('delete', objectId, modelName, objectName);
    }
}

// Fonction pour confirmer la désactivation d'un élément
function confirmPrivilegeDisable(button) {
    const objectId = button.dataset.objectId;
    const objectName = button.dataset.objectName;
    const modelName = button.dataset.modelName;
    const reason = button.dataset.reason || 'référencé ailleurs';
    
    const confirmMessage = `Êtes-vous sûr de vouloir désactiver "${objectName}" ?\n\nRaison: ${reason}\n\nCette action sera tracée dans l'audit.`;
    
    if (confirm(confirmMessage)) {
        performPrivilegeAction('disable', objectId, modelName, objectName);
    }
}

// Fonction pour effectuer l'action de privilège
function performPrivilegeAction(actionType, objectId, modelName, objectName) {
    const button = document.querySelector(`[data-object-id="${objectId}"][data-model-name="${modelName}"]`);
    const originalContent = button.innerHTML;
    
    // Afficher un indicateur de chargement
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> <span class="d-none d-sm-inline">En cours...</span>';
    button.disabled = true;
    
    // Construire l'URL de l'action
    let actionUrl;
    if (actionType === 'delete') {
        actionUrl = `/utilisateurs/privilege/delete/${modelName}/${objectId}/`;
    } else if (actionType === 'disable') {
        actionUrl = `/utilisateurs/privilege/disable/${modelName}/${objectId}/`;
    }
    
    // Effectuer la requête AJAX
    fetch(actionUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: actionType,
            object_id: objectId,
            model_name: modelName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPrivilegeAlert('success', 'Action réussie', data.message);
            
            // Si c'est une suppression, masquer la ligne
            if (actionType === 'delete') {
                const row = button.closest('tr');
                row.style.opacity = '0.5';
                row.style.backgroundColor = '#f8f9fa';
                setTimeout(() => {
                    row.remove();
                }, 1000);
            }
            
            // Si c'est une désactivation, mettre à jour l'interface
            if (actionType === 'disable') {
                const row = button.closest('tr');
                row.style.opacity = '0.7';
                row.style.backgroundColor = '#f8f9fa';
                
                // Remplacer le bouton désactiver par un indicateur
                const actionsContainer = button.closest('.privilege-actions-container');
                actionsContainer.innerHTML = `
                    <div class="text-muted">
                        <i class="bi bi-pause-circle-fill text-secondary"></i>
                        <small>Désactivé</small>
                    </div>
                `;
            }
        } else {
            showPrivilegeAlert('error', 'Erreur', data.message);
            // Restaurer le bouton
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Erreur lors de l\'action de privilège:', error);
        showPrivilegeAlert('error', 'Erreur', 'Une erreur est survenue lors de l\'exécution de l\'action.');
        // Restaurer le bouton
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Fonction pour afficher les alertes de privilège
function showPrivilegeAlert(type, title, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 'alert-danger';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show privilege-alert" role="alert">
            <strong>${title}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Créer l'alerte
    const alertElement = document.createElement('div');
    alertElement.innerHTML = alertHtml;
    const alert = alertElement.firstElementChild;
    
    // Ajouter l'alerte en haut de la page
    const container = document.querySelector('.intelligent-list-container') || document.body;
    container.insertBefore(alert, container.firstChild);
    
    // Auto-fermeture après 5 secondes
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Fonction pour récupérer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialiser les tooltips Bootstrap
document.addEventListener('DOMContentLoaded', function() {
    if (typeof bootstrap !== 'undefined') {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
