{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Ajouter un Paiement - Contexte Intelligent{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .panneau-contexte {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        height: 100%;
    }
    
    .info-card {
        background: rgba(255,255,255,0.1);
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .info-card h6 {
        color: #fff;
        margin-bottom: 1rem;
        font-weight: 600;
        border-bottom: 2px solid rgba(255,255,255,0.3);
        padding-bottom: 0.5rem;
    }
    
    .info-card p {
        margin-bottom: 0.5rem;
        color: rgba(255,255,255,0.9);
    }
    
    .loading {
        text-align: center;
        padding: 3rem;
    }
    
    .spinner {
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .contexte-vide {
        text-align: center;
        padding: 3rem;
        color: rgba(255,255,255,0.8);
    }
    
    .contexte-vide .display-1 {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .badge {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
    }
    
    .suggestion-item {
        background: rgba(255,255,255,0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .suggestion-item:hover {
        background: rgba(255,255,255,0.2);
        transform: translateX(5px);
    }
    
    .historique-item {
        background: rgba(255,255,255,0.1);
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #4CAF50;
    }
    
    /* üîç Styles pour le syst√®me de recherche */
    .recherche-container {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .resultats-recherche {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: 400px;
        overflow-y: auto;
    }
    
    .resultat-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f8f9fa;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .resultat-item:hover {
        background-color: #f8f9fa;
    }
    
    .resultat-item:last-child {
        border-bottom: none;
    }
    
    .resultat-score {
        float: right;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    
    .resultat-locataire {
        font-weight: 600;
        color: #495057;
    }
    
    .resultat-details {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-plus-circle"></i> Ajouter un Paiement
                </h2>
                <a href="{% url 'paiements:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Retour au Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Formulaire de paiement -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-credit-card"></i> Formulaire de Paiement
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="form-paiement">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-12">
                                <!-- üîç SYST√àME DE RECHERCHE ULTRA-RAPIDE -->
                                <div class="recherche-container">
                                    <label for="recherche-contrat" class="form-label">
                                        <i class="bi bi-search"></i> Recherche Rapide de Contrat
                                    </label>
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control" 
                                               id="recherche-contrat" 
                                               placeholder="Num√©ro contrat, nom locataire, ID locataire, adresse..."
                                               autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="btn-recherche">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- üîç R√âSULTATS DE RECHERCHE -->
                                    <div id="resultats-recherche" class="resultats-recherche" style="display: none;">
                                        <div id="liste-resultats">
                                            <!-- Les r√©sultats s'afficheront ici -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.contrat|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.date_paiement|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.mois_paye|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.type_paiement|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.mode_paiement|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.montant|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.numero_cheque|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                {{ form.notes|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Enregistrer le Paiement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Panneau de contexte intelligent -->
        <div class="col-lg-6">
            <div class="panneau-contexte">
                <h4 class="mb-3">
                    <i class="bi bi-lightbulb"></i> Contexte Intelligent du Contrat
                    <span class="badge bg-success ms-2">
                        <i class="bi bi-check-circle"></i> Temps R√©el
                    </span>
                </h4>
                
                <!-- √âtat de chargement -->
                <div id="loading-contexte" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Chargement du contexte intelligent...</p>
                </div>
                
                <!-- Message d'instruction -->
                <div id="contexte-vide" class="contexte-vide">
                    <div class="text-center py-5">
                        <i class="bi bi-hand-index-thumb display-1 text-muted"></i>
                        <h5 class="text-muted mt-3">S√©lectionnez un contrat</h5>
                        <p class="text-muted">Le panneau intelligent s'affichera automatiquement avec toutes les informations</p>
                    </div>
                </div>
                
                <!-- Contenu du contexte (charg√© dynamiquement) -->
                <div id="contexte-contenu" style="display: none;">
                    <!-- Informations du contrat -->
                    <div class="info-card">
                        <h6><i class="bi bi-file-earmark-text"></i> Informations du Contrat</h6>
                        <div id="info-contrat"></div>
                    </div>
                    
                    <!-- Informations du locataire -->
                    <div class="info-card">
                        <h6><i class="bi bi-person"></i> Informations du Locataire</h6>
                        <div id="info-locataire"></div>
                    </div>
                    
                    <!-- Informations de la propri√©t√© -->
                    <div class="info-card">
                        <h6><i class="bi bi-house"></i> Informations de la Propri√©t√©</h6>
                        <div id="info-propriete"></div>
                    </div>
                    
                    <!-- Calculs automatiques en temps r√©el -->
                    <div class="info-card">
                        <h6><i class="bi bi-calculator"></i> Calculs Automatiques</h6>
                        <div id="calculs-automatiques"></div>
                    </div>
                    
                    <!-- Historique des paiements -->
                    <div class="info-card">
                        <h6><i class="bi bi-clock-history"></i> Historique des Paiements</h6>
                        <div id="historique-paiements"></div>
                    </div>
                    
                    <!-- Suggestions de paiement -->
                    <div class="info-card">
                        <h6><i class="bi bi-lightbulb"></i> Suggestions de Paiement</h6>
                        <div id="suggestions"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (doit √™tre charg√© en premier) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Select2 (apr√®s jQuery) -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/fr.js"></script>

<!-- Bootstrap JS (apr√®s jQuery) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Scripts personnalis√©s -->
<script>
$(document).ready(function() {
    console.log('üöÄ Syst√®me intelligent activ√© !');
    
    // D√©sactiver Select2 pour les champs select simples - Priorit√© aux options visibles
    // $('#id_contrat').select2({
    //     theme: 'bootstrap-5',
    //     language: 'fr',
    //     placeholder: 'Recherchez un contrat...',
    //     allowClear: true,
    //     minimumInputLength: 2,
    //     ajax: {
    //         url: '/paiements/api/recherche-rapide/',
    //         dataType: 'json',
    //         delay: 300,
    //         data: function (params) {
    //             return {
    //                 q: params.term
    //             };
    //         },
    //         processResults: function (data) {
    //             if (data.success && data.data.length > 0) {
    //                 return {
    //                     results: data.data.map(function(item) {
    //                         return {
    //                             id: item.id,
    //                             text: `${item.numero_contrat} - ${item.locataire_nom} (${item.propriete_adresse})`
    //                         };
    //                     })
    //                 };
    //             }
    //             return { 
    //                 results: [{
    //                     id: null,
    //                     text: 'Aucun contrat trouv√©'
    //                 }]
    //             };
    //         },
    //         cache: true
    //     }
    // });
    
    // S'assurer que le champ contrat affiche les options
    $('#id_contrat').css({
        'display': 'block',
        'visibility': 'visible',
        'opacity': '1'
    });
    
    // Activer le syst√®me de temps r√©el
    systemeTempsReel();
    
    // Activer le syst√®me de recherche ultra-rapide
    systemeRechercheUltraRapide();
    
    // Initialiser la date du jour
    $('#id_date_paiement').val(new Date().toISOString().split('T')[0]);
    
    // Afficher le message d'instruction au d√©but
    $('#loading-contexte').hide();
    $('#contexte-vide').show();
    $('#contexte-contenu').hide();
});

// üîç SYST√àME DE RECHERCHE ULTRA-RAPIDE
function systemeRechercheUltraRapide() {
    console.log('üîç Syst√®me de recherche ultra-rapide activ√©');
    
    let timeoutRecherche;
    const inputRecherche = $('#recherche-contrat');
    const resultatsContainer = $('#resultats-recherche');
    const listeResultats = $('#liste-resultats');
    
    // Recherche en temps r√©el pendant la saisie
    inputRecherche.on('input', function() {
        const query = $(this).val().trim();
        
        // Effacer le timeout pr√©c√©dent
        clearTimeout(timeoutRecherche);
        
        // Masquer les r√©sultats si la recherche est vide
        if (query.length < 2) {
            resultatsContainer.hide();
            return;
        }
        
        // Attendre 300ms apr√®s la fin de la saisie pour √©viter trop de requ√™tes
        timeoutRecherche = setTimeout(() => {
            effectuerRecherche(query);
        }, 300);
    });
    
    // Recherche au clic sur le bouton
    $('#btn-recherche').on('click', function() {
        const query = inputRecherche.val().trim();
        if (query.length >= 2) {
            effectuerRecherche(query);
        }
    });
    
    // Masquer les r√©sultats au clic ailleurs
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.recherche-container').length) {
            resultatsContainer.hide();
        }
    });
}

// Effectuer la recherche via l'API
function effectuerRecherche(query) {
    console.log('üîç Recherche en cours:', query);
    
    $.ajax({
        url: '/paiements/api/recherche-rapide/',
        method: 'GET',
        data: { q: query },
        success: function(response) {
            if (response.success) {
                afficherResultatsRecherche(response.data, query);
            } else {
                console.error('‚ùå Erreur recherche:', response.error);
                afficherErreurRecherche(response.error);
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Erreur r√©seau recherche:', error);
            afficherErreurRecherche('Erreur r√©seau lors de la recherche');
        }
    });
}

// Afficher les r√©sultats de recherche
function afficherResultatsRecherche(resultats, query) {
    const listeResultats = $('#liste-resultats');
    const resultatsContainer = $('#resultats-recherche');
    
    if (resultats.length === 0) {
        listeResultats.html(`
            <div class="resultat-item text-center text-muted">
                <i class="bi bi-search"></i> Aucun r√©sultat trouv√© pour "${query}"
            </div>
        `);
    } else {
        let html = '';
        resultats.forEach(resultat => {
            html += `
                <div class="resultat-item" onclick="selectionnerContratRecherche(${resultat.id})">
                    <span class="resultat-score">Score: ${resultat.score}</span>
                    <div class="resultat-locataire">
                        ${resultat.locataire_nom}
                    </div>
                    <div class="resultat-details">
                        <strong>Contrat:</strong> ${resultat.numero_contrat} | 
                        <strong>Propri√©t√©:</strong> ${resultat.propriete_adresse} | 
                        <strong>Loyer:</strong> ${Math.round(resultat.loyer).toLocaleString('fr-FR', {maximumFractionDigits: 0})} F CFA
                    </div>
                </div>
            `;
        });
        listeResultats.html(html);
    }
    
    resultatsContainer.show();
}

// S√©lectionner un contrat depuis la recherche
function selectionnerContratRecherche(contratId) {
    console.log('üéØ Contrat s√©lectionn√© depuis la recherche:', contratId);
    
    // S√©lectionner le contrat dans le menu d√©roulant
    $('#id_contrat').val(contratId).trigger('change');
    
    // Masquer les r√©sultats de recherche
    $('#resultats-recherche').hide();
    
    // Vider le champ de recherche
    $('#recherche-contrat').val('');
    
    // Charger le contexte intelligent
    chargerContexteIntelligent(contratId);
}

// Afficher une erreur de recherche
function afficherErreurRecherche(message) {
    $('#liste-resultats').html(`
        <div class="resultat-item text-center text-danger">
            <i class="bi bi-exclamation-triangle"></i> ${message}
        </div>
    `);
    $('#resultats-recherche').show();
}

// Syst√®me de temps r√©el pour le remplissage automatique
function systemeTempsReel() {
    console.log('üöÄ Syst√®me de temps r√©el activ√©');
    
    // Surveiller les changements de contrat en temps r√©el
    $('#id_contrat').on('change', function() {
        const contratId = $(this).val();
        console.log('üîÑ Contrat s√©lectionn√©:', contratId);
        if (contratId) {
            chargerContexteIntelligent(contratId);
        } else {
            reinitialiserContexte();
        }
    });
}

// Charger le contexte intelligent depuis l'API
function chargerContexteIntelligent(contratId) {
    console.log('üß† Chargement du contexte intelligent pour le contrat:', contratId);
    
    // Afficher le chargement
    $('#loading-contexte').show();
    $('#contexte-vide').hide();
    $('#contexte-contenu').hide();
    
    // Appeler l'API
    $.ajax({
                        url: `/paiements/api/contexte-intelligent/contrat/${contratId}/`,
        method: 'GET',
        success: function(response) {
            console.log('‚úÖ Donn√©es re√ßues:', response);
            // L'API renvoie directement les donn√©es, pas dans response.data
            if (response && response.contrat) {
                afficherContexteComplet(response);
                remplirChampsIntelligents(response);
            } else {
                console.error('‚ùå Erreur API:', response.error);
                afficherErreur(response.error || 'Erreur lors du chargement');
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Erreur r√©seau:', error);
            afficherErreur(`Erreur r√©seau: ${error}`);
        }
    });
}

// Afficher le contexte complet
function afficherContexteComplet(data) {
    console.log('üéØ Affichage du contexte complet:', data);
    
    // Informations du contrat
    $('#info-contrat').html(`
        <p><strong>Num√©ro:</strong> ${data.contrat.numero}</p>
        <p><strong>Date d√©but:</strong> ${data.contrat.date_debut || 'Non renseign√©'}</p>
        <p><strong>Date fin:</strong> ${data.contrat.date_fin || 'Non renseign√©'}</p>
        <p><strong>Loyer mensuel:</strong> ${Math.round(data.contrat.montant_loyer).toLocaleString('fr-FR', {maximumFractionDigits: 0})} F CFA</p>
        <p><strong>Charges mensuelles:</strong> ${Math.round(data.contrat.charges).toLocaleString('fr-FR', {maximumFractionDigits: 0})} F CFA</p>
    `);
    
    // Informations du locataire
    $('#info-locataire').html(`
        <p><strong>Nom:</strong> ${data.locataire.nom_complet}</p>
        <p><strong>T√©l√©phone:</strong> ${data.locataire.telephone || 'Non renseign√©'}</p>
        <p><strong>Email:</strong> ${data.locataire.email || 'Non renseign√©'}</p>
    `);
    
    // Informations de la propri√©t√©
    $('#info-propriete').html(`
        <p><strong>Adresse:</strong> ${data.propriete.adresse}</p>
        <p><strong>Titre:</strong> ${data.propriete.titre}</p>
        <p><strong>Type:</strong> ${data.propriete.type || 'Non renseign√©'}</p>
        <p><strong>Surface:</strong> ${data.propriete.surface || '0'} m¬≤</p>
    `);
    
    // Calculs automatiques
    let calculsHtml = `
        <p><strong>Loyer net:</strong> ${Math.round(data.net_a_payer).toLocaleString('fr-FR', {maximumFractionDigits: 0})} F CFA</p>
        <p><strong>Charges d√©ductibles:</strong> ${Math.round(data.total_charges).toLocaleString('fr-FR', {maximumFractionDigits: 0})} F CFA</p>
        <p><strong>Prochain mois:</strong> ${data.prochain_mois_paiement || 'Non d√©termin√©'}</p>
    `;
    
    // Ajouter des informations intelligentes pour premiers paiements
    if (data.est_premier_paiement) {
        calculsHtml += `
            <div class="alert alert-info mt-2">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Premier paiement d√©tect√© !</strong><br>
                <small>${data.mois_suggere}</small>
            </div>
        `;
    } else {
        calculsHtml += `
            <div class="alert alert-success mt-2">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Paiements ant√©rieurs trouv√©s</strong><br>
                <small>${data.mois_suggere}</small>
            </div>
        `;
    }
    
    $('#calculs-automatiques').html(calculsHtml);
    
    // Historique des paiements
    if (data.paiements_recents && data.paiements_recents.length > 0) {
        let historiqueHtml = '';
        data.paiements_recents.forEach(paiement => {
            const statutClass = paiement.statut === 'valide' ? 'success' : 'warning';
            historiqueHtml += `
                <div class="historique-item">
                    <div class="d-flex justify-content-between">
                        <span><strong>${paiement.date}</strong></span>
                        <span class="badge bg-${statutClass}">${paiement.statut}</span>
                    </div>
                    <div>${Math.round(paiement.montant).toLocaleString('fr-FR', {maximumFractionDigits: 0})} F CFA - ${paiement.type}</div>
                </div>
            `;
        });
        $('#historique-paiements').html(historiqueHtml);
    } else {
        // Premier paiement - afficher des informations utiles
        let premierPaiementHtml = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Premier paiement pour ce contrat</strong>
            </div>
            <div class="info-premier-paiement">
                <p><strong>üí° Conseils :</strong></p>
                <ul class="small">
                    <li>V√©rifiez que le montant correspond au loyer du contrat</li>
                    <li>Consid√©rez les charges mensuelles si applicable</li>
                    <li>Le mois sugg√©r√© est bas√© sur la date de d√©but du contrat</li>
                </ul>
            </div>
        `;
        $('#historique-paiements').html(premierPaiementHtml);
    }
    
    // Suggestions de paiement
    $('#suggestions').html('<p class="text-muted">Suggestions bas√©es sur le contrat s√©lectionn√©</p>');
    
    // Afficher le contenu
    $('#loading-contexte').hide();
    $('#contexte-contenu').show();
}

// Remplir les champs intelligemment
function remplirChampsIntelligents(data) {
    console.log('üí∞ Remplissage intelligent des champs:', data);
    
    // Montant sugg√©r√© (loyer net)
    $('#id_montant').val(data.calculs.loyer_net);
    
    // Date de paiement (aujourd'hui)
    const aujourdhui = new Date().toISOString().split('T')[0];
    $('#id_date_paiement').val(aujourdhui);
    
    // Type de paiement sugg√©r√©
    $('#id_type_paiement').val('loyer');
    
    // Mode de paiement sugg√©r√©
    $('#id_mode_paiement').val('virement');
    
    // R√©f√©rence de paiement intelligente
    const referenceIntelligente = `PAI-${data.contrat.numero_contrat}-${data.calculs.mois_paiement_suggere}`;
    $('#id_reference_paiement').val(referenceIntelligente);
    
    // Notes intelligentes
    const notesIntelligentes = `Paiement loyer ${data.calculs.mois_paiement_suggere} - Contrat ${data.contrat.numero_contrat}`;
    $('#id_notes').val(notesIntelligentes);
    
    console.log('‚úÖ Champs remplis intelligemment');
}

// Appliquer une suggestion
function appliquerSuggestion(type, valeur) {
    console.log('üí° Application de la suggestion:', type, valeur);
    
    switch(type) {
        case 'montant':
            $('#id_montant').val(valeur);
            break;
        case 'libelle':
            $('#id_notes').val(valeur);
            break;
        case 'mois':
            // Le mois est d√©j√† appliqu√© dans le remplissage intelligent
            break;
        default:
            console.log('Type de suggestion non reconnu:', type);
    }
    
    // Feedback visuel
    $(event.target).closest('.suggestion-item').addClass('bg-success');
    setTimeout(() => {
        $(event.target).closest('.suggestion-item').removeClass('bg-success');
    }, 1000);
}

// Afficher une erreur
function afficherErreur(message) {
    $('#loading-contexte').html(`
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Erreur: ${message}
        </div>
    `);
}

// R√©initialiser le contexte
function reinitialiserContexte() {
    $('#loading-contexte').hide();
    $('#contexte-vide').show();
    $('#contexte-contenu').hide();
}

// Validation des doublons de paiement
function verifierDoublonsPaiement() {
    const contratId = $('#id_contrat').val();
    const moisPaye = $('#id_mois_paye').val();
    
    if (contratId && moisPaye) {
        // Convertir le mois en format pour l'API
        const moisDate = new Date(moisPaye + '-01');
        const moisAnnee = moisDate.getFullYear();
        const moisMois = moisDate.getMonth() + 1;
        
        $.ajax({
            url: '/paiements/api/verifier-doublon/',
            method: 'GET',
            data: {
                contrat_id: contratId,
                mois: moisMois,
                annee: moisAnnee
            },
            success: function(response) {
                if (response.doublon_existe) {
                    // Afficher un message d'erreur
                    const messageErreur = `
                        <div class="alert alert-danger mt-2" id="erreur-doublon">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Paiement en doublon d√©tect√© !</strong><br>
                            Un paiement existe d√©j√† pour ce contrat au mois de ${response.mois_nom}.<br>
                            <small>Paiement existant: ${response.paiement_existant.reference} du ${response.paiement_existant.date} pour ${response.paiement_existant.montant} F CFA.</small>
                        </div>
                    `;
                    $('#id_mois_paye').closest('.mb-3').find('#erreur-doublon').remove();
                    $('#id_mois_paye').closest('.mb-3').append(messageErreur);
                    
                    // D√©sactiver le bouton de soumission
                    $('button[type="submit"]').prop('disabled', true).addClass('btn-secondary').removeClass('btn-primary');
                } else {
                    // Supprimer le message d'erreur s'il existe
                    $('#erreur-doublon').remove();
                    
                    // R√©activer le bouton de soumission
                    $('button[type="submit"]').prop('disabled', false).addClass('btn-primary').removeClass('btn-secondary');
                }
            },
            error: function() {
                console.log('Erreur lors de la v√©rification des doublons');
            }
        });
    } else {
        // Supprimer le message d'erreur s'il existe
        $('#erreur-doublon').remove();
        
        // R√©activer le bouton de soumission
        $('button[type="submit"]').prop('disabled', false).addClass('btn-primary').removeClass('btn-secondary');
    }
}

// √âcouter les changements sur les champs contrat et mois_paye
$('#id_contrat, #id_mois_paye').on('change', function() {
    verifierDoublonsPaiement();
});

console.log('üöÄ Syst√®me intelligent charg√© avec succ√®s !');
</script>
{% endblock %}