{% extends 'base.html' %}
{% load static %}
{% load core_extras %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .charges-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    .charge-item {
        background-color: white;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    .charge-item:last-child {
        margin-bottom: 0;
    }
    .charge-amount {
        color: #dc3545;
        font-weight: bold;
    }
    .charge-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .montant-summary {
        background-color: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    .montant-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    .montant-line:last-child {
        margin-bottom: 0;
        font-weight: bold;
        font-size: 1.1rem;
        border-top: 1px solid #b3d9ff;
        padding-top: 0.5rem;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="bi bi-plus-circle"></i> {{ title }}
                            {% if contrat_obj %}
                                - {{ contrat_obj.numero_contrat }}
                            {% endif %}
                        </h4>
                        <a href="{% url 'paiements:charges_deductibles_liste' %}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-receipt"></i> Gérer les charges déductibles
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    {% if contrat_obj %}
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle"></i> Informations du contrat</h5>
                        <p><strong>Contrat:</strong> {{ contrat_obj.numero_contrat }}</p>
                        <p><strong>Locataire:</strong> {{ contrat_obj.locataire.nom }} {{ contrat_obj.locataire.prenom }}</p>
                        <p><strong>Propriété:</strong> {{ contrat_obj.propriete.nom }}<br>
                        <span class="text-muted">Adresse: {{ contrat_obj.propriete.adresse }}</span></p>
                        {% if contrat_obj.unite_locative %}
                        <p><strong>Unité locative:</strong> {{ contrat_obj.unite_locative.nom }}<br>
                        <span class="text-muted">Type: {{ contrat_obj.unite_locative.type_unite }} | Surface: {{ contrat_obj.unite_locative.surface }} m²</span></p>
                        {% endif %}
                        <p><strong>Loyer total:</strong> {{ contrat_obj.get_loyer_total|currency_format }}</p>
                    </div>
                    {% endif %}
                    
                    <form method="post" id="paiement-form">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Informations de base du paiement -->
                            <div class="col-md-6">
                                <h5><i class="bi bi-credit-card"></i> Informations du paiement</h5>
                                
                                <div class="mb-3">
                                    <label for="{{ form.contrat.id_for_label }}" class="form-label">{{ form.contrat.label }}</label>
                                    {{ form.contrat }}
                                    {% if form.contrat.errors %}
                                        <div class="text-danger">{{ form.contrat.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.montant.id_for_label }}" class="form-label">{{ form.montant.label }}</label>
                                    <div class="input-group">
                                        {{ form.montant|add_class:'form-control'|attr:'readonly:true' }}
                                        <span class="input-group-text" style="background-color: #e9ecef; color: #495057; font-weight: bold; border: 2px solid #007bff;">F CFA</span>
                                    </div>

                                    {% if form.montant.errors %}
                                        <div class="text-danger">{{ form.montant.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.type_paiement.id_for_label }}" class="form-label">{{ form.type_paiement.label }}</label>
                                            {{ form.type_paiement }}
                                            {% if form.type_paiement.errors %}
                                                <div class="text-danger">{{ form.type_paiement.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.mode_paiement.id_for_label }}" class="form-label">{{ form.mode_paiement.label }}</label>
                                            {{ form.mode_paiement }}
                                            {% if form.mode_paiement.errors %}
                                                <div class="text-danger">{{ form.mode_paiement.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.date_paiement.id_for_label }}" class="form-label">{{ form.date_paiement.label }}</label>
                                    {{ form.date_paiement }}
                                    {% if form.date_paiement.errors %}
                                        <div class="text-danger">{{ form.date_paiement.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.numero_cheque.id_for_label }}" class="form-label">{{ form.numero_cheque.label }}</label>
                                    {{ form.numero_cheque }}
                                    {% if form.numero_cheque.errors %}
                                        <div class="text-danger">{{ form.numero_cheque.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.reference_virement.id_for_label }}" class="form-label">{{ form.reference_virement.label }}</label>
                                    {{ form.reference_virement }}
                                    {% if form.reference_virement.errors %}
                                        <div class="text-danger">{{ form.reference_virement.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="text-danger">{{ form.notes.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Section charges déductibles -->
                            <div class="col-md-6">
                                <h5><i class="bi bi-receipt"></i> Charges déductibles</h5>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        {{ form.appliquer_charges_deductibles }}
                                        <label class="form-check-label" for="{{ form.appliquer_charges_deductibles.id_for_label }}">
                                            {{ form.appliquer_charges_deductibles.label }}
                                        </label>
                                    </div>
                                    <small class="text-muted">Cochez cette option pour appliquer automatiquement toutes les charges validées.</small>
                                    {% if form.appliquer_charges_deductibles.errors %}
                                        <div class="text-danger">{{ form.appliquer_charges_deductibles.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div id="charges-section" class="charges-section">
                                    <h6><i class="bi bi-list-check"></i> {{ form.charges_deductibles.label }}</h6>
                                    
                                    {% if charges_disponibles %}
                                        <div id="charges-list">
                                            {% for charge in charges_disponibles %}
                                            <div class="charge-item">
                                                <div class="form-check">
                                                    <input class="form-check-input charge-checkbox" type="checkbox" 
                                                           name="charges_deductibles" value="{{ charge.id }}"
                                                           {% if charge in form.charges_deductibles.initial %}checked{% endif %}>
                                                    <label class="form-check-label">
                                                        <strong>{{ charge.libelle }}</strong>
                                                        <span class="charge-amount">- {{ charge.montant|currency_format }}</span>
                                                    </label>
                                                </div>
                                                <div class="charge-info">
                                                    <small>
                                                        {{ charge.get_type_charge_display }} • {{ charge.date_charge|date:"d/m/Y" }}
                                                        {% if charge.description %}
                                                        <br>{{ charge.description|truncatechars:80 }}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <!-- Résumé des montants -->
                                        <div id="montant-summary" class="montant-summary" style="display: none;">
                                            <h6><i class="bi bi-calculator"></i> Résumé du paiement</h6>
                                            <div class="montant-line">
                                                <span>Montant du loyer:</span>
                                                <span id="montant-brut" class="currency-display">0 F CFA</span>
                                            </div>
                                            <div class="montant-line">
                                                <span>Charges déduites:</span>
                                                <span id="total-charges" class="charge-amount currency-display">-0 F CFA</span>
                                            </div>
                                            <div class="montant-line">
                                                <span>Montant net à payer:</span>
                                                <span id="montant-net" class="currency-display">0 F CFA</span>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i> 
                                            Aucune charge déductible validée disponible pour ce contrat.
                                            <hr class="my-2">
                                            <div class="d-flex gap-2">
                                                <a href="{% url 'paiements:charge_deductible_ajouter' %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-plus-circle"></i> Créer une charge déductible
                                                </a>
                                                <a href="{% url 'paiements:charges_deductibles_liste' %}" class="btn btn-sm btn-outline-secondary">
                                                    <i class="bi bi-list"></i> Gérer les charges
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    {% if form.charges_deductibles.errors %}
                                        <div class="text-danger">{{ form.charges_deductibles.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Erreurs générales du formulaire -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <!-- Boutons d'action -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'paiements:liste' %}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left"></i> Retour
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Créer le paiement
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let montantLoyerContrat = null;
                    montantLoyerContrat = data.contrat ? data.contrat.montant_loyer : (data.net_a_payer || '');
                    montantInput.value = montantLoyerContrat;
                    montantInput.setAttribute('min', montantLoyerContrat);
                    montantInput.setAttribute('max', montantLoyerContrat);
    const contratSelect = document.getElementById('id_contrat');
    const montantInput = document.getElementById('id_montant');
    const appliquerChargesCheckbox = document.getElementById('appliquer_charges_deductibles');
    const chargesCheckboxes = document.querySelectorAll('.charge-checkbox');
    const montantSummary = document.getElementById('montant-summary');
    const montantBrutSpan = document.getElementById('montant-brut');
    const totalChargesSpan = document.getElementById('total-charges');
    const montantNetSpan = document.getElementById('montant-net');
    
    // Fonction pour charger les charges d'un contrat via AJAX
    function loadChargesDeductibles(contratId) {
        if (!contratId) return;
        
        fetch(`/paiements/api/charges-par-contrat/${contratId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                        montantInput.value = data.contrat ? data.contrat.montant_loyer : (data.net_a_payer || '');
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des charges:', error);
            });
    }
    
    // Fonction pour calculer et afficher le résumé
    // Validation du montant à la soumission
    const paiementForm = document.getElementById('paiement-form');
    if (paiementForm) {
        paiementForm.addEventListener('submit', function(e) {
            const montant = parseFloat(montantInput.value);
            if (montantLoyerContrat !== null && montant !== parseFloat(montantLoyerContrat)) {
                e.preventDefault();
                alert('Le montant doit être exactement égal au loyer mensuel du contrat sélectionné.');
                montantInput.focus();
            }
        });
    }
    function updateMontantSummary() {
        const montantBrut = parseFloat(montantInput.value) || 0;
        let totalCharges = 0;
        
        // Calculer le total des charges sélectionnées
        chargesCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                // Récupérer le montant depuis le DOM
                const chargeItem = checkbox.closest('.charge-item');
                const chargeAmountText = chargeItem.querySelector('.charge-amount').textContent;
                const montant = parseFloat(chargeAmountText.replace(/[^\d.]/g, '')) || 0;
                totalCharges += montant;
            }
        });
        
        const montantNet = montantBrut - totalCharges;
        
        // Mettre à jour l'affichage
                    montantBrutSpan.textContent = CurrencyFCFA.format(montantBrut);
            totalChargesSpan.textContent = '-' + CurrencyFCFA.format(totalCharges);
            montantNetSpan.textContent = CurrencyFCFA.format(montantNet);
        
        // Afficher/masquer le résumé
        if (totalCharges > 0) {
            montantSummary.style.display = 'block';
        } else {
            montantSummary.style.display = 'none';
        }
    }
    
    // Gérer le changement de contrat
    if (contratSelect) {
        contratSelect.addEventListener('change', function() {
            loadChargesDeductibles(this.value);
        });
    }
    
    // Gérer l'application automatique des charges
    if (appliquerChargesCheckbox) {
        appliquerChargesCheckbox.addEventListener('change', function() {
            chargesCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateMontantSummary();
        });
    }
    
    // Gérer les changements de sélection des charges
    chargesCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateMontantSummary();
            
            // Mettre à jour l'état de la case "appliquer automatiquement"
            const allChecked = Array.from(chargesCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(chargesCheckboxes).every(cb => !cb.checked);
            
            if (appliquerChargesCheckbox) {
                if (allChecked) {
                    appliquerChargesCheckbox.checked = true;
                    appliquerChargesCheckbox.indeterminate = false;
                } else if (noneChecked) {
                    appliquerChargesCheckbox.checked = false;
                    appliquerChargesCheckbox.indeterminate = false;
                } else {
                    appliquerChargesCheckbox.indeterminate = true;
                }
            }
        });
    });
    
    // Gérer les changements du montant du loyer
    if (montantInput) {
        montantInput.addEventListener('input', updateMontantSummary);
    }
    
    // Initialiser l'affichage
    updateMontantSummary();
});
</script>
{% endblock %}