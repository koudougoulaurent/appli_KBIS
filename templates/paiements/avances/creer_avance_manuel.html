{% extends 'base.html' %}
{% load static %}

{% block title %}Créer une Avance de Loyer{% endblock %}

{% block extra_css %}
<style>
    .month-selector {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin: 20px 0;
    }
    
    .month-checkbox {
        display: none;
    }
    
    .month-label {
        display: block;
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .month-label:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .month-checkbox:checked + .month-label {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .year-selector {
        margin-bottom: 20px;
    }
    
    .mode-selection {
        margin-bottom: 30px;
    }
    
    .mode-selection .form-check {
        margin-bottom: 10px;
    }
    
    .month-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .selected-months {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
    }
    
    .selected-month {
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="bi bi-plus-circle me-2"></i>
                        Créer une Avance de Loyer
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" id="avanceForm">
                        {% csrf_token %}
                        
                        <!-- Mode de sélection des mois -->
                        <div class="mode-selection">
                            <h5>Mode de sélection des mois couverts</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode_selection_mois" 
                                       id="mode_automatique" value="automatique" checked>
                                <label class="form-check-label" for="mode_automatique">
                                    <strong>Calcul automatique</strong> - Le système calcule automatiquement les mois couverts
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode_selection_mois" 
                                       id="mode_manuel" value="manuel">
                                <label class="form-check-label" for="mode_manuel">
                                    <strong>Sélection manuelle</strong> - Choisissez manuellement les mois couverts
                                </label>
                            </div>
                        </div>
                        
                        <!-- Informations de base -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.contrat.id_for_label }}" class="form-label">Contrat *</label>
                                    {{ form.contrat }}
                                    {% if form.contrat.errors %}
                                        <div class="text-danger">{{ form.contrat.errors }}</div>
                                    {% endif %}
                                    <!-- Affichage du loyer mensuel -->
                                    <div id="loyer-mensuel-display" class="mt-2" style="display: none;">
                                        <div class="alert alert-info py-2">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Loyer mensuel :</strong> <span id="loyer-mensuel-montant">0</span> F CFA
                                        </div>
                                    </div>
                                    
                                    <!-- Avertissement avance existante -->
                                    <div id="avance-existante-warning" class="mt-2" style="display: none;">
                                        <div class="alert alert-warning py-3">
                                            <div class="d-flex align-items-start">
                                                <i class="bi bi-exclamation-triangle me-3 fs-4"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="alert-heading mb-2">⚠️ Avance(s) existante(s) détectée(s)</h6>
                                                    <div id="avance-existante-details" class="mb-3"></div>
                                                    <div class="d-flex gap-2">
                                                        <button type="button" class="btn btn-warning btn-sm" id="btn-continuer-avance">
                                                            <i class="bi bi-plus-circle me-1"></i>Continuer (Prolongation)
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-sm" id="btn-annuler-avance">
                                                            <i class="bi bi-x-circle me-1"></i>Annuler
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.montant_avance.id_for_label }}" class="form-label">Montant de l'avance (F CFA) *</label>
                                    {{ form.montant_avance }}
                                    {% if form.montant_avance.errors %}
                                        <div class="text-danger">{{ form.montant_avance.errors }}</div>
                                    {% endif %}
                                    <!-- Calculs automatiques -->
                                    <div id="calculs-automatiques" class="mt-2" style="display: none;">
                                        <div class="alert alert-success py-2">
                                            <i class="bi bi-calculator me-2"></i>
                                            <strong>Calcul automatique :</strong>
                                            <div class="mt-1">
                                                <span id="mois-couverts-calcul">0</span> mois couverts
                                                <span id="reste-calcul" class="ms-3"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.date_avance.id_for_label }}" class="form-label">Date de l'avance *</label>
                                    {{ form.date_avance }}
                                    {% if form.date_avance.errors %}
                                        <div class="text-danger">{{ form.date_avance.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="text-danger">{{ form.notes.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sélection manuelle des mois -->
                        <div id="selection-manuelle" style="display: none;">
                            <h5>Sélection des mois couverts</h5>
                            
                            <!-- Sélecteur d'année -->
                            <div class="year-selector">
                                <label for="annee-selection" class="form-label">Année :</label>
                                <select id="annee-selection" class="form-select" style="width: auto; display: inline-block;">
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                </select>
                            </div>
                            
                            <!-- Grille des mois -->
                            <div class="month-selector">
                                <input type="checkbox" class="month-checkbox" id="mois-01" value="01">
                                <label for="mois-01" class="month-label">Janvier</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-02" value="02">
                                <label for="mois-02" class="month-label">Février</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-03" value="03">
                                <label for="mois-03" class="month-label">Mars</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-04" value="04">
                                <label for="mois-04" class="month-label">Avril</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-05" value="05">
                                <label for="mois-05" class="month-label">Mai</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-06" value="06">
                                <label for="mois-06" class="month-label">Juin</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-07" value="07">
                                <label for="mois-07" class="month-label">Juillet</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-08" value="08">
                                <label for="mois-08" class="month-label">Août</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-09" value="09">
                                <label for="mois-09" class="month-label">Septembre</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-10" value="10">
                                <label for="mois-10" class="month-label">Octobre</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-11" value="11">
                                <label for="mois-11" class="month-label">Novembre</label>
                                
                                <input type="checkbox" class="month-checkbox" id="mois-12" value="12">
                                <label for="mois-12" class="month-label">Décembre</label>
                            </div>
                            
                            <!-- Informations sur la sélection -->
                            <div class="month-info">
                                <h6>Mois sélectionnés :</h6>
                                <div id="selected-months-display" class="selected-months">
                                    Aucun mois sélectionné
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        Montant requis : <span id="montant-requis">0</span> F CFA
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Champ caché pour les mois sélectionnés -->
                        <input type="hidden" name="mois_couverts_manuels" id="mois-couverts-manuels">
                        
                        <!-- Boutons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'paiements:avances:liste_avances' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Retour à la liste
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Créer l'avance
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modeAutomatique = document.getElementById('mode_automatique');
    const modeManuel = document.getElementById('mode_manuel');
    const selectionManuelle = document.getElementById('selection-manuelle');
    const moisCheckboxes = document.querySelectorAll('.month-checkbox');
    const anneeSelection = document.getElementById('annee-selection');
    const selectedMonthsDisplay = document.getElementById('selected-months-display');
    const montantRequis = document.getElementById('montant-requis');
    const moisCouvertsManuels = document.getElementById('mois-couverts-manuels');
    const montantAvance = document.getElementById('id_montant_avance');
    const contratSelect = document.getElementById('id_contrat_avance');
    
    // Gestion du mode de sélection
    function toggleModeSelection() {
        if (modeManuel.checked) {
            selectionManuelle.style.display = 'block';
        } else {
            selectionManuelle.style.display = 'none';
        }
    }
    
    modeAutomatique.addEventListener('change', toggleModeSelection);
    modeManuel.addEventListener('change', toggleModeSelection);
    
    // Gestion de la sélection des mois
    function updateSelectedMonths() {
        const selectedMonths = [];
        const annee = anneeSelection.value;
        
        moisCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const mois = checkbox.value;
                const date = `${annee}-${mois}-01`;
                selectedMonths.push(date);
            }
        });
        
        // Mettre à jour l'affichage
        if (selectedMonths.length === 0) {
            selectedMonthsDisplay.innerHTML = 'Aucun mois sélectionné';
        } else {
            selectedMonthsDisplay.innerHTML = selectedMonths.map(date => {
                const mois = new Date(date).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                return `<span class="selected-month">${mois}</span>`;
            }).join('');
        }
        
        // Mettre à jour le champ caché
        moisCouvertsManuels.value = JSON.stringify(selectedMonths);
        
        // Calculer le montant requis
        updateMontantRequis();
    }
    
    function updateMontantRequis() {
        const selectedMonths = JSON.parse(moisCouvertsManuels.value || '[]');
        const loyerMensuel = getLoyerMensuel();
        
        if (loyerMensuel > 0) {
            const montant = loyerMensuel * selectedMonths.length;
            montantRequis.textContent = montant.toLocaleString('fr-FR');
        } else {
            montantRequis.textContent = '0';
        }
    }
    
    function getLoyerMensuel() {
        const contratId = contratSelect.value;
        if (!contratId) return 0;
        
        // Récupérer le loyer mensuel via AJAX
        fetch(`/paiements/avances/contrat-details-ajax/?contrat_id=${contratId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.loyer_mensuel) {
                    // Afficher le loyer mensuel
                    const loyerDisplay = document.getElementById('loyer-mensuel-display');
                    const loyerMontant = document.getElementById('loyer-mensuel-montant');
                    loyerMontant.textContent = parseFloat(data.loyer_mensuel).toLocaleString('fr-FR');
                    loyerDisplay.style.display = 'block';
                    
                    // Vérifier les avances existantes seulement si la vérification n'est pas désactivée
                    if (!window.verificationAvancesDesactivee) {
                        if (data.avances_existantes && data.avances_existantes.has_avances) {
                            afficherAvertissementAvanceExistante(data.avances_existantes);
                        } else {
                            masquerAvertissementAvanceExistante();
                        }
                    } else {
                        console.log('🔍 Vérification d\'avances désactivée - Avertissement ignoré');
                    }
                    
                    // Mettre à jour les calculs
                    updateMontantRequis();
                    updateCalculsAutomatiques();
                }
            })
            .catch(error => console.error('Erreur:', error));
        
        return 0; // Valeur par défaut
    }
    
    function afficherAvertissementAvanceExistante(avancesInfo) {
        const warningDiv = document.getElementById('avance-existante-warning');
        const detailsDiv = document.getElementById('avance-existante-details');
        
        // Construire le message détaillé
        let message = `<p class="mb-2">${avancesInfo.message}</p>`;
        
        if (avancesInfo.avances && avancesInfo.avances.length > 0) {
            message += '<div class="small">';
            message += '<strong>Détails des avances :</strong><br>';
            avancesInfo.avances.forEach((avance, index) => {
                message += `• Avance ${index + 1}: ${parseFloat(avance.montant_avance).toLocaleString('fr-FR')} F CFA `;
                message += `(${avance.nombre_mois_couverts} mois) - Restant: ${parseFloat(avance.montant_restant).toLocaleString('fr-FR')} F CFA<br>`;
            });
            message += '</div>';
        }
        
        detailsDiv.innerHTML = message;
        warningDiv.style.display = 'block';
        
        // Les boutons sont déjà configurés, pas besoin de reconfigurer
        console.log('✅ Avertissement affiché, boutons déjà configurés');
    }
    
    function masquerAvertissementAvanceExistante() {
        const warningDiv = document.getElementById('avance-existante-warning');
        warningDiv.style.display = 'none';
    }
    
    function updateCalculsAutomatiques() {
        const montantAvance = parseFloat(document.getElementById('id_montant_avance').value) || 0;
        const loyerMensuel = parseFloat(document.getElementById('loyer-mensuel-montant').textContent.replace(/\s/g, '')) || 0;
        
        if (montantAvance > 0 && loyerMensuel > 0) {
            const moisCouverts = Math.floor(montantAvance / loyerMensuel);
            const reste = montantAvance % loyerMensuel;
            
            const calculsDisplay = document.getElementById('calculs-automatiques');
            const moisCouvertsCalcul = document.getElementById('mois-couverts-calcul');
            const resteCalcul = document.getElementById('reste-calcul');
            
            moisCouvertsCalcul.textContent = moisCouverts;
            
            if (reste > 0) {
                resteCalcul.innerHTML = `<span class="text-warning">(Reste: ${reste.toLocaleString('fr-FR')} F CFA)</span>`;
            } else {
                resteCalcul.innerHTML = '<span class="text-success">(Montant exact)</span>';
            }
            
            calculsDisplay.style.display = 'block';
        } else {
            document.getElementById('calculs-automatiques').style.display = 'none';
        }
    }
    
    // Événements
    moisCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedMonths);
    });
    
    anneeSelection.addEventListener('change', updateSelectedMonths);
    contratSelect.addEventListener('change', function() {
        updateMontantRequis();
        getLoyerMensuel(); // Récupérer le loyer et déclencher les calculs
    });
    montantAvance.addEventListener('input', function() {
        updateMontantRequis();
        updateCalculsAutomatiques(); // Déclencher les calculs automatiques
    });
    
    // Variables pour éviter la reconfiguration en boucle
    let boutonsConfigures = false;
    
    // Fonction pour configurer les boutons d'avertissement
    function configurerBoutonsAvertissement() {
        if (boutonsConfigures) {
            console.log('🔍 Boutons déjà configurés, évitement de la reconfiguration');
            return;
        }
        
        const btnContinuer = document.getElementById('btn-continuer-avance');
        const btnAnnuler = document.getElementById('btn-annuler-avance');
        
        if (btnContinuer && !btnContinuer.hasAttribute('data-event-added')) {
            btnContinuer.addEventListener('click', handleContinuerClick);
            btnContinuer.setAttribute('data-event-added', 'true');
            console.log('✅ Bouton Continuer configuré');
        }
        
        if (btnAnnuler && !btnAnnuler.hasAttribute('data-event-added')) {
            btnAnnuler.addEventListener('click', handleAnnulerClick);
            btnAnnuler.setAttribute('data-event-added', 'true');
            console.log('✅ Bouton Annuler configuré');
        }
        
        if (btnContinuer && btnAnnuler) {
            boutonsConfigures = true;
        }
    }
    
    // Fonction pour gérer le clic sur Continuer
    function handleContinuerClick(event) {
        console.log('✅ Bouton Continuer cliqué - Action en cours...');
        event.preventDefault();
        event.stopPropagation();
        
        try {
            // Désactiver temporairement la vérification d'avances existantes
            window.verificationAvancesDesactivee = true;
            console.log('✅ Vérification d\'avances désactivée');
            
            // Masquer l'avertissement et permettre la création
            masquerAvertissementAvanceExistante();
            console.log('✅ Avertissement masqué');
            
            // Ajouter une note dans le formulaire
            const notesField = document.getElementById('id_notes');
            if (notesField) {
                const noteProlongation = '\n\n[PROLONGATION] - Avance supplémentaire ajoutée à une avance existante.';
                notesField.value = (notesField.value + noteProlongation).trim();
                console.log('✅ Note de prolongation ajoutée');
            }
            
            // Afficher un message de confirmation clair
            afficherMessageConfirmationProlongation();
            
            console.log('✅ Action Continuer terminée avec succès');
        } catch (error) {
            console.error('❌ Erreur lors de l\'action Continuer:', error);
        }
    }
    
    // Fonction pour afficher un message de confirmation clair
    function afficherMessageConfirmationProlongation() {
        // Créer un message de confirmation temporaire
        const confirmationDiv = document.createElement('div');
        confirmationDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        confirmationDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        confirmationDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-3 fs-4"></i>
                <div>
                    <h6 class="alert-heading mb-1">✅ Prolongation activée</h6>
                    <p class="mb-0">Vous pouvez maintenant créer l'avance de prolongation. La note de prolongation a été ajoutée.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Ajouter le message au body
        document.body.appendChild(confirmationDiv);
        
        // Supprimer automatiquement après 5 secondes
        setTimeout(() => {
            if (confirmationDiv.parentNode) {
                confirmationDiv.parentNode.removeChild(confirmationDiv);
            }
        }, 5000);
        
        console.log('✅ Message de confirmation affiché');
    }
    
    // Fonction pour gérer le clic sur Annuler
    function handleAnnulerClick(event) {
        console.log('✅ Bouton Annuler cliqué - Action en cours...');
        event.preventDefault();
        event.stopPropagation();
        
        try {
            // Réactiver la vérification d'avances existantes
            window.verificationAvancesDesactivee = false;
            console.log('✅ Vérification d\'avances réactivée');
            
            // Réinitialiser le formulaire
            if (contratSelect) {
                contratSelect.value = '';
                console.log('✅ Contrat réinitialisé');
            }
            
            masquerAvertissementAvanceExistante();
            
            const loyerDisplay = document.getElementById('loyer-mensuel-display');
            if (loyerDisplay) {
                loyerDisplay.style.display = 'none';
                console.log('✅ Affichage loyer masqué');
            }
            
            const calculsDisplay = document.getElementById('calculs-automatiques');
            if (calculsDisplay) {
                calculsDisplay.style.display = 'none';
                console.log('✅ Calculs automatiques masqués');
            }
            
            if (montantAvance) {
                montantAvance.value = '';
                console.log('✅ Montant avance réinitialisé');
            }
            
            const notesField = document.getElementById('id_notes');
            if (notesField) {
                notesField.value = '';
                console.log('✅ Notes réinitialisées');
            }
            
            console.log('✅ Formulaire réinitialisé avec succès');
        } catch (error) {
            console.error('❌ Erreur lors de l\'action Annuler:', error);
        }
    }
    
    // Vérifier l'existence des boutons d'avertissement
    function verifierBoutonsAvertissement() {
        const btnContinuer = document.getElementById('btn-continuer-avance');
        const btnAnnuler = document.getElementById('btn-annuler-avance');
        
        console.log('🔍 Vérification des boutons d\'avertissement:');
        console.log('🔍 Bouton Continuer trouvé:', btnContinuer ? 'OUI' : 'NON');
        console.log('🔍 Bouton Annuler trouvé:', btnAnnuler ? 'OUI' : 'NON');
        
        if (btnContinuer) {
            console.log('🔍 Bouton Continuer - Classes:', btnContinuer.className);
            console.log('🔍 Bouton Continuer - Texte:', btnContinuer.textContent);
        }
        
        if (btnAnnuler) {
            console.log('🔍 Bouton Annuler - Classes:', btnAnnuler.className);
            console.log('🔍 Bouton Annuler - Texte:', btnAnnuler.textContent);
        }
    }
    
    // Initialisation
    toggleModeSelection();
    updateSelectedMonths();
    
    // Configurer les boutons d'avertissement au chargement
    configurerBoutonsAvertissement();
    
    // Vérifier les boutons après un délai pour s'assurer qu'ils sont chargés
    setTimeout(() => {
        verifierBoutonsAvertissement();
        // Ne pas reconfigurer si déjà fait
        if (!boutonsConfigures) {
            configurerBoutonsAvertissement();
        }
    }, 1000);
});
</script>
{% endblock %}
