{% extends 'base.html' %}
{% load static %}

{% block title %}Monitoring des Avances - KBIS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/avances.css' %}">
<style>
    .monitoring-card {
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        background: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    
    .monitoring-card:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .stat-card.critique {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .stat-card.avancee {
        background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
    }
    
    .stat-card.normale {
        background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
    }
    
    .stat-card.epuisee {
        background: linear-gradient(135deg, #a8a8a8 0%, #d3d3d3 100%);
    }
    
    .progression-bar {
        height: 20px;
        border-radius: 10px;
        background: #f0f0f0;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .progression-fill {
        height: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        transition: width 0.5s ease;
        border-radius: 10px;
    }
    
    .progression-fill.critique {
        background: linear-gradient(90deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .progression-fill.avancee {
        background: linear-gradient(90deg, #feca57 0%, #ff9ff3 100%);
    }
    
    .progression-fill.epuisee {
        background: linear-gradient(90deg, #a8a8a8 0%, #d3d3d3 100%);
    }
    
    .alert-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #ff4757;
        color: white;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .action-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        margin: 0.25rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn-sync {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .btn-alert {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
    }
    
    .btn-report {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }
    
    .avance-item {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        background: white;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .avance-item:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .avance-item.critique {
        border-left: 5px solid #ff6b6b;
    }
    
    .avance-item.avancee {
        border-left: 5px solid #feca57;
    }
    
    .avance-item.normale {
        border-left: 5px solid #48dbfb;
    }
    
    .avance-item.epuisee {
        border-left: 5px solid #a8a8a8;
    }
</style>
{% endblock %}

{% block content %}
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-graph-up text-primary"></i>
                        Monitoring des Avances de Loyer
                    </h1>
                    <p class="text-muted mb-0">Supervision automatique de la progression des avances</p>
                </div>
                <div>
                    <button class="action-btn btn-sync" onclick="synchroniserAvances()">
                        <i class="bi bi-arrow-clockwise"></i> Synchroniser
                    </button>
                    <button class="action-btn btn-alert" onclick="envoyerAlertes()">
                        <i class="bi bi-bell"></i> Envoyer Alertes
                    </button>
                    <button class="action-btn btn-report" onclick="genererRapport()">
                        <i class="bi bi-file-text"></i> Rapport
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if erreur %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                {{ erreur }}
            </div>
        </div>
    </div>
    {% endif %}

    {% if rapport and not rapport.erreur %}
    <!-- Statistiques globales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <h3>{{ rapport.total_avances }}</h3>
                <p class="mb-0">Total Avances</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card {% if rapport.avances_critiques > 0 %}critique{% else %}normale{% endif %}">
                <h3>{{ rapport.avances_critiques }}</h3>
                <p class="mb-0">Critiques</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card {% if rapport.avances_actives > 0 %}avancee{% else %}epuisee{% endif %}">
                <h3>{{ rapport.avances_actives }}</h3>
                <p class="mb-0">Actives</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card {% if rapport.avances_epuisees > 0 %}epuisee{% else %}normale{% endif %}">
                <h3>{{ rapport.avances_epuisees }}</h3>
                <p class="mb-0">Épuisées</p>
            </div>
        </div>
    </div>

    <!-- Progression globale -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="monitoring-card">
                <h4 class="mb-3">
                    <i class="bi bi-pie-chart text-primary"></i>
                    Progression Globale des Avances
                </h4>
                <div class="progression-bar">
                    <div class="progression-fill" style="width: {{ rapport.pourcentage_consomme|floatformat:1 }}%"></div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <strong>Montant Total:</strong> {{ rapport.montant_total_avances|floatformat:0 }} F CFA
                    </div>
                    <div class="col-md-4">
                        <strong>Consommé:</strong> {{ rapport.montant_consomme_total|floatformat:0 }} F CFA
                    </div>
                    <div class="col-md-4">
                        <strong>Restant:</strong> {{ rapport.montant_restant_total|floatformat:0 }} F CFA
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>Progression Moyenne:</strong> {{ rapport.progression_moyenne|floatformat:1 }}%
                    </div>
                    <div class="col-md-6">
                        <strong>Contrats avec Avances:</strong> {{ stats_supplementaires.total_contrats_avec_avances }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Avances critiques -->
    {% if avances_critiques %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="monitoring-card">
                <h4 class="mb-3 text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Avances Critiques ({{ avances_critiques|length }})
                </h4>
                {% for alerte in avances_critiques %}
                <div class="avance-item critique">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ alerte.avance.contrat.locataire.get_nom_complet }}</h6>
                            <p class="text-muted mb-0">Contrat: {{ alerte.avance.contrat.numero_contrat }}</p>
                            <small class="text-danger">{{ alerte.message }}</small>
                        </div>
                        <div class="col-md-3">
                            <div class="progression-bar">
                                <div class="progression-fill critique" style="width: {{ alerte.progression|floatformat:1 }}%"></div>
                            </div>
                            <small class="text-muted">{{ alerte.progression|floatformat:1 }}% consommé</small>
                        </div>
                        <div class="col-md-3">
                            <strong>Restant:</strong> {{ alerte.avance.montant_restant|floatformat:0 }} F CFA<br>
                            <small class="text-muted">Type: {{ alerte.type_alerte }}</small>
                        </div>
                        <div class="col-md-2 text-end">
                            <a href="/paiements/avances/progression/{{ alerte.avance.id }}/" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i> Détails
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Toutes les avances -->
    <div class="row">
        <div class="col-12">
            <div class="monitoring-card">
                <h4 class="mb-3">
                    <i class="bi bi-list-check text-primary"></i>
                    Toutes les Avances ({{ toutes_avances|length }})
                </h4>
                {% if toutes_avances %}
                    {% for avance in toutes_avances %}
                    {% with progression=avance|add:0 %}
                    <div class="avance-item {% if avance.statut == 'epuisee' %}epuisee{% elif avance.statut == 'active' %}normale{% else %}critique{% endif %}">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-1">{{ avance.contrat.locataire.get_nom_complet }}</h6>
                                <p class="text-muted mb-0">Contrat: {{ avance.contrat.numero_contrat }}</p>
                                <small class="text-muted">Créée le: {{ avance.date_avance|date:"d/m/Y" }}</small>
                            </div>
                            <div class="col-md-2">
                                <strong>Montant:</strong><br>
                                <span class="text-primary">{{ avance.montant_avance|floatformat:0 }} F CFA</span><br>
                                <small class="text-muted">{{ avance.nombre_mois_couverts }} mois</small>
                            </div>
                            <div class="col-md-3">
                                <div class="progression-bar">
                                    {% widthratio avance.montant_avance|add:avance.montant_restant avance.montant_avance 100 as progression_pct %}
                                    <div class="progression-fill {% if avance.statut == 'epuisee' %}epuisee{% elif avance.statut == 'active' %}normale{% else %}critique{% endif %}" style="width: {{ progression_pct|floatformat:1 }}%"></div>
                                </div>
                                <small class="text-muted">Statut: {{ avance.get_statut_display }}</small>
                            </div>
                            <div class="col-md-2">
                                <strong>Restant:</strong><br>
                                <span class="text-success">{{ avance.montant_restant|floatformat:0 }} F CFA</span><br>
                                <small class="text-muted">Loyer: {{ avance.loyer_mensuel|floatformat:0 }} F CFA/mois</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <a href="/paiements/avances/progression/{{ avance.id }}/" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> Détails
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-house-add display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">Aucune avance trouvée</h4>
                        <p class="text-muted">Commencez par ajouter une avance de loyer</p>
                        <a href="/paiements/ajouter/" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Ajouter une avance
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function synchroniserAvances() {
        // Afficher un indicateur de chargement
        const syncBtn = document.querySelector('button[onclick="synchroniserAvances()"]');
        const originalText = syncBtn.innerHTML;
        syncBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Synchronisation...';
        syncBtn.disabled = true;
        
        fetch('/paiements/avances/synchroniser-ajax/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const message = data.message || 'Synchronisation réussie !';
                const totalSync = data.total_synchronise || 0;
                alert(`${message}\n\n${totalSync} mois d'avance synchronisés.`);
                location.reload();
            } else {
                alert('Erreur: ' + (data.message || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('Erreur détaillée:', error);
            alert('Erreur lors de la synchronisation: ' + error.message);
        })
        .finally(() => {
            // Restaurer le bouton
            syncBtn.innerHTML = originalText;
            syncBtn.disabled = false;
        });
    }

    function envoyerAlertes() {
        fetch('/paiements/avances/envoyer-alertes/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Alertes envoyées !');
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'envoi des alertes');
        });
    }

    function genererRapport() {
        // Afficher un indicateur de chargement
        const rapportBtn = document.querySelector('button[onclick="genererRapport()"]');
        const originalText = rapportBtn.innerHTML;
        rapportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Génération...';
        rapportBtn.disabled = true;
        
        fetch('/paiements/avances/rapport-progression-ajax/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Afficher le rapport dans une nouvelle fenêtre
                const rapportWindow = window.open('', '_blank');
                rapportWindow.document.write(`
                    <html>
                        <head>
                            <title>Rapport de Progression des Avances</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                h1 { color: #333; }
                                .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
                                .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; }
                                .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
                                .stat-label { color: #666; margin-top: 5px; }
                            </style>
                        </head>
                        <body>
                            <h1>📊 Rapport de Progression des Avances</h1>
                            <p><strong>Généré le:</strong> ${new Date().toLocaleString()}</p>
                            
                            <div class="stats">
                                <div class="stat-card">
                                    <div class="stat-value">${data.rapport.total_avances || 0}</div>
                                    <div class="stat-label">Total Avances</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${data.rapport.avances_actives || 0}</div>
                                    <div class="stat-label">Avances Actives</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${data.rapport.avances_epuisees || 0}</div>
                                    <div class="stat-label">Avances Épuisées</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${(data.rapport.montant_total_avances || 0).toLocaleString()} F CFA</div>
                                    <div class="stat-label">Montant Total</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${(data.rapport.montant_restant_total || 0).toLocaleString()} F CFA</div>
                                    <div class="stat-label">Montant Restant</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${(data.rapport.progression_moyenne || 0).toFixed(1)}%</div>
                                    <div class="stat-label">Progression Moyenne</div>
                                </div>
                            </div>
                            
                            <h2>Détails Techniques</h2>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(data.rapport, null, 2)}</pre>
                        </body>
                    </html>
                `);
                rapportWindow.document.close();
            } else {
                alert('Erreur: ' + (data.message || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('Erreur détaillée:', error);
            alert('Erreur lors de la génération du rapport: ' + error.message);
        })
        .finally(() => {
            // Restaurer le bouton
            rapportBtn.innerHTML = originalText;
            rapportBtn.disabled = false;
        });
    }

    // Auto-refresh toutes les 5 minutes
    setInterval(function() {
        location.reload();
    }, 300000);
</script>
{% endblock %}



