{% extends 'base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ page_title }} - Gestion Immobilière{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-{{ page_icon }} text-success"></i>
        {{ page_title }}
    </h1>
    <div class="btn-group" role="group">
        <a href="{% url 'paiements:detail_recap_mensuel_auto' recap_id=recap.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Retour au Récapitulatif
        </a>
    </div>
</div>

<!-- Informations du récapitulatif -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="card-title mb-0">
            <i class="bi bi-info-circle"></i>
            Informations du Récapitulatif
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Bailleur :</strong></td>
                        <td>{{ bailleur.get_nom_complet }}</td>
                    </tr>
                    <tr>
                        <td><strong>Mois :</strong></td>
                        <td>{{ recap.mois_recap|date:"F Y" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Statut :</strong></td>
                        <td>
                            <span class="badge bg-success">{{ recap.get_statut_display }}</span>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Loyers Bruts :</strong></td>
                        <td class="text-end">{{ recap.total_loyers_bruts|floatformat:0|intcomma }} F CFA</td>
                    </tr>
                    <tr>
                        <td><strong>Charges Déductibles :</strong></td>
                        <td class="text-end">{{ recap.total_charges_deductibles|floatformat:0|intcomma }} F CFA</td>
                    </tr>
                    <tr class="table-success">
                        <td><strong>Net à Payer :</strong></td>
                        <td class="text-end fw-bold">{{ recap.total_net_a_payer|floatformat:0|intcomma }} F CFA</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Formulaire de création du retrait -->
<div class="card">
    <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
            <i class="bi bi-cash-coin"></i>
            Créer le Retrait
        </h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="mode_retrait" class="form-label">
                            <i class="bi bi-credit-card me-1"></i>
                            Mode de Retrait
                        </label>
                        <select name="mode_retrait" id="mode_retrait" class="form-select" required>
                            <option value="">-- Sélectionner un mode --</option>
                            <option value="virement" selected>Virement bancaire</option>
                            <option value="cheque">Chèque</option>
                            <option value="especes">Espèces</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="reference_retrait" class="form-label">
                            <i class="bi bi-hash me-1"></i>
                            Référence
                        </label>
                        <input type="text" name="reference_retrait" id="reference_retrait" 
                               class="form-control" placeholder="Référence du retrait (optionnel)">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="observations" class="form-label">
                    <i class="bi bi-chat-text me-1"></i>
                    Observations
                </label>
                <textarea name="observations" id="observations" class="form-control" rows="3" 
                          placeholder="Observations sur ce retrait...">{{ recap.mois_recap|date:"F Y" }} - Retrait basé sur le récapitulatif mensuel</textarea>
            </div>
            
            <!-- Résumé du retrait -->
            <div class="alert alert-success">
                <h6 class="alert-heading">
                    <i class="bi bi-check-circle me-2"></i>
                    Résumé du Retrait
                </h6>
                <div class="row">
                    <div class="col-md-4">
                        <strong>Bailleur :</strong><br>
                        {{ bailleur.get_nom_complet }}
                    </div>
                    <div class="col-md-4">
                        <strong>Mois :</strong><br>
                        {{ recap.mois_recap|date:"F Y" }}
                    </div>
                    <div class="col-md-4">
                        <strong>Montant :</strong><br>
                        <span class="h5 text-success">{{ recap.total_net_a_payer|floatformat:0|intcomma }} F CFA</span>
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-cash-coin me-2"></i>
                    Créer le Retrait
                </button>
                <a href="{% url 'paiements:detail_recap_mensuel_auto' recap_id=recap.id %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-2"></i>
                    Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Informations sur le processus -->
<div class="card mt-4">
    <div class="card-header bg-light">
        <h6 class="card-title mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Informations sur le Processus
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Ce qui va se passer :</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check text-success me-2"></i>Un retrait sera créé avec les montants du récapitulatif</li>
                    <li><i class="bi bi-check text-success me-2"></i>Le statut du récapitulatif passera à "Payé"</li>
                    <li><i class="bi bi-check text-success me-2"></i>Le retrait sera lié au récapitulatif</li>
                    <li><i class="bi bi-check text-success me-2"></i>Vous pourrez suivre le processus de paiement</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Étapes suivantes :</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-arrow-right text-primary me-2"></i>Validation du retrait par la comptabilité</li>
                    <li><i class="bi bi-arrow-right text-primary me-2"></i>Effectuer le paiement au bailleur</li>
                    <li><i class="bi bi-arrow-right text-primary me-2"></i>Marquer le retrait comme "Payé"</li>
                    <li><i class="bi bi-arrow-right text-primary me-2"></i>Générer la quittance de paiement</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-générer une référence si virement sélectionné
    const modeSelect = document.getElementById('mode_retrait');
    const referenceInput = document.getElementById('reference_retrait');
    
    modeSelect.addEventListener('change', function() {
        if (this.value === 'virement' && !referenceInput.value) {
            const now = new Date();
            const reference = 'VIR-' + now.getFullYear() + 
                            String(now.getMonth() + 1).padStart(2, '0') + 
                            String(now.getDate()).padStart(2, '0') + '-' +
                            Math.random().toString(36).substr(2, 6).toUpperCase();
            referenceInput.value = reference;
        }
    });
    
    // Validation du formulaire
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const mode = modeSelect.value;
        if (!mode) {
            e.preventDefault();
            alert('Veuillez sélectionner un mode de retrait.');
            modeSelect.focus();
            return false;
        }
        
        // Confirmation
        const montant = '{{ recap.total_net_a_payer|floatformat:2 }}';
        const bailleur = '{{ bailleur.get_nom_complet }}';
        const mois = '{{ recap.mois_recap|date:"F Y" }}';
        
        if (!confirm(`Confirmer la création du retrait pour ${bailleur} - ${mois} - Montant: ${montant} F CFA ?`)) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}
