{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load core_extras %}

{% block title %}Dashboard Paiements - Gestion Immobilière{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
    }
    
    .stat-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1.5rem;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #10b981 0%, #22c55e 100%);
        color: white;
    }
    
    .stat-card.info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .stat-card.danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .stat-card.secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .stat-label {
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .stat-subtitle {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 0.5rem;
    }
    
    .stat-icon {
        font-size: 3rem;
        opacity: 0.8;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .content-card {
        background: white;
        border-radius: 15px;
        border: none;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .content-card .card-header {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        border: none;
        padding: 1.5rem;
    }
    
    .content-card .card-header h6 {
        font-weight: 700;
        font-size: 1.2rem;
        margin: 0;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .quick-action-btn {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        border: none;
        border-radius: 12px;
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(6, 182, 212, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .quick-action-btn.secondary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .quick-action-btn.secondary:hover {
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }
    
    .quick-action-btn.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .quick-action-btn.warning:hover {
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
    }
    
    .quick-action-btn.danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .quick-action-btn.danger:hover {
        box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
    }
    
    .payment-item {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .payment-item:hover {
        border-color: #06b6d4;
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
        transform: translateY(-2px);
    }
    
    .payment-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-valide { background: #10b981; color: white; }
    .status-en_attente { background: #f59e0b; color: white; }
    .status-refuse { background: #ef4444; color: white; }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header text-center">
    <h1 class="display-4 fw-bold mb-3">
        <i class="bi bi-cash-coin me-3"></i>Dashboard Paiements
    </h1>
    <p class="lead mb-0">Vue d'ensemble et gestion de vos flux financiers</p>
</div>

<!-- Note d'information sur la génération automatique des reçus -->
<div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <div class="d-flex align-items-center">
        <i class="bi bi-info-circle-fill me-3 fs-4"></i>
        <div>
            <strong>Génération automatique des reçus :</strong> 
            Les quittances et reçus sont maintenant générés automatiquement lors de la création ou modification des paiements. 
            Vous n'avez plus besoin de gérer manuellement cette section.
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Statistiques principales -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card success">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-start">
                        <div class="stat-number">{{ total_paiements }}</div>
                        <div class="stat-label">Total Paiements</div>
                        <div class="stat-subtitle">Tous statuts confondus</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card info">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-start">
                        <div class="stat-number">{{ paiements_valides }}</div>
                        <div class="stat-label">Validés</div>
                        <div class="stat-subtitle">Paiements confirmés</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card warning">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-start">
                        <div class="stat-number">{{ paiements_en_attente }}</div>
                        <div class="stat-label">En Attente</div>
                        <div class="stat-subtitle">À traiter</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card danger">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-start">
                        <div class="stat-number">{{ paiements_refuses }}</div>
                        <div class="stat-label">Refusés</div>
                        <div class="stat-subtitle">À examiner</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-x-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Indicateurs d'activité (NON confidentiels) -->
<div class="row mb-4">
    <div class="col-xl-6 col-md-6">
        <div class="card stat-card secondary">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-start">
                        <div class="stat-number">{{ paiements_valides|default:"0" }}</div>
                        <div class="stat-label">Paiements Validés</div>
                        <div class="stat-subtitle">Total des paiements confirmés</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-6 col-md-6">
        <div class="card stat-card info">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-start">
                        <div class="stat-number">{{ paiements_en_attente|default:"0" }}</div>
                        <div class="stat-label">En Attente</div>
                        <div class="stat-subtitle">Paiements à traiter</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section Récapitulatifs et Paiements Bailleurs -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card content-card">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-cash-coin me-2"></i>
                    Récapitulatifs et Paiements Bailleurs
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Statistiques des récapitulatifs -->
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-primary mb-1">{{ recaps_valides|default:"0" }}</div>
                            <div class="text-muted">Récaps Validés</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-success mb-1">{{ recaps_payes|default:"0" }}</div>
                            <div class="text-muted">Récaps Payés</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-warning mb-1">{{ retraits_en_attente|default:"0" }}</div>
                            <div class="text-muted">Retraits En Attente</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <div class="h4 text-info mb-1">{{ montant_total_a_payer|default:"0"|floatformat:0|intcomma }} F CFA</div>
                            <div class="text-muted">Total à Payer</div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- Actions rapides pour les récapitulatifs -->
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-calendar-month me-2"></i>
                            Gestion des Récapitulatifs
                        </h6>
                        <div class="d-grid gap-2">
                            <a href="{% url 'paiements:liste_bailleurs_recaps' %}" class="btn btn-outline-primary">
                                <i class="bi bi-list-ul me-2"></i>
                                Liste des Bailleurs avec Récaps
                            </a>
                            <a href="{% url 'paiements:tableau_bord_recaps_mensuels' %}" class="btn btn-outline-info">
                                <i class="bi bi-graph-up me-2"></i>
                                Tableau de Bord Récaps
                            </a>
                            <a href="{% url 'paiements:creer_recap_mensuel_auto' %}" class="btn btn-outline-success">
                                <i class="bi bi-plus-circle me-2"></i>
                                Créer un Récapitulatif
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-cash-coin me-2"></i>
                            Paiements Bailleurs
                        </h6>
                        <div class="d-grid gap-2">
                            <a href="{% url 'paiements:liste_retraits_bailleur' %}" class="btn btn-outline-success">
                                <i class="bi bi-bank me-2"></i>
                                Gérer les Retraits
                            </a>
                            <a href="{% url 'paiements:retrait_ajouter' %}" class="btn btn-outline-warning">
                                <i class="bi bi-plus-circle me-2"></i>
                                Créer un Retrait Manuel
                            </a>
                            <button class="btn btn-outline-info" onclick="showQuickPaymentModal()">
                                <i class="bi bi-lightning me-2"></i>
                                Paiement Rapide
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Récapitulatifs récents -->
                {% if recaps_recents %}
                <hr class="my-4">
                <h6 class="text-primary mb-3">
                    <i class="bi bi-clock-history me-2"></i>
                    Récapitulatifs Récents
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Bailleur</th>
                                <th>Mois</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for recap in recaps_recents %}
                            <tr>
                                <td>{{ recap.bailleur.get_nom_complet }}</td>
                                <td>{{ recap.mois_recap|date:"F Y" }}</td>
                                <td class="fw-bold text-success">{{ recap.total_net_a_payer|floatformat:0|intcomma }} F CFA</td>
                                <td>
                                    {% if recap.statut == 'valide' %}
                                        <span class="badge bg-success">Validé</span>
                                    {% elif recap.statut == 'paye' %}
                                        <span class="badge bg-info">Payé</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ recap.get_statut_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'paiements:detail_recap_mensuel_auto' recap_id=recap.id %}" 
                                           class="btn btn-outline-primary btn-sm" title="Voir le détail">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if recap.statut == 'valide' and recap.total_net_a_payer > 0 %}
                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#modalPaiementRapide{{ recap.id }}"
                                                title="Payer le bailleur">
                                            <i class="bi bi-cash-coin"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Actions rapides et contenu principal -->
<div class="row">
    <!-- Actions rapides -->
    <div class="col-lg-4">
        <div class="card content-card">
            <div class="card-header">
                <h6><i class="bi bi-lightning me-2"></i>Actions Rapides</h6>
            </div>
            <div class="card-body">
                <a href="{% url 'paiements:ajouter' %}" class="quick-action-btn">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter un Paiement
                </a>
                <a href="{% url 'paiements:liste' %}" class="quick-action-btn secondary">
                    <i class="bi bi-list me-2"></i>Voir Tous les Paiements
                </a>

                <a href="{% url 'paiements:retraits_liste' %}" class="quick-action-btn danger">
                    <i class="bi bi-bank me-2"></i>Gérer les Retraits
                </a>
                <a href="{% url 'paiements:liste_recaps_mensuels' %}" class="quick-action-btn info">
                    <i class="bi bi-calendar-month me-2"></i>Récaps Mensuels
                </a>
                <a href="{% url 'paiements:tableau_bord_dashboard' %}" class="quick-action-btn secondary">
                    <i class="bi bi-graph-up me-2"></i>Tableaux de Bord
                </a>

                <!-- Boutons paiements partiels -->
                <a href="{% url 'paiements:ajouter_partiel' %}" class="quick-action-btn success">
                    <i class="bi bi-plus-circle me-2"></i>Paiement Partiel
                </a>
                <a href="{% url 'paiements:historique_partiel' contrat_id=1 mois=9 annee=2025 %}" class="quick-action-btn warning">
                    <i class="bi bi-pie-chart me-2"></i>Historique Paiements Partiels
                </a>
            </div>
        </div>
    </div>
    
    <!-- Contenu principal -->
    <div class="col-lg-8">
        <!-- Top propriétés par revenus -->
        <div class="card content-card">
            <div class="card-header">
                <h6><i class="bi bi-star me-2"></i>Top 5 des Propriétés par Revenus</h6>
            </div>
            <div class="card-body">
                {% if top_proprietes_revenus %}
                    {% for prop in top_proprietes_revenus %}
                    <div class="payment-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ prop.propriete__titre|default:"Propriété inconnue" }}</h6>
                                <small class="text-muted">{{ prop.propriete__ville|default:"Ville non renseignée" }}</small>
                            </div>
                            <div class="text-end">
                                <div class="h5 mb-0 text-success">{{ prop.nombre_paiements|default:"0" }} paiements</div>
                                <small class="text-muted">Nombre de paiements</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">Aucun paiement enregistré</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Deuxième ligne -->
<div class="row">
    <!-- Paiements récents -->
    <div class="col-lg-6">
        <div class="card content-card">
            <div class="card-header">
                <h6><i class="bi bi-clock me-2"></i>Paiements Récents</h6>
            </div>
            <div class="card-body">
                {% if paiements_recents %}
                    {% for paiement in paiements_recents %}
                    <div class="payment-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ paiement.contrat.propriete.titre|default:"Propriété inconnue" }}</h6>
                                <small class="text-muted">{{ paiement.contrat.locataire.nom|default:"Locataire inconnu" }}</small>
                                <span class="payment-status status-{{ paiement.statut }} ms-2">{{ paiement.get_statut_display }}</span>
                            </div>
                            <div class="text-end">
                                <div class="h6 mb-0 text-success">{{ paiement.get_statut_display }}</div>
                                <small class="text-muted">{{ paiement.date_paiement|date:"d/m/Y" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">Aucun paiement récent</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Paiements nécessitant attention -->
    <div class="col-lg-6">
        <div class="card content-card">
            <div class="card-header">
                <h6><i class="bi bi-exclamation-triangle me-2"></i>Paiements à Traiter</h6>
            </div>
            <div class="card-body">
                {% if paiements_attention %}
                    {% for paiement in paiements_attention %}
                    <div class="payment-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ paiement.contrat.propriete.titre|default:"Propriété inconnue" }}</h6>
                                <small class="text-muted">{{ paiement.contrat.locataire.nom|default:"Locataire inconnu" }}</small>
                                <span class="payment-status status-{{ paiement.statut }} ms-2">{{ paiement.get_statut_display }}</span>
                            </div>
                            <div class="text-end">
                                <div class="h6 mb-0 text-warning">{{ paiement.get_statut_display }}</div>
                                <small class="text-muted">{{ paiement.date_paiement|date:"d/m/Y" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">Aucun paiement à traiter</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Graphique des statistiques mensuelles -->
{% if mois_stats %}
<div class="row">
    <div class="col-12">
        <div class="card content-card">
            <div class="card-header">
                <h6><i class="bi bi-graph-up me-2"></i>Évolution de l'Activité (6 derniers mois)</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="revenusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if mois_stats %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('revenusChart').getContext('2d');
    
    const data = {
        labels: [{% for stat in mois_stats %}'{{ stat.mois }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
                            label: 'Nombre de Paiements',
            data: [{% for stat in mois_stats %}{{ stat.nombre_paiements }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: 'rgba(6, 182, 212, 0.2)',
            borderColor: 'rgba(6, 182, 212, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    };
    
    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' paiements';
                        }
                    }
                }
            }
        }
    };
    
    new Chart(ctx, config);
});
</script>
{% endif %}

<!-- Modals de Paiement Rapide pour les récapitulatifs récents -->
{% if recaps_recents %}
{% for recap in recaps_recents %}
{% if recap.statut == 'valide' and recap.total_net_a_payer > 0 %}
<div class="modal fade" id="modalPaiementRapide{{ recap.id }}" tabindex="-1" aria-labelledby="modalPaiementRapideLabel{{ recap.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalPaiementRapideLabel{{ recap.id }}">
                    <i class="bi bi-cash-coin me-2"></i>
                    Paiement Rapide - {{ recap.bailleur.get_nom_complet }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informations du récapitulatif -->
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i>
                        Informations du Récapitulatif
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Bailleur :</strong> {{ recap.bailleur.get_nom_complet }}<br>
                            <strong>Mois :</strong> {{ recap.mois_recap|date:"F Y" }}
                        </div>
                        <div class="col-md-6">
                            <strong>Loyers Bruts :</strong> {{ recap.total_loyers_bruts|floatformat:0|intcomma }} F CFA<br>
                            <strong>Charges :</strong> {{ recap.total_charges_deductibles|floatformat:0|intcomma }} F CFA<br>
                            <strong class="text-success">Net à Payer :</strong> <span class="h5 text-success">{{ recap.total_net_a_payer|floatformat:0|intcomma }} F CFA</span>
                        </div>
                    </div>
                </div>

                <!-- Formulaire de paiement -->
                <form id="formPaiementRapide{{ recap.id }}" method="post" action="{% url 'paiements:creer_retrait_depuis_recap' recap_id=recap.id %}">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mode_retrait_rapide{{ recap.id }}" class="form-label">
                                    <i class="bi bi-credit-card me-1"></i>
                                    Mode de Paiement
                                </label>
                                <select name="mode_retrait" id="mode_retrait_rapide{{ recap.id }}" class="form-select" required>
                                    <option value="">-- Sélectionner un mode --</option>
                                    <option value="virement" selected>Virement bancaire</option>
                                    <option value="cheque">Chèque</option>
                                    <option value="especes">Espèces</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reference_retrait_rapide{{ recap.id }}" class="form-label">
                                    <i class="bi bi-hash me-1"></i>
                                    Référence
                                </label>
                                <input type="text" name="reference_retrait" id="reference_retrait_rapide{{ recap.id }}" 
                                       class="form-control" placeholder="Référence du paiement (optionnel)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observations_rapide{{ recap.id }}" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>
                            Observations
                        </label>
                        <textarea name="observations" id="observations_rapide{{ recap.id }}" class="form-control" rows="3" 
                                  placeholder="Observations sur ce paiement...">{{ recap.mois_recap|date:"F Y" }} - Paiement basé sur le récapitulatif mensuel</textarea>
                    </div>
                    
                    <!-- Résumé du paiement -->
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="bi bi-check-circle me-2"></i>
                            Résumé du Paiement
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Bailleur :</strong><br>
                                {{ recap.bailleur.get_nom_complet }}
                            </div>
                            <div class="col-md-4">
                                <strong>Mois :</strong><br>
                                {{ recap.mois_recap|date:"F Y" }}
                            </div>
                            <div class="col-md-4">
                                <strong>Montant :</strong><br>
                                <span class="h5 text-success">{{ recap.total_net_a_payer|floatformat:0|intcomma }} F CFA</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Annuler
                </button>
                <button type="button" class="btn btn-success" onclick="confirmerPaiementRapide{{ recap.id }}()">
                    <i class="bi bi-cash-coin me-2"></i>
                    Confirmer le Paiement
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-générer une référence si virement sélectionné
    const modeSelect{{ recap.id }} = document.getElementById('mode_retrait_rapide{{ recap.id }}');
    const referenceInput{{ recap.id }} = document.getElementById('reference_retrait_rapide{{ recap.id }}');
    const observationsInput{{ recap.id }} = document.getElementById('observations_rapide{{ recap.id }}');
    
    if (modeSelect{{ recap.id }} && referenceInput{{ recap.id }}) {
        // Fonction pour générer une référence unique
        function generateReference{{ recap.id }}() {
            const now = new Date();
            const random = Math.random().toString(36).substr(2, 4).toUpperCase();
            return `VIR-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${random}`;
        }
        
        // Fonction pour mettre à jour les observations selon le mode
        function updateObservations{{ recap.id }}() {
            const mode = modeSelect{{ recap.id }}.value;
            const mois = '{{ recap.mois_recap|date:"F Y" }}';
            const bailleur = '{{ recap.bailleur.get_nom_complet }}';
            
            if (mode === 'virement') {
                observationsInput{{ recap.id }}.value = `${mois} - Paiement par virement bancaire pour ${bailleur}`;
            } else if (mode === 'cheque') {
                observationsInput{{ recap.id }}.value = `${mois} - Paiement par chèque pour ${bailleur}`;
            } else if (mode === 'especes') {
                observationsInput{{ recap.id }}.value = `${mois} - Paiement en espèces pour ${bailleur}`;
            }
        }
        
        modeSelect{{ recap.id }}.addEventListener('change', function() {
            const mode = this.value;
            
            // Auto-générer la référence pour les virements
            if (mode === 'virement' && !referenceInput{{ recap.id }}.value) {
                referenceInput{{ recap.id }}.value = generateReference{{ recap.id }}();
            } else if (mode !== 'virement') {
                referenceInput{{ recap.id }}.value = '';
            }
            
            // Mettre à jour les observations
            updateObservations{{ recap.id }}();
        });
        
        // Initialisation
        if (modeSelect{{ recap.id }}.value === 'virement' && !referenceInput{{ recap.id }}.value) {
            referenceInput{{ recap.id }}.value = generateReference{{ recap.id }}();
        }
        updateObservations{{ recap.id }}();
    }
});

function confirmerPaiementRapide{{ recap.id }}() {
    const mode = document.getElementById('mode_retrait_rapide{{ recap.id }}').value;
    const reference = document.getElementById('reference_retrait_rapide{{ recap.id }}').value;
    
    if (!mode) {
        alert('Veuillez sélectionner un mode de paiement.');
        document.getElementById('mode_retrait_rapide{{ recap.id }}').focus();
        return false;
    }
    
    if ((mode === 'virement' || mode === 'cheque') && !reference.trim()) {
        alert('Veuillez saisir une référence pour ce mode de paiement.');
        document.getElementById('reference_retrait_rapide{{ recap.id }}').focus();
        return false;
    }
    
    // Confirmation avec plus de détails
    const montant = '{{ recap.total_net_a_payer|floatformat:2 }}';
    const bailleur = '{{ recap.bailleur.get_nom_complet }}';
    const mois = '{{ recap.mois_recap|date:"F Y" }}';
    const modeText = mode === 'virement' ? 'Virement bancaire' : 
                    mode === 'cheque' ? 'Chèque' : 'Espèces';
    
    const message = `Confirmer le paiement ?\n\n` +
                   `Bailleur: ${bailleur}\n` +
                   `Mois: ${mois}\n` +
                   `Montant: ${montant} F CFA\n` +
                   `Mode: ${modeText}` +
                   (reference ? `\nRéférence: ${reference}` : '');
    
    if (confirm(message)) {
        // Afficher un indicateur de chargement
        const submitBtn = document.querySelector('button[onclick="confirmerPaiementRapide{{ recap.id }}()"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Création en cours...';
        submitBtn.disabled = true;
        
        // Soumettre le formulaire
        document.getElementById('formPaiementRapide{{ recap.id }}').submit();
    }
}
</script>
{% endif %}
{% endfor %}
{% endif %}

<script>
function showQuickPaymentModal() {
    // Trouver le premier modal de paiement rapide disponible
    const modals = document.querySelectorAll('[id^="modalPaiementRapide"]');
    if (modals.length > 0) {
        // Ouvrir le premier modal disponible
        const modal = new bootstrap.Modal(modals[0]);
        modal.show();
    } else {
        // Si aucun modal n'est disponible, rediriger vers la liste des bailleurs
        window.location.href = "{% url 'paiements:liste_bailleurs_recaps' %}";
    }
}
</script>
{% endblock %}
