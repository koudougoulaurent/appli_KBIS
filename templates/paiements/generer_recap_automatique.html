{% extends 'base_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ title }} - Gestion Immobilière{% endblock %}

{% block extra_css %}
<style>
    .dynamic-preview {
        transition: all 0.3s ease-in-out;
        opacity: 0;
        transform: translateY(20px);
    }
    
    .dynamic-preview.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .loading-spinner {
        display: none;
    }
    
    .loading-spinner.show {
        display: inline-block;
    }
    
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        border-color: #80bdff;
    }
    
    .suggestion-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .suggestion-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .suggestion-card.selected {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .calculation-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
    }
    
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .slide-up {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(30px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #007bff;
    }
    
    .dropdown-item {
        padding: 8px 16px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-menu {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1000;
    }
    
    .dropdown-menu.show {
        display: block;
    }
    
    .form-control:focus + .input-group-text {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .progress-bar {
        transition: width 1s ease-out;
    }
    
    .btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
    }
</style>
{% endblock %}

{% block content %}
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-magic text-primary"></i>
            {{ title }}
        </h1>
        <a href="{% url 'paiements:tableau_bord_recaps_mensuels' %}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Retour au Tableau de Bord
        </a>
    </div>

    <!-- Explication de la logique métier -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-left-info shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="bi bi-info-circle"></i>
                        Logique Métier - Paiement Anticipé aux Bailleurs
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">
                                <i class="bi bi-check-circle"></i>
                                Récapitulatif Généré et Payé AVANT les Loyers
                            </h6>
                            <p class="text-muted small">
                                Le système génère automatiquement les récapitulatifs mensuels et permet de payer 
                                les bailleurs <strong>avant</strong> que les locataires paient leurs loyers.
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning">
                                <i class="bi bi-shield-check"></i>
                                Condition : Garanties Financières Suffisantes
                            </h6>
                            <p class="text-muted small">
                                Cette pratique n'est possible que si <strong>tous les locataires</strong> ont versé :
                                <br>• La <strong>totalité de la caution</strong>
                                <br>• La <strong>totalité de l'avance</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de génération -->
    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-gear"></i>
                        Configuration de la Génération
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="generationForm">
                        {% csrf_token %}
                        
                        <!-- Sélection du mois avec suggestions intelligentes -->
                        <div class="form-group mb-4">
                            <label for="mois_recap" class="form-label">
                                <strong>Mois à traiter :</strong>
                            </label>
                            <div class="input-group">
                                <select class="form-select" id="mois_recap" name="mois_recap" required>
                                    <option value="">-- Sélectionner un mois --</option>
                                    {% for mois in mois_disponibles %}
                                    <option value="{{ mois.value }}">{{ mois.label }}</option>
                                    {% endfor %}
                                </select>
                                <span class="input-group-text">
                                    <i class="bi bi-calendar3"></i>
                                </span>
                            </div>
                            <small class="form-text text-muted">
                                Sélectionnez le mois pour lequel vous souhaitez générer les récapitulatifs.
                            </small>
                            
                            <!-- Suggestions intelligentes -->
                            <div id="suggestions-mois" class="mt-3" style="display: none;">
                                <h6 class="text-primary mb-2">
                                    <i class="bi bi-lightbulb"></i> Suggestions intelligentes :
                                </h6>
                                <div id="suggestions-container" class="row">
                                    <!-- Les suggestions seront chargées dynamiquement -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sélection du bailleur avec recherche -->
                        <div class="form-group mb-4">
                            <label for="bailleur_id" class="form-label">
                                <strong>Bailleur à traiter :</strong>
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="bailleur_search" placeholder="Rechercher un bailleur..." autocomplete="off">
                                <select class="form-select" id="bailleur_id" name="bailleur_id" style="display: none;">
                                    <option value="tous">-- Tous les bailleurs --</option>
                                    {% for bailleur in bailleurs_actifs %}
                                    <option value="{{ bailleur.id }}" data-nom="{{ bailleur.get_nom_complet }}">
                                        {{ bailleur.get_nom_complet }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <span class="input-group-text">
                                    <i class="bi bi-person"></i>
                                </span>
                            </div>
                            <div id="bailleur_dropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                <!-- Les options seront chargées dynamiquement -->
                            </div>
                            <small class="form-text text-muted">
                                Tapez pour rechercher un bailleur ou sélectionnez "Tous les bailleurs" pour traiter tous les bailleurs actifs.
                            </small>
                        </div>

                        <!-- Options avancées -->
                        <div class="form-group mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="forcer_regeneration" name="forcer_regeneration">
                                <label class="form-check-label" for="forcer_regeneration">
                                    <strong>Forcer la régénération</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Cochez cette case si vous voulez supprimer et recréer les récapitulatifs existants pour ce mois.
                            </small>
                        </div>

                        <!-- Aperçu dynamique des calculs -->
                        <div id="calculation-preview" class="dynamic-preview calculation-preview" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-calculator"></i>
                                    Aperçu des Calculs
                                </h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-light" id="refresh-calculations" title="Actualiser">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-light" id="export-preview" title="Exporter">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h4 mb-1" id="preview-loyers">0 FCFA</div>
                                    <small>Total Loyers Bruts</small>
                                    <div class="progress mt-1" style="height: 3px;">
                                        <div class="progress-bar bg-success" id="progress-loyers" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="h4 mb-1" id="preview-charges">0 FCFA</div>
                                    <small>Charges Déductibles</small>
                                    <div class="progress mt-1" style="height: 3px;">
                                        <div class="progress-bar bg-warning" id="progress-charges" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="h4 mb-1" id="preview-net">0 FCFA</div>
                                    <small>Montant Net</small>
                                    <div class="progress mt-1" style="height: 3px;">
                                        <div class="progress-bar bg-primary" id="progress-net" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <div class="row">
                                    <div class="col-3">
                                        <small><i class="bi bi-building"></i> <span id="preview-proprietes">0</span> propriétés</small>
                                    </div>
                                    <div class="col-3">
                                        <small><i class="bi bi-file-text"></i> <span id="preview-contrats">0</span> contrats</small>
                                    </div>
                                    <div class="col-3">
                                        <small><i class="bi bi-credit-card"></i> <span id="preview-paiements">0</span> paiements</small>
                                    </div>
                                    <div class="col-3">
                                        <small><i class="bi bi-people"></i> <span id="preview-bailleurs">0</span> bailleurs</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Indicateur de performance -->
                            <div class="mt-3" id="performance-indicator" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-light">Performance du mois :</small>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 100px; height: 8px;">
                                            <div class="progress-bar bg-info" id="performance-bar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-light" id="performance-text">0%</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb"></i>
                            <strong>Conseil :</strong> 
                            Vérifiez que tous les locataires ont bien versé leurs cautions et avances avant de générer 
                            les récapitulatifs. Cela garantira que tous les récapitulatifs soient marqués comme 
                            "Prêts pour paiement".
                        </div>

                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="bi bi-magic"></i>
                            <span class="btn-text">Générer les Récapitulatifs</span>
                            <span class="loading-spinner">
                                <i class="bi bi-hourglass-split"></i>
                                Génération en cours...
                            </span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Informations complémentaires -->
        <div class="col-xl-4 col-lg-5">
            <!-- Guide interactif -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-question-circle"></i>
                        Guide Interactif
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-success">
                            <i class="bi bi-1-circle"></i>
                            Génération Automatique
                        </h6>
                        <p class="small text-muted">
                            Le système analyse automatiquement tous les bailleurs actifs et leurs propriétés louées.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-info">
                            <i class="bi bi-2-circle"></i>
                            Calcul des Totaux
                        </h6>
                        <p class="small text-muted">
                            Calcul automatique des loyers, charges et montants nets basés sur les contrats actifs.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-warning">
                            <i class="bi bi-3-circle"></i>
                            Vérification des Garanties
                        </h6>
                        <p class="small text-muted">
                            Vérification automatique que toutes les cautions et avances sont versées.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">
                            <i class="bi bi-4-circle"></i>
                            Statut Automatique
                        </h6>
                        <p class="small text-muted">
                            Les récapitulatifs sont automatiquement marqués comme "Prêts pour paiement" 
                            ou "En attente des garanties".
                        </p>
                    </div>
                </div>
            </div>

            <!-- Statistiques dynamiques -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-graph-up"></i>
                        Statistiques en Temps Réel
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Bailleurs Actifs
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-bailleurs">
                                {{ total_bailleurs|default:"..." }}
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Propriétés Louées
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="stat-proprietes">
                                {{ total_proprietes|default:"..." }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Barre de progression pour la sélection -->
                    <div class="mt-3" id="selection-progress" style="display: none;">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>Configuration</span>
                            <span id="progress-percent">0%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar progress-bar-animated" role="progressbar" 
                                 style="width: 0%" id="progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aperçu des suggestions intelligentes -->
            <div class="card shadow mb-4" id="suggestions-preview" style="display: none;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-lightbulb"></i>
                        Suggestions Intelligentes
                    </h6>
                </div>
                <div class="card-body">
                    <div id="suggestions-content">
                        <!-- Le contenu sera chargé dynamiquement -->
                    </div>
                </div>
            </div>

            <!-- Validation en temps réel -->
            <div class="card shadow mb-4" id="validation-preview" style="display: none;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-check-circle"></i>
                        Validation
                    </h6>
                </div>
                <div class="card-body">
                    <div id="validation-content">
                        <!-- Le contenu sera chargé dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    const form = document.getElementById('generationForm');
    const moisSelect = document.getElementById('mois_recap');
    const bailleurSelect = document.getElementById('bailleur_id');
    const bailleurSearch = document.getElementById('bailleur_search');
    const bailleurDropdown = document.getElementById('bailleur_dropdown');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text');
    const loadingSpinner = submitBtn.querySelector('.loading-spinner');
    const calculationPreview = document.getElementById('calculation-preview');
    const suggestionsMois = document.getElementById('suggestions-mois');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const suggestionsPreview = document.getElementById('suggestions-preview');
    const validationPreview = document.getElementById('validation-preview');
    const selectionProgress = document.getElementById('selection-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    
    // Données des bailleurs pour la recherche
    const bailleursData = Array.from(bailleurSelect.options).map(option => ({
        id: option.value,
        nom: option.textContent,
        dataNom: option.dataset.nom
    }));
    
    // Données des suggestions (passées depuis le backend)
    const suggestionsData = {{ suggestions_mois|safe }};
    
    // État de la configuration
    let configurationState = {
        mois: null,
        bailleur: null,
        forcerRegeneration: false,
        isValid: false
    };
    
    // Initialisation
    initializeEventListeners();
    updateProgress();
    
    function initializeEventListeners() {
        // Écoute des changements de mois
        moisSelect.addEventListener('change', function() {
            configurationState.mois = this.value;
            handleMoisChange();
            updateProgress();
            updateValidation();
        });
        
        // Écoute des changements de bailleur
        bailleurSelect.addEventListener('change', function() {
            configurationState.bailleur = this.value;
            handleBailleurChange();
            updateProgress();
            updateValidation();
        });
        
        // Recherche dynamique des bailleurs
        bailleurSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterBailleurs(searchTerm);
        });
        
        bailleurSearch.addEventListener('focus', function() {
            showBailleurDropdown();
        });
        
        // Fermer le dropdown quand on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!bailleurSearch.contains(e.target) && !bailleurDropdown.contains(e.target)) {
                hideBailleurDropdown();
            }
        });
        
        // Écoute des changements de régénération forcée
        document.getElementById('forcer_regeneration').addEventListener('change', function() {
            configurationState.forcerRegeneration = this.checked;
            updateValidation();
        });
        
        // Boutons d'action de l'aperçu
        document.getElementById('refresh-calculations').addEventListener('click', function() {
            loadCalculationPreview();
            showNotification('Calculs actualisés', 'success');
        });
        
        document.getElementById('export-preview').addEventListener('click', function() {
            exportCalculationPreview();
        });
        
        // Validation du formulaire
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            handleFormSubmit();
        });
        
        // Animation d'entrée
        animatePageLoad();
    }
    
    function handleMoisChange() {
        if (configurationState.mois) {
            // Afficher les suggestions intelligentes
            showSuggestions();
            
            // Charger l'aperçu des calculs
            loadCalculationPreview();
            
            // Animation
            moisSelect.classList.add('fade-in');
        } else {
            hideSuggestions();
            hideCalculationPreview();
        }
    }
    
    function handleBailleurChange() {
        if (configurationState.bailleur && configurationState.mois) {
            // Mettre à jour l'aperçu des calculs
            loadCalculationPreview();
            
            // Animation
            bailleurSelect.classList.add('fade-in');
        }
    }
    
    function showSuggestions() {
        if (Object.keys(suggestionsData).length === 0) return;
        
        suggestionsContainer.innerHTML = '';
        
        Object.values(suggestionsData).forEach(suggestion => {
            const suggestionCard = createSuggestionCard(suggestion);
            suggestionsContainer.appendChild(suggestionCard);
        });
        
        suggestionsMois.style.display = 'block';
        suggestionsMois.classList.add('slide-up');
        
        // Mettre à jour le panneau de suggestions
        updateSuggestionsPreview();
    }
    
    function createSuggestionCard(suggestion) {
        const card = document.createElement('div');
        card.className = 'col-md-6 mb-2';
        card.innerHTML = `
            <div class="card suggestion-card h-100" data-mois="${suggestion.mois_suggere}">
                <div class="card-body p-3">
                    <h6 class="card-title text-primary mb-1">
                        <i class="bi bi-person-circle"></i>
                        ${suggestion.bailleur_nom}
                    </h6>
                    <p class="card-text small mb-2">
                        <strong>Mois suggéré :</strong> ${suggestion.mois_suggere_formate}
                    </p>
                    <p class="card-text small text-muted mb-2">
                        ${suggestion.raison}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Dernier : ${suggestion.dernier_mois}
                        </small>
                        <span class="badge ${suggestion.recap_existant ? 'bg-warning' : 'bg-success'}">
                            ${suggestion.recap_existant ? 'Existe' : 'Nouveau'}
                        </span>
                    </div>
                </div>
            </div>
        `;
        
        // Ajouter l'événement de clic
        card.addEventListener('click', function() {
            selectSuggestion(this, suggestion);
        });
        
        return card;
    }
    
    function selectSuggestion(cardElement, suggestion) {
        // Désélectionner les autres cartes
        document.querySelectorAll('.suggestion-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Sélectionner cette carte
        cardElement.classList.add('selected');
        
        // Mettre à jour les sélections
        moisSelect.value = suggestion.mois_suggere;
        configurationState.mois = suggestion.mois_suggere;
        
        // Mettre à jour l'aperçu
        loadCalculationPreview();
        updateProgress();
        updateValidation();
        
        // Animation
        cardElement.classList.add('fade-in');
    }
    
    function updateSuggestionsPreview() {
        const suggestionsContent = document.getElementById('suggestions-content');
        const totalSuggestions = Object.keys(suggestionsData).length;
        const suggestionsAvecRecap = Object.values(suggestionsData).filter(s => s.recap_existant).length;
        const suggestionsNouvelles = totalSuggestions - suggestionsAvecRecap;
        
        suggestionsContent.innerHTML = `
            <div class="row text-center">
                <div class="col-6">
                    <div class="h5 text-primary">${totalSuggestions}</div>
                    <small>Suggestions</small>
                </div>
                <div class="col-6">
                    <div class="h5 text-success">${suggestionsNouvelles}</div>
                    <small>Nouvelles</small>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    Cliquez sur une suggestion pour la sélectionner automatiquement.
                </small>
            </div>
        `;
        
        suggestionsPreview.style.display = 'block';
        suggestionsPreview.classList.add('slide-up');
    }
    
    function loadCalculationPreview() {
        if (!configurationState.mois) return;
        
        // Afficher l'état de chargement
        showLoadingState();
        
        // Appel AJAX pour obtenir les données réelles
        const url = new URL('{% url "paiements:api_calculation_preview" %}', window.location.origin);
        url.searchParams.append('mois', configurationState.mois);
        if (configurationState.bailleur && configurationState.bailleur !== 'tous') {
            url.searchParams.append('bailleur_id', configurationState.bailleur);
        }
        
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                updateCalculationPreview(data.data);
            } else {
                throw new Error(data.error || 'Erreur inconnue');
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données:', error);
            showNotification('Erreur lors du chargement des données: ' + error.message, 'danger');
            
            // Afficher des données de fallback
            const fallbackData = generateFallbackData();
            updateCalculationPreview(fallbackData);
        })
        .finally(() => {
            hideLoadingState();
        });
    }
    
    function generateFallbackData() {
        // Données de fallback en cas d'erreur
        const bailleurId = configurationState.bailleur;
        const isAllBailleurs = !bailleurId || bailleurId === 'tous';
        
        return {
            total_loyers: isAllBailleurs ? Math.floor(Math.random() * 5000000) + 1000000 : Math.floor(Math.random() * 1000000) + 100000,
            total_charges: isAllBailleurs ? Math.floor(Math.random() * 500000) + 50000 : Math.floor(Math.random() * 100000) + 10000,
            nombre_proprietes: isAllBailleurs ? Math.floor(Math.random() * 20) + 5 : Math.floor(Math.random() * 5) + 1,
            nombre_contrats: isAllBailleurs ? Math.floor(Math.random() * 25) + 8 : Math.floor(Math.random() * 6) + 2,
            nombre_paiements: isAllBailleurs ? Math.floor(Math.random() * 20) + 5 : Math.floor(Math.random() * 5) + 1,
            recaps_existants: 0
        };
    }
    
    function updateCalculationPreview(data) {
        const totalLoyers = data.total_loyers || data.totalLoyers || 0;
        const totalCharges = data.total_charges || data.totalCharges || 0;
        const totalNet = data.total_net || (totalLoyers - totalCharges);
        const nombreProprietes = data.nombre_proprietes || data.nombreProprietes || 0;
        const nombreContrats = data.nombre_contrats || data.nombreContrats || 0;
        const nombrePaiements = data.nombre_paiements || data.nombrePaiements || 0;
        const nombreBailleurs = data.bailleurs_count || 1;
        
        // Mettre à jour les valeurs
        document.getElementById('preview-loyers').textContent = formatCurrency(totalLoyers);
        document.getElementById('preview-charges').textContent = formatCurrency(totalCharges);
        document.getElementById('preview-net').textContent = formatCurrency(totalNet);
        document.getElementById('preview-proprietes').textContent = nombreProprietes;
        document.getElementById('preview-contrats').textContent = nombreContrats;
        document.getElementById('preview-paiements').textContent = nombrePaiements;
        document.getElementById('preview-bailleurs').textContent = nombreBailleurs;
        
        // Mettre à jour les barres de progression
        updateProgressBars(totalLoyers, totalCharges, totalNet);
        
        // Mettre à jour l'indicateur de performance
        updatePerformanceIndicator(nombrePaiements, nombreContrats);
        
        // Mettre à jour les informations supplémentaires
        if (data.recaps_existants !== undefined) {
            updateValidationWithRecaps(data.recaps_existants, data.mois_formate);
        }
        
        calculationPreview.style.display = 'block';
        calculationPreview.classList.add('show');
        
        // Animation d'apparition
        calculationPreview.classList.add('fade-in');
    }
    
    function updateProgressBars(totalLoyers, totalCharges, totalNet) {
        // Calculer les pourcentages relatifs (basés sur le plus grand montant)
        const maxAmount = Math.max(totalLoyers, totalCharges, totalNet);
        
        if (maxAmount > 0) {
            const loyersPercent = (totalLoyers / maxAmount) * 100;
            const chargesPercent = (totalCharges / maxAmount) * 100;
            const netPercent = (totalNet / maxAmount) * 100;
            
            // Animation des barres de progression
            animateProgressBar('progress-loyers', loyersPercent);
            animateProgressBar('progress-charges', chargesPercent);
            animateProgressBar('progress-net', netPercent);
        }
    }
    
    function animateProgressBar(elementId, percent) {
        const bar = document.getElementById(elementId);
        bar.style.width = '0%';
        
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-out';
            bar.style.width = percent + '%';
        }, 100);
    }
    
    function updatePerformanceIndicator(nombrePaiements, nombreContrats) {
        const performanceIndicator = document.getElementById('performance-indicator');
        const performanceBar = document.getElementById('performance-bar');
        const performanceText = document.getElementById('performance-text');
        
        if (nombreContrats > 0) {
            const performancePercent = Math.min((nombrePaiements / nombreContrats) * 100, 100);
            
            performanceBar.style.width = performancePercent + '%';
            performanceText.textContent = Math.round(performancePercent) + '%';
            
            // Couleur basée sur la performance
            if (performancePercent >= 80) {
                performanceBar.className = 'progress-bar bg-success';
            } else if (performancePercent >= 60) {
                performanceBar.className = 'progress-bar bg-warning';
            } else {
                performanceBar.className = 'progress-bar bg-danger';
            }
            
            performanceIndicator.style.display = 'block';
        } else {
            performanceIndicator.style.display = 'none';
        }
    }
    
    function exportCalculationPreview() {
        const data = {
            mois: configurationState.mois,
            bailleur: configurationState.bailleur,
            totalLoyers: document.getElementById('preview-loyers').textContent,
            totalCharges: document.getElementById('preview-charges').textContent,
            totalNet: document.getElementById('preview-net').textContent,
            proprietes: document.getElementById('preview-proprietes').textContent,
            contrats: document.getElementById('preview-contrats').textContent,
            paiements: document.getElementById('preview-paiements').textContent,
            bailleurs: document.getElementById('preview-bailleurs').textContent,
            timestamp: new Date().toLocaleString('fr-FR')
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `apercu-calculs-${configurationState.mois || 'selection'}.json`;
        link.click();
        
        showNotification('Aperçu exporté avec succès', 'success');
    }
    
    function filterBailleurs(searchTerm) {
        const filteredBailleurs = bailleursData.filter(bailleur => 
            bailleur.nom.toLowerCase().includes(searchTerm) ||
            (bailleur.dataNom && bailleur.dataNom.toLowerCase().includes(searchTerm))
        );
        
        updateBailleurDropdown(filteredBailleurs);
        showBailleurDropdown();
    }
    
    function updateBailleurDropdown(bailleurs) {
        bailleurDropdown.innerHTML = '';
        
        // Option "Tous les bailleurs"
        const tousOption = document.createElement('div');
        tousOption.className = 'dropdown-item cursor-pointer';
        tousOption.innerHTML = '<i class="bi bi-people"></i> Tous les bailleurs';
        tousOption.addEventListener('click', () => selectBailleur('tous', 'Tous les bailleurs'));
        bailleurDropdown.appendChild(tousOption);
        
        // Options des bailleurs filtrés
        bailleurs.forEach(bailleur => {
            if (bailleur.id === 'tous') return; // Skip l'option "tous" déjà ajoutée
            
            const option = document.createElement('div');
            option.className = 'dropdown-item cursor-pointer';
            option.innerHTML = `<i class="bi bi-person"></i> ${bailleur.nom}`;
            option.addEventListener('click', () => selectBailleur(bailleur.id, bailleur.nom));
            bailleurDropdown.appendChild(option);
        });
        
        if (bailleurs.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'dropdown-item text-muted';
            noResults.innerHTML = '<i class="bi bi-search"></i> Aucun résultat trouvé';
            bailleurDropdown.appendChild(noResults);
        }
    }
    
    function selectBailleur(bailleurId, bailleurNom) {
        configurationState.bailleur = bailleurId;
        bailleurSearch.value = bailleurNom;
        bailleurSelect.value = bailleurId;
        
        hideBailleurDropdown();
        handleBailleurChange();
        updateProgress();
        updateValidation();
        
        // Animation
        bailleurSearch.classList.add('fade-in');
    }
    
    function showBailleurDropdown() {
        if (bailleurDropdown.children.length === 0) {
            updateBailleurDropdown(bailleursData);
        }
        bailleurDropdown.style.display = 'block';
        bailleurDropdown.classList.add('show');
    }
    
    function hideBailleurDropdown() {
        bailleurDropdown.style.display = 'none';
        bailleurDropdown.classList.remove('show');
    }
    
    function updateValidationWithRecaps(recapsExistants, moisFormate) {
        const validationContent = document.getElementById('validation-content');
        
        if (recapsExistants > 0) {
            validationContent.innerHTML = `
                <div class="alert alert-warning mb-2">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Récapitulatifs existants</strong><br>
                    <small>${recapsExistants} récapitulatif(s) existe(nt) déjà pour ${moisFormate}</small>
                </div>
                <div class="alert alert-info mb-0">
                    <i class="bi bi-lightbulb"></i>
                    <strong>Conseil :</strong> Cochez "Forcer la régénération" pour les recréer.
                </div>
            `;
        } else {
            validationContent.innerHTML = `
                <div class="alert alert-success mb-0">
                    <i class="bi bi-check-circle"></i>
                    <strong>Configuration valide</strong><br>
                    <small>Prêt pour la génération des récapitulatifs</small>
                </div>
            `;
        }
        
        validationPreview.style.display = 'block';
        validationPreview.classList.add('slide-up');
    }
    
    function updateProgress() {
        let progress = 0;
        
        if (configurationState.mois) progress += 50;
        if (configurationState.bailleur) progress += 30;
        if (configurationState.forcerRegeneration) progress += 20;
        
        progressBar.style.width = progress + '%';
        progressPercent.textContent = progress + '%';
        
        if (progress > 0) {
            selectionProgress.style.display = 'block';
        } else {
            selectionProgress.style.display = 'none';
        }
    }
    
    function updateValidation() {
        const validationContent = document.getElementById('validation-content');
        const isValid = configurationState.mois && configurationState.bailleur;
        
        configurationState.isValid = isValid;
        
        if (isValid) {
            validationContent.innerHTML = `
                <div class="alert alert-success mb-0">
                    <i class="bi bi-check-circle"></i>
                    <strong>Configuration valide</strong><br>
                    <small>Prêt pour la génération des récapitulatifs</small>
                </div>
            `;
        } else {
            validationContent.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Configuration incomplète</strong><br>
                    <small>Veuillez sélectionner un mois et un bailleur</small>
                </div>
            `;
        }
        
        validationPreview.style.display = 'block';
        validationPreview.classList.add('slide-up');
        
        // Mettre à jour le bouton
        submitBtn.disabled = !isValid;
        if (isValid) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
        } else {
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-secondary');
        }
    }
    
    function handleFormSubmit() {
        if (!configurationState.isValid) {
            showNotification('Veuillez compléter la configuration avant de continuer.', 'warning');
            return;
        }
        
        // Confirmation avant génération
        const moisLabel = moisSelect.options[moisSelect.selectedIndex].text;
        const bailleurLabel = bailleurSelect.value === 'tous' ? 'Tous les bailleurs' : bailleurSelect.options[bailleurSelect.selectedIndex].text;
        
        if (!confirm(`Êtes-vous sûr de vouloir générer les récapitulatifs pour :\n\n• Mois : ${moisLabel}\n• Bailleur : ${bailleurLabel}\n\nCette opération peut prendre quelques instants.`)) {
            return;
        }
        
        // Afficher l'état de chargement
        showLoadingState();
        
        // Soumettre le formulaire
        form.submit();
    }
    
    function showLoadingState() {
        btnText.style.display = 'none';
        loadingSpinner.classList.add('show');
        submitBtn.disabled = true;
    }
    
    function hideLoadingState() {
        btnText.style.display = 'inline';
        loadingSpinner.classList.remove('show');
        submitBtn.disabled = false;
    }
    
    function hideSuggestions() {
        suggestionsMois.style.display = 'none';
        suggestionsPreview.style.display = 'none';
    }
    
    function hideCalculationPreview() {
        calculationPreview.style.display = 'none';
        calculationPreview.classList.remove('show');
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('fr-FR', {
            style: 'currency',
            currency: 'XOF',
            minimumFractionDigits: 0
        }).format(amount);
    }
    
    function showNotification(message, type = 'info') {
        // Créer une notification toast
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-supprimer après 5 secondes
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 5000);
    }
    
    function animatePageLoad() {
        // Animation d'entrée pour les éléments principaux
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease-out';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }
    
    // Gestion des erreurs
    window.addEventListener('error', function(e) {
        console.error('Erreur JavaScript:', e.error);
        showNotification('Une erreur est survenue. Veuillez recharger la page.', 'danger');
    });
});
</script>
{% endblock %}
