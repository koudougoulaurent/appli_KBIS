{% extends 'base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .suggestion-badge {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #2196f3;
        color: #1976d2;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 600;
    }
    
    .suggestion-info {
        font-size: 11px;
        color: #666;
        margin-top: 2px;
    }
    
    .status-badge {
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        color: #495057;
    }
    
    .bailleur-name {
        font-weight: 600;
        color: #333;
    }
    
    .bailleur-details {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-12">
            <!-- En-tête de la page -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-{{ page_icon }} text-primary me-2"></i>
                        {{ page_title }}
                    </h1>
                    <p class="text-muted mb-0">{{ description }}</p>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-people"></i>
                        Bailleurs avec Détection Automatique du Mois
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Détection Automatique :</strong> Le mois de récapitulatif est automatiquement détecté en fonction du dernier récapitulatif par bailleur. 
                        <a href="#" data-bs-toggle="modal" data-bs-target="#infoModal" class="alert-link">En savoir plus</a>
                    </div>
                    
                    {% if bailleurs %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Bailleur</th>
                                        <th>Mois Suggéré</th>
                                        <th>Dernier Récapitulatif</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bailleur in bailleurs %}
                                    <tr>
                                        <td>
                                            <div class="bailleur-name">{{ bailleur.get_nom_complet }}</div>
                                            <div class="bailleur-details">
                                                {% if bailleur.telephone %}
                                                    <i class="bi bi-telephone me-1"></i>{{ bailleur.telephone }}
                                                {% endif %}
                                                {% if bailleur.email %}
                                                    <br><i class="bi bi-envelope me-1"></i>{{ bailleur.email }}
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="suggestion-badge">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                {{ bailleur.mois_suggere_formate }}
                                            </div>
                                            <div class="suggestion-info">
                                                {{ bailleur.raison_suggestion }}
                                            </div>
                                        </td>
                                        <td>
                                            {% if bailleur.dernier_mois %}
                                                <span class="badge bg-info">
                                                    <i class="bi bi-calendar-check me-1"></i>
                                                    {{ bailleur.dernier_mois|date:"F Y" }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-calendar-x me-1"></i>
                                                    Aucun
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if bailleur.recap_existant %}
                                                <span class="status-badge bg-success text-white">
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    Existant
                                                </span>
                                                <div class="suggestion-info">
                                                    Créé le {{ bailleur.recap_existant_obj.date_creation|date:"d/m/Y" }}
                                                </div>
                                            {% else %}
                                                <span class="status-badge bg-warning text-dark">
                                                    <i class="bi bi-plus-circle me-1"></i>
                                                    À créer
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if bailleur.recap_existant %}
                                                    <a href="{% url 'paiements:detail_recap_mensuel_auto' recap_id=bailleur.recap_existant_obj.id %}" 
                                                       class="btn btn-info btn-sm" title="Voir le récapitulatif">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <a href="{% url 'paiements:generer_pdf_recap_mensuel' recap_id=bailleur.recap_existant_obj.id %}" 
                                                       class="btn btn-success btn-sm" title="PDF Standard">
                                                        <i class="bi bi-file-pdf"></i>
                                                    </a>
                                                    <a href="{% url 'paiements:generer_pdf_recap_detaille_paysage' recap_id=bailleur.recap_existant_obj.id %}" 
                                                       class="btn btn-info btn-sm" title="PDF Détaillé">
                                                        <i class="bi bi-file-earmark-spreadsheet"></i>
                                                    </a>
                                                    {% if bailleur.recap_existant_obj.statut == 'valide' and bailleur.recap_existant_obj.total_net_a_payer > 0 %}
                                                    <button type="button" class="btn btn-success btn-sm" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#modalPaiement{{ bailleur.recap_existant_obj.id }}"
                                                            title="Payer le Bailleur">
                                                        <i class="bi bi-cash-coin"></i>
                                                    </button>
                                                    {% endif %}
                                                {% else %}
                                                    <a href="{% url 'paiements:creer_recap_avec_detection_auto' bailleur_id=bailleur.id %}" 
                                                       class="btn btn-primary btn-sm" title="Créer avec détection automatique">
                                                        <i class="bi bi-magic"></i>
                                                    </a>
                                                    <a href="{% url 'paiements:creer_recap_mensuel_bailleur' bailleur_id=bailleur.id %}" 
                                                       class="btn btn-outline-primary btn-sm" title="Créer rapidement">
                                                        <i class="bi bi-plus-circle"></i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">Aucun bailleur avec des propriétés actives trouvé.</p>
                        </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="{% url 'paiements:tableau_bord_recaps_mensuels' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i>
                            Retour au Tableau de Bord
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'information sur la détection automatique -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel">
                    <i class="bi bi-lightbulb text-warning me-2"></i>
                    Détection Automatique du Mois de Récapitulatif
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Comment fonctionne la détection automatique ?</h6>
                        
                        <div class="alert alert-light border-start border-primary border-4">
                            <h6 class="alert-heading">
                                <i class="bi bi-1-circle text-primary me-2"></i>
                                Aucun récapitulatif existant
                            </h6>
                            <p class="mb-0">Si le bailleur n'a jamais eu de récapitulatif, le mois actuel est suggéré.</p>
                        </div>
                        
                        <div class="alert alert-light border-start border-warning border-4">
                            <h6 class="alert-heading">
                                <i class="bi bi-2-circle text-warning me-2"></i>
                                Dernier récapitulatif antérieur
                            </h6>
                            <p class="mb-0">Si le dernier récapitulatif est antérieur au mois actuel, le mois actuel est suggéré.</p>
                        </div>
                        
                        <div class="alert alert-light border-start border-success border-4">
                            <h6 class="alert-heading">
                                <i class="bi bi-3-circle text-success me-2"></i>
                                Dernier récapitulatif récent
                            </h6>
                            <p class="mb-0">Si le dernier récapitulatif est récent, le mois suivant est suggéré.</p>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="text-primary mb-3">Avantages de cette approche :</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <strong>Continuité :</strong> Assure une continuité dans la création des récapitulatifs
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <strong>Flexibilité :</strong> Permet de choisir un autre mois si nécessaire
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <strong>Efficacité :</strong> Évite les oublis et les doublons
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <strong>Traçabilité :</strong> Historique complet des récapitulatifs par bailleur
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des badges de suggestion
    const suggestionBadges = document.querySelectorAll('.suggestion-badge');
    suggestionBadges.forEach(badge => {
        badge.style.opacity = '0';
        badge.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            badge.style.transition = 'all 0.3s ease';
            badge.style.opacity = '1';
            badge.style.transform = 'translateY(0)';
        }, 100);
    });
    
    // Tooltip pour les boutons d'action
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<!-- Modals de Paiement pour chaque bailleur -->
{% for bailleur in bailleurs %}
    {% if bailleur.recap_existant_obj.statut == 'valide' and bailleur.recap_existant_obj.total_net_a_payer > 0 %}
    <div class="modal fade" id="modalPaiement{{ bailleur.recap_existant_obj.id }}" tabindex="-1" aria-labelledby="modalPaiementLabel{{ bailleur.recap_existant_obj.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalPaiementLabel{{ bailleur.recap_existant_obj.id }}">
                        <i class="bi bi-cash-coin me-2"></i>
                        Payer le Bailleur
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Informations du récapitulatif -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle me-2"></i>
                            Informations du Récapitulatif
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Bailleur :</strong> {{ bailleur.get_nom_complet }}<br>
                                <strong>Mois :</strong> {{ bailleur.recap_existant_obj.mois_recap|date:"F Y" }}
                            </div>
                            <div class="col-md-6">
                                <strong>Loyers Bruts :</strong> {{ bailleur.recap_existant_obj.total_loyers_bruts|floatformat:0|intcomma }} F CFA<br>
                                <strong>Charges :</strong> {{ bailleur.recap_existant_obj.total_charges_deductibles|floatformat:0|intcomma }} F CFA<br>
                                <strong class="text-success">Net à Payer :</strong> <span class="h5 text-success">{{ bailleur.recap_existant_obj.total_net_a_payer|floatformat:0|intcomma }} F CFA</span>
                            </div>
                        </div>
                    </div>

                    <!-- Formulaire de paiement -->
                    <form id="formPaiement{{ bailleur.recap_existant_obj.id }}" method="post" action="{% url 'paiements:creer_retrait_depuis_recap' recap_id=bailleur.recap_existant_obj.id %}">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mode_retrait{{ bailleur.recap_existant_obj.id }}" class="form-label">
                                        <i class="bi bi-credit-card me-1"></i>
                                        Mode de Paiement
                                    </label>
                                    <select name="mode_retrait" id="mode_retrait{{ bailleur.recap_existant_obj.id }}" class="form-select" required>
                                        <option value="">-- Sélectionner un mode --</option>
                                        <option value="virement" selected>Virement bancaire</option>
                                        <option value="cheque">Chèque</option>
                                        <option value="especes">Espèces</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="reference_retrait{{ bailleur.recap_existant_obj.id }}" class="form-label">
                                        <i class="bi bi-hash me-1"></i>
                                        Référence
                                    </label>
                                    <input type="text" name="reference_retrait" id="reference_retrait{{ bailleur.recap_existant_obj.id }}" 
                                           class="form-control" placeholder="Référence du paiement (optionnel)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="observations{{ bailleur.recap_existant_obj.id }}" class="form-label">
                                <i class="bi bi-chat-text me-1"></i>
                                Observations
                            </label>
                            <textarea name="observations" id="observations{{ bailleur.recap_existant_obj.id }}" class="form-control" rows="3" 
                                      placeholder="Observations sur ce paiement...">{{ bailleur.recap_existant_obj.mois_recap|date:"F Y" }} - Paiement basé sur le récapitulatif mensuel</textarea>
                        </div>
                        
                        <!-- Résumé du paiement -->
                        <div class="alert alert-success">
                            <h6 class="alert-heading">
                                <i class="bi bi-check-circle me-2"></i>
                                Résumé du Paiement
                            </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Bailleur :</strong><br>
                                    {{ bailleur.get_nom_complet }}
                                </div>
                                <div class="col-md-4">
                                    <strong>Mois :</strong><br>
                                    {{ bailleur.recap_existant_obj.mois_recap|date:"F Y" }}
                                </div>
                                <div class="col-md-4">
                                    <strong>Montant :</strong><br>
                                    <span class="h5 text-success">{{ bailleur.recap_existant_obj.total_net_a_payer|floatformat:0|intcomma }} F CFA</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>
                        Annuler
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmerPaiement{{ bailleur.recap_existant_obj.id }}()">
                        <i class="bi bi-cash-coin me-2"></i>
                        Confirmer le Paiement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-générer une référence si virement sélectionné
        const modeSelect{{ bailleur.recap_existant_obj.id }} = document.getElementById('mode_retrait{{ bailleur.recap_existant_obj.id }}');
        const referenceInput{{ bailleur.recap_existant_obj.id }} = document.getElementById('reference_retrait{{ bailleur.recap_existant_obj.id }}');
        
        if (modeSelect{{ bailleur.recap_existant_obj.id }} && referenceInput{{ bailleur.recap_existant_obj.id }}) {
            modeSelect{{ bailleur.recap_existant_obj.id }}.addEventListener('change', function() {
                if (this.value === 'virement' && !referenceInput{{ bailleur.recap_existant_obj.id }}.value) {
                    const now = new Date();
                    const reference = 'VIR-' + now.getFullYear() + 
                                    String(now.getMonth() + 1).padStart(2, '0') + 
                                    String(now.getDate()).padStart(2, '0') + '-' +
                                    Math.random().toString(36).substr(2, 6).toUpperCase();
                    referenceInput{{ bailleur.recap_existant_obj.id }}.value = reference;
                }
            });
            
            // Auto-générer la référence au chargement si virement est sélectionné
            if (modeSelect{{ bailleur.recap_existant_obj.id }}.value === 'virement' && !referenceInput{{ bailleur.recap_existant_obj.id }}.value) {
                const now = new Date();
                const reference = 'VIR-' + now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '-' +
                                Math.random().toString(36).substr(2, 6).toUpperCase();
                referenceInput{{ bailleur.recap_existant_obj.id }}.value = reference;
            }
        }
    });

    function confirmerPaiement{{ bailleur.recap_existant_obj.id }}() {
        const mode = document.getElementById('mode_retrait{{ bailleur.recap_existant_obj.id }}').value;
        if (!mode) {
            alert('Veuillez sélectionner un mode de paiement.');
            document.getElementById('mode_retrait{{ bailleur.recap_existant_obj.id }}').focus();
            return false;
        }
        
        // Confirmation
        const montant = '{{ bailleur.recap_existant_obj.total_net_a_payer|floatformat:2 }}';
        const bailleur = '{{ bailleur.get_nom_complet }}';
        const mois = '{{ bailleur.recap_existant_obj.mois_recap|date:"F Y" }}';
        
        if (confirm(`Confirmer le paiement pour ${bailleur} - ${mois} - Montant: ${montant} F CFA ?`)) {
            document.getElementById('formPaiement{{ bailleur.recap_existant_obj.id }}').submit();
        }
    }
    </script>
    {% endif %}
{% endfor %}
{% endblock %}

