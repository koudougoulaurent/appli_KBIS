{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}
    Paiements de Caution et Avance - Rentila
{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .status-en_attente {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-valide {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-rejete {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-annule {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    .type-badge {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .montant-highlight {
        font-weight: 700;
        color: #28a745;
        font-size: 1.1rem;
    }
    
    .filters-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .btn-action {
        min-width: 100px;
        margin: 2px;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    
    .table th {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        font-weight: 600;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .pagination-info {
        background: #e9ecef;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-credit-card text-primary me-2"></i>
                        Paiements de Caution et Avance
                    </h1>
                    <p class="text-muted mb-0">
                        Gestion complète des paiements de caution et d'avance de loyer
                    </p>
                </div>
                <a href="{% url 'paiements:paiement_caution_avance_create' %}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-2"></i> Nouveau Paiement
                </a>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filters-section">
        <h5 class="mb-3">
            <i class="bi bi-funnel me-2"></i> Filtres de Recherche
        </h5>
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="contrat" class="form-label">Contrat</label>
                <select name="contrat" id="contrat" class="form-select">
                    <option value="">Tous les contrats</option>
                    {% for contrat in contrats %}
                        <option value="{{ contrat.id }}" {% if request.GET.contrat == contrat.id|stringformat:"s" %}selected{% endif %}>
                            {{ contrat.numero_contrat }} - {{ contrat.propriete.titre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="type_paiement" class="form-label">Type</label>
                <select name="type_paiement" id="type_paiement" class="form-select">
                    <option value="">Tous les types</option>
                    {% for value, label in types_paiement %}
                        <option value="{{ value }}" {% if request.GET.type_paiement == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="statut" class="form-label">Statut</label>
                <select name="statut" id="statut" class="form-select">
                    <option value="">Tous les statuts</option>
                    {% for value, label in statuts %}
                        <option value="{{ value }}" {% if request.GET.statut == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="date_debut" class="form-label">Date début</label>
                <input type="date" name="date_debut" id="date_debut" class="form-control" 
                       value="{{ request.GET.date_debut }}">
            </div>
            <div class="col-md-2">
                <label for="date_fin" class="form-label">Date fin</label>
                <input type="date" name="date_fin" id="date_fin" class="form-control" 
                       value="{{ request.GET.date_fin }}">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Statistiques rapides -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ paginator.count }}</h4>
                    <small>Total Paiements</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ paginator.count|default:0|add:"0" }}</h4>
                    <small>Paiements Validés</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ paginator.count|default:0|add:"0" }}</h4>
                    <small>En Attente</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ paginator.count|default:0|add:"0" }}</h4>
                    <small>Reçus Générés</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des paiements -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-ul me-2"></i> Liste des Paiements
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Contrat</th>
                            <th>Type</th>
                            <th>Montant</th>
                            <th>Payeur</th>
                            <th>Date</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for paiement in paiements %}
                        <tr>
                            <td>
                                <div>
                                    <strong>{{ paiement.contrat.numero_contrat }}</strong><br>
                                    <small class="text-muted">{{ paiement.contrat.propriete.titre }}</small>
                                </div>
                            </td>
                            <td>
                                <span class="type-badge">
                                    {{ paiement.get_type_paiement_display }}
                                </span>
                            </td>
                            <td>
                                <div class="montant-highlight">
                                    {{ paiement.get_montant_total_formatted }}
                                </div>
                                {% if paiement.type_paiement == 'caution_et_avance' %}
                                    <small class="text-muted">
                                        C: {{ paiement.get_montant_caution_formatted }} | 
                                        A: {{ paiement.get_montant_avance_formatted }}
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                <div>
                                    <strong>{{ paiement.nom_payeur }}</strong><br>
                                    {% if paiement.telephone_payeur %}
                                        <small class="text-muted">{{ paiement.telephone_payeur }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ paiement.date_paiement|date:"d/m/Y" }}</strong><br>
                                    <small class="text-muted">{{ paiement.mode_paiement|title }}</small>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge status-{{ paiement.statut }}">
                                    {{ paiement.get_statut_display }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group-vertical btn-group-sm">
                                    <a href="{% url 'paiements:detail' paiement.pk %}" 
                                       class="btn btn-outline-primary btn-action" title="Voir détails">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'paiements:modifier_paiement' paiement.pk %}" 
                                       class="btn btn-outline-warning btn-action" title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% if paiement.peut_etre_valide %}
                                        <a href="{% url 'paiements:valider_paiement' paiement.pk %}" 
                                           class="btn btn-outline-success btn-action" title="Valider">
                                            <i class="bi bi-check-circle"></i>
                                        </a>
                                    {% endif %}
                                    {% if paiement.statut == 'valide' and not paiement.recu_genere %}
                                        <a href="{% url 'paiements:generer_recu_caution_avance' paiement.pk %}" 
                                           class="btn btn-outline-info btn-action" title="Générer reçu">
                                            <i class="bi bi-receipt"></i>
                                        </a>
                                    {% endif %}
                                    {% if paiement.recu_genere %}
                                        <a href="{% url 'paiements:telecharger_recu_caution_avance' paiement.pk %}" 
                                           class="btn btn-outline-secondary btn-action" title="Télécharger reçu">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox display-4"></i>
                                    <p class="mt-3">Aucun paiement de caution ou avance trouvé</p>
                                    <a href="{% url 'paiements:paiement_caution_avance_create' %}" class="btn btn-primary">
                                        Créer le premier paiement
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="pagination-info">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                Affichage de {{ page_obj.start_index }} à {{ page_obj.end_index }} 
                sur {{ paginator.count }} paiements
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">{{ page_obj.number }} / {{ paginator.num_pages }}</span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Réinitialiser les filtres
    document.getElementById('reset-filters').addEventListener('click', function() {
        window.location.href = '{% url "paiements:paiement_caution_avance_list" %}';
    });
    
    // Auto-submit des filtres lors du changement
    const filterSelects = document.querySelectorAll('#contrat, #type_paiement, #statut');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            this.closest('form').submit();
        });
    });
});
</script>
{% endblock %}
