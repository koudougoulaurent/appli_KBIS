{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load bootstrap5 %}

{% block title %}Paiement Partiel - Gestion Intelligente{% endblock %}

{% block extra_css %}
<style>
    .paiement-partiel-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .paiement-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .paiement-header {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 2rem;
        text-align: center;
    }
    
    .paiement-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
    }
    
    .paiement-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .info-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
    }
    
    .info-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        border-left: 5px solid #28a745;
    }
    
    .info-card.warning {
        border-left-color: #ffc107;
    }
    
    .info-card.danger {
        border-left-color: #dc3545;
    }
    
    .info-card h3 {
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }
    
    .info-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #28a745;
    }
    
    .info-card.warning .value {
        color: #ffc107;
    }
    
    .info-card.danger .value {
        color: #dc3545;
    }
    
    .form-section {
        padding: 2rem;
    }
    
    .contrat-selector {
        background: #e3f2fd;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .contrat-info {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 5px solid #007bff;
    }
    
    .historique-section {
        background: #fff3cd;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .paiement-item {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #28a745;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-paiement-partiel {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-paiement-partiel:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        color: white;
    }
    
    .btn-secondary-custom {
        background: #6c757d;
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-secondary-custom:hover {
        background: #5a6268;
        color: white;
        transform: translateY(-1px);
    }
    
    .smart-suggestions {
        background: #e8f5e8;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1rem;
        border-left: 5px solid #28a745;
    }
    
    .suggestion-item {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-left: 3px solid #28a745;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
    }
</style>
{% endblock %}

{% block content %}
<div class="paiement-partiel-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="paiement-card">
                    <!-- Header -->
                    <div class="paiement-header">
                        <h1><i class="bi bi-pie-chart me-3"></i>Paiement Partiel</h1>
                        <p>Gestion intelligente des paiements partiels avec suivi en temps réel</p>
                    </div>
                    
                    <!-- Informations générales -->
                    <div class="info-cards">
                        <div class="info-card">
                            <h3>Montant Net à Payer</h3>
                            <div class="value">{{ net_a_payer|floatformat:0 }} FCFA</div>
                        </div>
                        <div class="info-card warning">
                            <h3>Montant Restant</h3>
                            <div class="value">{{ montant_restant|floatformat:0 }} FCFA</div>
                        </div>
                        <div class="info-card danger">
                            <h3>Paiements Partiels</h3>
                            <div class="value">{{ paiements_partiels_existants }}</div>
                        </div>
                    </div>
                    
                    <!-- Sélecteur de contrat -->
                    <div class="contrat-selector">
                        <h4><i class="bi bi-building me-2"></i>Sélection du Contrat</h4>
                        <form method="GET" id="contratForm">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="contrat_id" class="form-label">Contrat</label>
                                    <select name="contrat_id" id="contrat_id" class="form-select" onchange="this.form.submit()">
                                        <option value="">-- Sélectionner un contrat --</option>
                                        {% for contrat in contrats %}
                                        <option value="{{ contrat.id }}" {% if contrat.id|stringformat:"s" == contrat_id %}selected{% endif %}>
                                            {{ contrat.locataire.nom }} - {{ contrat.propriete.nom_propriete }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="mois" class="form-label">Mois</label>
                                    <select name="mois" id="mois" class="form-select" onchange="this.form.submit()">
                                        <option value="">-- Mois --</option>
                                        {% for i in "123456789012"|make_list %}
                                        <option value="{{ i }}" {% if i == mois_selectionne %}selected{% endif %}>
                                            {{ i|add:0|date:"F" }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="annee" class="form-label">Année</label>
                                    <select name="annee" id="annee" class="form-select" onchange="this.form.submit()">
                                        <option value="">-- Année --</option>
                                        {% for annee in "2023,2024,2025,2026"|split:"," %}
                                        <option value="{{ annee }}" {% if annee == annee_selectionnee %}selected{% endif %}>
                                            {{ annee }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-search me-1"></i>Analyser
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Informations du contrat sélectionné -->
                    {% if contrat_obj %}
                    <div class="contrat-info">
                        <h4><i class="bi bi-info-circle me-2"></i>Informations du Contrat</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Locataire:</strong> {{ contrat_obj.locataire.nom }}</p>
                                <p><strong>Propriété:</strong> {{ contrat_obj.propriete.nom_propriete }}</p>
                                <p><strong>Loyer Mensuel:</strong> {{ contrat_obj.montant_loyer_mensuel|floatformat:0 }} FCFA</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Charges Bailleur:</strong> {{ total_charges_bailleur|floatformat:0 }} FCFA</p>
                                <p><strong>Net à Payer:</strong> {{ net_a_payer|floatformat:0 }} FCFA</p>
                                <p><strong>Montant Restant:</strong> <span class="text-warning fw-bold">{{ montant_restant|floatformat:0 }} FCFA</span></p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Formulaire de paiement partiel -->
                    <div class="form-section">
                        <h4><i class="bi bi-plus-circle me-2"></i>Nouveau Paiement Partiel</h4>
                        
                        {% if contrat_obj %}
                        <form method="POST" id="paiementForm">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.contrat|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.montant|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    {{ form.type_paiement|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.mode_paiement|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.date_paiement|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.mois_paye|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.reference_paiement|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    {{ form.notes|as_crispy_field }}
                                </div>
                            </div>
                            
                    <!-- Suggestions intelligentes -->
                    {% if montant_restant > 0 %}
                    <div class="smart-suggestions">
                        <h5><i class="bi bi-lightbulb me-2"></i>Suggestions Intelligentes</h5>
                        <div class="suggestion-item">
                            <strong>Montant suggéré:</strong> {{ montant_restant|floatformat:0 }} FCFA (montant restant)
                        </div>
                        {% if montant_restant > 50000 %}
                        <div class="suggestion-item">
                            <strong>Paiement partiel recommandé:</strong> {{ montant_restant|floatformat:0|add:"-10000" }} FCFA (laisser 10,000 FCFA pour le prochain paiement)
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Information importante sur les paiements partiels -->
                    <div class="alert alert-info mt-3">
                        <h6><i class="bi bi-info-circle me-2"></i>Important - Paiements Partiels</h6>
                        <ul class="mb-0">
                            <li><strong>Pas de reçu :</strong> Les paiements partiels ne génèrent pas de reçu automatiquement</li>
                            <li><strong>Pas dans la liste :</strong> Ils n'apparaissent pas dans la liste des paiements définitifs</li>
                            <li><strong>Complétion :</strong> Un reçu sera généré uniquement après complétion du paiement total</li>
                            <li><strong>Suivi :</strong> Utilisez l'historique des paiements partiels pour suivre les montants</li>
                        </ul>
                    </div>
                            
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-paiement-partiel me-3">
                                    <i class="bi bi-check-circle me-2"></i>Enregistrer le Paiement Partiel
                                </button>
                                <a href="{% url 'paiements:dashboard' %}" class="btn btn-secondary-custom">
                                    <i class="bi bi-arrow-left me-2"></i>Retour au Dashboard
                                </a>
                            </div>
                        </form>
                        {% else %}
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle me-2"></i>
                            Veuillez sélectionner un contrat pour commencer l'enregistrement d'un paiement partiel.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Historique des paiements partiels -->
                    {% if historique %}
                    <div class="historique-section">
                        <h4><i class="bi bi-clock-history me-2"></i>Historique des Paiements Partiels</h4>
                        <p class="text-muted">Paiements partiels pour {{ contrat_obj.locataire.nom }} - {{ mois_selectionne|add:0|date:"F" }} {{ annee_selectionnee }}</p>
                        
                        {% for paiement in historique %}
                        <div class="paiement-item">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <strong>{{ paiement.reference_paiement }}</strong>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-success">{{ paiement.montant|floatformat:0 }} FCFA</span>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-info">{{ paiement.type_paiement }}</span>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-secondary">{{ paiement.mode_paiement }}</span>
                                </div>
                                <div class="col-md-2">
                                    {{ paiement.date_paiement|date:"d/m/Y" }}
                                </div>
                                <div class="col-md-1">
                                    <span class="badge bg-warning">Partiel</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-2">Traitement en cours...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit du formulaire de sélection de contrat
    const contratForm = document.getElementById('contratForm');
    if (contratForm) {
        const selects = contratForm.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('loadingSpinner').style.display = 'block';
                }
            });
        });
    }
    
    // Auto-remplissage du formulaire de paiement
    const paiementForm = document.getElementById('paiementForm');
    if (paiementForm) {
        // Pré-remplir le contrat si sélectionné
        const contratId = '{{ contrat_id }}';
        if (contratId) {
            const contratSelect = paiementForm.querySelector('select[name="contrat"]');
            if (contratSelect) {
                contratSelect.value = contratId;
            }
        }
        
        // Pré-remplir le mois si sélectionné
        const moisSelectionne = '{{ mois_selectionne }}';
        if (moisSelectionne) {
            const moisInput = paiementForm.querySelector('input[name="mois_paye"]');
            if (moisInput && anneeSelectionnee) {
                const anneeSelectionnee = '{{ annee_selectionnee }}';
                moisInput.value = anneeSelectionnee + '-' + moisSelectionne.padStart(2, '0') + '-01';
            }
        }
        
        // Suggestion de montant
        const montantRestant = {{ montant_restant|default:0 }};
        if (montantRestant > 0) {
            const montantInput = paiementForm.querySelector('input[name="montant"]');
            if (montantInput && !montantInput.value) {
                montantInput.value = montantRestant;
                montantInput.focus();
            }
        }
    }
    
    // Masquer le spinner après chargement
    setTimeout(function() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }, 1000);
});
</script>
{% endblock %}
