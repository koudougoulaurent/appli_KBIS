{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ plan.nom_plan }} - Détail du Plan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
    .plan-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .plan-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .plan-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .progress-ring {
        width: 120px;
        height: 120px;
        transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
        stroke: rgba(255,255,255,0.3);
        stroke-width: 8;
        fill: transparent;
        r: 52;
        cx: 60;
        cy: 60;
    }
    
    .progress-ring-progress {
        stroke: white;
        stroke-width: 8;
        fill: transparent;
        r: 52;
        cx: 60;
        cy: 60;
        stroke-dasharray: 326.73;
        stroke-dashoffset: 326.73;
        transition: stroke-dashoffset 0.5s ease;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: 1px solid #e3e6f0;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #858796;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .echelon-item {
        border: 1px solid #e3e6f0;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
        transition: all 0.3s ease;
    }
    
    .echelon-item:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .echelon-item.en-retard {
        border-left: 4px solid #e74a3b;
        background: #fdf2f2;
    }
    
    .echelon-item.paye {
        border-left: 4px solid #1cc88a;
        background: #f0f9ff;
    }
    
    .echelon-item.en-attente {
        border-left: 4px solid #f6c23e;
        background: #fffbf0;
    }
    
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-paye {
        background: #d4edda;
        color: #155724;
    }
    
    .status-en-attente {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-en-retard {
        background: #f8d7da;
        color: #721c24;
    }
    
    .paiement-item {
        background: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .alert-item {
        border-left: 4px solid #f5576c;
        background: #fff5f5;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0 8px 8px 0;
    }
    
    .alert-item.critique {
        border-left-color: #e53e3e;
        background: #fed7d7;
    }
    
    .alert-item.eleve {
        border-left-color: #f56565;
        background: #fef5e7;
    }
    
    .alert-item.moyen {
        border-left-color: #f6ad55;
        background: #fef5e7;
    }
    
    .alert-item.faible {
        border-left-color: #68d391;
        background: #f0fff4;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .btn-action {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-primary-action {
        background: #4e73df;
        color: white;
        border: 1px solid #4e73df;
    }
    
    .btn-primary-action:hover {
        background: #224abe;
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-success-action {
        background: #1cc88a;
        color: white;
        border: 1px solid #1cc88a;
    }
    
    .btn-success-action:hover {
        background: #17a673;
        color: white;
    }
    
    .btn-warning-action {
        background: #f6c23e;
        color: white;
        border: 1px solid #f6c23e;
    }
    
    .btn-warning-action:hover {
        background: #dda20a;
        color: white;
    }
    
    .btn-secondary-action {
        background: #858796;
        color: white;
        border: 1px solid #858796;
    }
    
    .btn-secondary-action:hover {
        background: #6c757d;
        color: white;
    }
    
    .timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e3e6f0;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -0.5rem;
        top: 0.5rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #4e73df;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #e3e6f0;
    }
    
    .timeline-item.paye::before {
        background: #1cc88a;
    }
    
    .timeline-item.retard::before {
        background: #e74a3b;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Header du plan -->
    <div class="plan-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="plan-title">{{ plan.nom_plan }}</h1>
                <p class="plan-subtitle">
                    <i class="fas fa-hashtag me-2"></i>{{ plan.numero_plan }} • 
                    <i class="fas fa-user me-2"></i>{{ plan.contrat.locataire.nom }} {{ plan.contrat.locataire.prenom }} • 
                    <i class="fas fa-calendar me-2"></i>{{ plan.date_creation|date:"d/m/Y à H:i" }}
                </p>
                {% if plan.description %}
                <p class="mt-3 mb-0">{{ plan.description }}</p>
                {% endif %}
            </div>
            <div class="col-md-4 text-center">
                <div class="progress-ring">
                    <svg class="progress-ring">
                        <circle class="progress-ring-circle"></circle>
                        <circle class="progress-ring-progress" 
                                style="stroke-dashoffset: {{ 326.73|add:0|sub:326.73|mul:stats.progression_pourcentage|div:100|floatformat:0 }}"></circle>
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <div class="h4 mb-0">{{ stats.progression_pourcentage|floatformat:0 }}%</div>
                        <small>Terminé</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions principales -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="action-buttons">
                <a href="{% url 'paiements:ajouter_partiel' plan.id %}" 
                   class="btn-action btn-success-action">
                    <i class="fas fa-credit-card"></i>Effectuer un Paiement
                </a>
                
                <a href="{% url 'paiements:generer_echelons' plan.id %}" 
                   class="btn-action btn-warning-action">
                    <i class="fas fa-calendar-plus"></i>Générer des Échelons
                </a>
                
                <a href="{% url 'paiements:ajouter_echelon' plan.id %}" 
                   class="btn-action btn-secondary-action">
                    <i class="fas fa-plus"></i>Ajouter un Échelon
                </a>
                
                {% if plan.peut_etre_modifie %}
                <a href="{% url 'paiements:modifier_plan' plan.id %}" 
                   class="btn-action btn-primary-action">
                    <i class="fas fa-edit"></i>Modifier le Plan
                </a>
                {% endif %}
                
                <a href="{% url 'paiements:liste_plans_partiels' %}" 
                   class="btn-action btn-secondary-action">
                    <i class="fas fa-arrow-left"></i>Retour à la Liste
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card text-center">
                <div class="stat-value text-primary">{{ plan.montant_total|floatformat:0|intcomma }}</div>
                <div class="stat-label">Montant Total (FCFA)</div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card text-center">
                <div class="stat-value text-success">{{ plan.montant_deja_paye|floatformat:0|intcomma }}</div>
                <div class="stat-label">Montant Payé (FCFA)</div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card text-center">
                <div class="stat-value text-warning">{{ plan.montant_restant|floatformat:0|intcomma }}</div>
                <div class="stat-label">Montant Restant (FCFA)</div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card text-center">
                <div class="stat-value text-info">{{ stats.total_echelons }}</div>
                <div class="stat-label">Total Échelons</div>
            </div>
        </div>
    </div>

    <!-- Détails du plan -->
    <div class="row mb-4">
        <div class="col-xl-8 col-lg-12 mb-4">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-ol text-primary me-2"></i>
                        Échelons de Paiement
                    </h5>
                </div>
                <div class="card-body">
                    {% if echelons %}
                        <div class="timeline">
                            {% for echelon in echelons %}
                            <div class="timeline-item {{ echelon.statut }}">
                                <div class="echelon-item {{ echelon.statut }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                Échelon {{ echelon.numero_echelon }} - {{ echelon.montant|floatformat:0|intcomma }} FCFA
                                            </h6>
                                            <p class="mb-1 text-muted">
                                                <i class="fas fa-calendar me-1"></i>
                                                Échéance: {{ echelon.date_echeance|date:"d/m/Y" }}
                                                {% if echelon.date_paiement %}
                                                    • Payé le: {{ echelon.date_paiement|date:"d/m/Y à H:i" }}
                                                {% endif %}
                                            </p>
                                            {% if echelon.est_en_retard %}
                                            <small class="text-danger">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                En retard depuis {{ echelon.date_echeance|timesince }}
                                            </small>
                                            {% endif %}
                                        </div>
                                        <span class="status-badge status-{{ echelon.statut }}">
                                            {{ echelon.get_statut_display }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-plus fa-3x mb-3"></i>
                            <p>Aucun échelon défini pour ce plan</p>
                            <a href="{% url 'paiements:generer_echelons' plan.id %}" class="btn btn-primary">
                                <i class="fas fa-calendar-plus me-2"></i>Générer des Échelons
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-xl-4 col-lg-12 mb-4">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-credit-card text-success me-2"></i>
                        Paiements Effectués
                    </h5>
                </div>
                <div class="card-body">
                    {% if paiements %}
                        {% for paiement in paiements %}
                        <div class="paiement-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ paiement.motif }}</h6>
                                    <p class="mb-1 text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ paiement.date_paiement|date:"d/m/Y à H:i" }}
                                    </p>
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        {{ paiement.get_statut_display }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="h6 mb-0 text-success">{{ paiement.montant|floatformat:0|intcomma }} FCFA</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-credit-card fa-3x mb-3"></i>
                            <p>Aucun paiement effectué</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes -->
    {% if alertes %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell text-warning me-2"></i>
                        Alertes Actives
                    </h5>
                </div>
                <div class="card-body">
                    {% for alerte in alertes %}
                    <div class="alert-item {{ alerte.niveau_urgence }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ alerte.get_type_alerte_display }}</h6>
                                <p class="mb-1">{{ alerte.message }}</p>
                                <small class="text-muted">
                                    {{ alerte.date_creation|timesince }} • 
                                    Créée par {{ alerte.cree_par.get_full_name|default:alerte.cree_par.username }}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="status-badge status-{{ alerte.niveau_urgence }}">
                                    {{ alerte.get_niveau_urgence_display }}
                                </span>
                                <br>
                                <a href="{% url 'paiements:traiter_alerte' alerte.id %}" 
                                   class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="fas fa-check"></i> Traiter
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Informations du contrat -->
    <div class="row">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-contract text-info me-2"></i>
                        Informations du Contrat
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Locataire</h6>
                            <p class="text-muted">
                                {{ plan.contrat.locataire.nom }} {{ plan.contrat.locataire.prenom }}<br>
                                <i class="fas fa-envelope me-1"></i>{{ plan.contrat.locataire.email|default:"Non renseigné" }}<br>
                                <i class="fas fa-phone me-1"></i>{{ plan.contrat.locataire.telephone|default:"Non renseigné" }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Propriété</h6>
                            <p class="text-muted">
                                {{ plan.contrat.propriete.adresse }}<br>
                                {{ plan.contrat.propriete.ville }} {{ plan.contrat.propriete.code_postal }}<br>
                                <i class="fas fa-home me-1"></i>{{ plan.contrat.propriete.type_bien.nom }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/components.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation de la barre de progression
    const progressRing = document.querySelector('.progress-ring-progress');
    if (progressRing) {
        const percentage = {{ stats.progression_pourcentage|floatformat:0 }};
        const circumference = 326.73;
        const offset = circumference - (percentage / 100) * circumference;
        
        setTimeout(() => {
            progressRing.style.strokeDashoffset = offset;
        }, 500);
    }
    
    // Animation des cartes
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Animation des échelons
    const echelonItems = document.querySelectorAll('.echelon-item');
    echelonItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
        }, index * 100 + 200);
    });
});
</script>
{% endblock %}
