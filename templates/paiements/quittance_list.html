{% extends 'base_dashboard.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Liste des quittances de paiement{% endblock %}

{% block extra_css %}
<style>
    .quittance-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .quittance-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .quittance-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 1rem;
    }
    
    .quittance-number {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .quittance-date {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .quittance-body {
        padding: 1.5rem;
    }
    
    .quittance-info {
        margin-bottom: 1rem;
    }
    
    .quittance-info .label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }
    
    .quittance-info .value {
        color: #212529;
        font-size: 0.95rem;
    }
    
    .quittance-amount {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 1rem 0;
    }
    
    .amount-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
    }
    
    .status-generee { background: #d1ecf1; color: #0c5460; }
    .status-imprimee { background: #d4edda; color: #155724; }
    .status-envoyee { background: #cce5ff; color: #004085; }
    .status-archivée { background: #e2e3e5; color: #383d41; }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .stats-cards {
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .search-filters {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- En-tête de la page -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-receipt me-2"></i>Quittances de paiement
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{% url 'core:dashboard' %}">Tableau de bord</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{% url 'paiements:liste' %}">Paiements</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Quittances</li>
                        </ol>
                    </nav>
                </div>
                
                <div>
                    <a href="{% url 'paiements:liste' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Retour aux paiements
                    </a>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row stats-cards">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ total_quittances }}</div>
                        <div class="stat-label">Total des quittances</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ quittances_imprimees }}</div>
                        <div class="stat-label">Quittances imprimées</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ quittances_envoyees }}</div>
                        <div class="stat-label">Quittances envoyées</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ total_quittances|add:"-1"|add:"-"|add:quittances_imprimees|add:"-"|add:quittances_envoyees }}</div>
                        <div class="stat-label">En attente</div>
                    </div>
                </div>
            </div>

            <!-- Filtres et recherche -->
            <div class="search-filters">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="statut" class="form-label">Statut</label>
                        <select name="statut" id="statut" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option value="generee" {% if request.GET.statut == 'generee' %}selected{% endif %}>Générée</option>
                            <option value="imprimee" {% if request.GET.statut == 'imprimee' %}selected{% endif %}>Imprimée</option>
                            <option value="envoyee" {% if request.GET.statut == 'envoyee' %}selected{% endif %}>Envoyée</option>
                            <option value="archivée" {% if request.GET.statut == 'archivée' %}selected{% endif %}>Archivée</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="date_debut" class="form-label">Date début</label>
                        <input type="date" class="form-control" id="date_debut" name="date_debut" 
                               value="{{ request.GET.date_debut }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_fin" class="form-label">Date fin</label>
                        <input type="date" class="form-control" id="date_fin" name="date_fin" 
                               value="{{ request.GET.date_fin }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Filtrer
                            </button>
                            <a href="{% url 'paiements:quittance_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Réinitialiser
                            </a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Liste des quittances -->
            <div class="row">
                {% for quittance in quittances %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card quittance-card">
                        <div class="quittance-header">
                            <div class="quittance-number">{{ quittance.numero_quittance }}</div>
                            <div class="quittance-date">
                                Émise le {{ quittance.date_emission|date:"d/m/Y" }}
                            </div>
                        </div>
                        
                        <div class="quittance-body">
                            <!-- Informations du locataire -->
                            <div class="quittance-info">
                                <div class="label">Locataire</div>
                                <div class="value">{{ quittance.get_locataire.get_nom_complet }}</div>
                            </div>
                            
                            <!-- Informations de la propriété -->
                            <div class="quittance-info">
                                <div class="label">Propriété</div>
                                <div class="value">{{ quittance.get_propriete.adresse }}, {{ quittance.get_propriete.ville }}</div>
                            </div>
                            
                            <!-- Montant -->
                            <div class="quittance-amount">
                                <div class="amount-value">{{ quittance.paiement.get_montant_formatted }}</div>
                                <div class="text-muted">Montant payé</div>
                            </div>
                            
                            <!-- Statut -->
                            <div class="text-center mb-3">
                                <span class="status-badge status-{{ quittance.statut }}">
                                    {{ quittance.get_statut_display }}
                                </span>
                            </div>
                            
                            <!-- Boutons d'action -->
                            <div class="action-buttons">
                                <a href="{% url 'paiements:quittance_detail' quittance.pk %}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i>Voir
                                </a>
                                
                                {% if quittance.statut == 'generee' %}
                                <form method="post" action="{% url 'paiements:marquer_quittance_envoyee' quittance.pk %}" 
                                      class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-send me-1"></i>Envoyer
                                    </button>
                                </form>
                                {% endif %}
                                
                                {% if quittance.statut in 'generee,imprimee,envoyee' %}
                                <form method="post" action="{% url 'paiements:marquer_quittance_archivee' quittance.pk %}" 
                                      class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-secondary btn-sm">
                                        <i class="bi bi-archive me-1"></i>Archiver
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="bi bi-receipt" style="font-size: 3rem; color: #6c757d;"></i>
                        <h4 class="mt-3 text-muted">Aucune quittance trouvée</h4>
                        <p class="text-muted">Les quittances apparaîtront ici après validation des paiements.</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if quittances.has_other_pages %}
            <nav aria-label="Pagination des quittances" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if quittances.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ quittances.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in quittances.paginator.page_range %}
                        {% if quittances.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > quittances.number|add:'-3' and num < quittances.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if quittances.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ quittances.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des filtres de date
    const dateDebut = document.getElementById('date_debut');
    const dateFin = document.getElementById('date_fin');
    
    // Définir la date de fin par défaut à aujourd'hui
    if (!dateFin.value) {
        const today = new Date();
        dateFin.value = today.toISOString().split('T')[0];
    }
    
    // Définir la date de début par défaut à il y a 30 jours
    if (!dateDebut.value) {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        dateDebut.value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    
    // Validation des dates
    dateDebut.addEventListener('change', function() {
        if (dateFin.value && dateDebut.value > dateFin.value) {
            dateFin.value = dateDebut.value;
        }
    });
    
    dateFin.addEventListener('change', function() {
        if (dateDebut.value && dateFin.value < dateDebut.value) {
            dateDebut.value = dateFin.value;
        }
    });
});
</script>
{% endblock %}
