{% extends 'base_dashboard.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title }} - Gestion Immobili√®re{% endblock %}

{% block extra_css %}
<style>
    .period-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }
    
    .period-info h5 {
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .period-info p {
        margin-bottom: 0;
        opacity: 0.9;
    }
    
    .form-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .form-section h6 {
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #ecf0f1;
    }
    
    .type-explanation {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0 5px 5px 0;
    }
    
    .type-explanation h6 {
        color: #007bff;
        margin-bottom: 0.5rem;
    }
    
    .type-explanation ul {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    
    .type-explanation li {
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-{{ page_icon }} text-primary"></i>
        {{ page_title }}
    </h1>
    <div class="btn-group" role="group">
        <a href="{% url 'paiements:liste_recapitulatifs' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Retour √† la liste
        </a>
    </div>
</div>

<!-- Information sur la p√©riode -->
<div class="period-info" id="periodInfo">
    <h5><i class="bi bi-calendar3"></i> S√©lection de la p√©riode</h5>
    <p id="periodDescription">Choisissez le type de r√©capitulatif et la p√©riode de r√©f√©rence pour g√©n√©rer automatiquement les calculs.</p>
</div>

<!-- Formulaire principal -->
<div class="form-section">
    <h6><i class="bi bi-file-earmark-text"></i> Informations du r√©capitulatif</h6>
    
    <form method="post" id="recapitulatifForm">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form.bailleur|as_crispy_field }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form.mois_recapitulatif|as_crispy_field }}
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form.type_recapitulatif|as_crispy_field }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form.notes|as_crispy_field }}
                </div>
            </div>
        </div>
        
        <!-- Explication du type s√©lectionn√© -->
        <div class="type-explanation" id="typeExplanation" style="display: none;">
            <h6 id="typeTitle">Type de r√©capitulatif</h6>
            <ul id="typeDetails">
                <!-- Contenu dynamique -->
            </ul>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <a href="{% url 'paiements:liste_recapitulatifs' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Annuler
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> Cr√©er le r√©capitulatif
            </button>
        </div>
    </form>
</div>

<!-- Aide contextuelle -->
<div class="form-section">
    <h6><i class="bi bi-info-circle"></i> Aide</h6>
    <div class="row">
        <div class="col-md-6">
            <h6 class="text-primary">Types de r√©capitulatifs</h6>
            <ul class="list-unstyled">
                <li><strong>üìÖ Mensuel :</strong> Calcul sur 1 mois</li>
                <li><strong>üìä Trimestriel :</strong> Calcul sur 3 mois</li>
                <li><strong>üìà Annuel :</strong> Calcul sur 12 mois</li>
                <li><strong>‚ö° Exceptionnel :</strong> P√©riode personnalis√©e</li>
            </ul>
        </div>
        <div class="col-md-6">
            <h6 class="text-success">Calculs automatiques</h6>
            <ul class="list-unstyled">
                <li>‚Ä¢ Loyers bruts √ó p√©riode</li>
                <li>‚Ä¢ Charges d√©ductibles √ó p√©riode</li>
                <li>‚Ä¢ Charges bailleur pour la p√©riode</li>
                <li>‚Ä¢ Montant net √† payer</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('id_type_recapitulatif');
    const periodInfo = document.getElementById('periodInfo');
    const periodDescription = document.getElementById('periodDescription');
    const typeExplanation = document.getElementById('typeExplanation');
    const typeTitle = document.getElementById('typeTitle');
    const typeDetails = document.getElementById('typeDetails');
    
    const typeExplanations = {
        'mensuel': {
            title: 'R√©capitulatif Mensuel',
            description: 'Calcul des loyers et charges pour 1 mois',
            details: [
                'Loyers bruts = loyer mensuel √ó 1',
                'Charges d√©ductibles = charges mensuelles √ó 1',
                'P√©riode : 1 mois complet',
                'Id√©al pour : Suivi mensuel standard'
            ]
        },
        'trimestriel': {
            title: 'R√©capitulatif Trimestriel',
            description: 'Calcul des loyers et charges pour 3 mois',
            details: [
                'Loyers bruts = loyer mensuel √ó 3',
                'Charges d√©ductibles = charges mensuelles √ó 3',
                'P√©riode : 3 mois (trimestre)',
                'Id√©al pour : Bilans trimestriels'
            ]
        },
        'annuel': {
            title: 'R√©capitulatif Annuel',
            description: 'Calcul des loyers et charges pour 12 mois',
            details: [
                'Loyers bruts = loyer mensuel √ó 12',
                'Charges d√©ductibles = charges mensuelles √ó 12',
                'P√©riode : 12 mois (ann√©e compl√®te)',
                'Id√©al pour : Bilans annuels'
            ]
        },
        'exceptionnel': {
            title: 'R√©capitulatif Exceptionnel',
            description: 'Calcul pour une p√©riode personnalis√©e',
            details: [
                'Loyers bruts = loyer mensuel √ó 1',
                'Charges d√©ductibles = charges mensuelles √ó 1',
                'P√©riode : 1 mois (r√©f√©rence)',
                'Id√©al pour : Situations particuli√®res'
            ]
        }
    };
    
    function updatePeriodLabel() {
        const selectedType = typeSelect.value;
        
        if (selectedType && typeExplanations[selectedType]) {
            const explanation = typeExplanations[selectedType];
            
            // Mettre √† jour la description
            periodDescription.textContent = explanation.description;
            
            // Afficher l'explication d√©taill√©e
            typeTitle.textContent = explanation.title;
            typeDetails.innerHTML = explanation.details.map(detail => `<li>${detail}</li>`).join('');
            typeExplanation.style.display = 'block';
            
            // Mettre √† jour le style de la p√©riode
            periodInfo.className = 'period-info';
            if (selectedType === 'trimestriel') {
                periodInfo.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            } else if (selectedType === 'annuel') {
                periodInfo.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
            } else if (selectedType === 'exceptionnel') {
                periodInfo.style.background = 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)';
            }
        } else {
            typeExplanation.style.display = 'none';
        }
    }
    
    // √âcouter les changements
    typeSelect.addEventListener('change', updatePeriodLabel);
    
    // Initialiser au chargement
    updatePeriodLabel();
    
    // Validation du formulaire
    document.getElementById('recapitulatifForm').addEventListener('submit', function(e) {
        const bailleur = document.getElementById('id_bailleur').value;
        const mois = document.getElementById('id_mois_recapitulatif').value;
        const type = document.getElementById('id_type_recapitulatif').value;
        
        if (!bailleur || !mois || !type) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs obligatoires.');
            return false;
        }
        
        // Confirmation avec d√©tails
        const typeText = typeSelect.options[typeSelect.selectedIndex].text;
        const confirmation = confirm(
            `Confirmer la cr√©ation du r√©capitulatif ?\n\n` +
            `Type : ${typeText}\n` +
            `Mois de r√©f√©rence : ${mois}\n\n` +
            `Les calculs seront effectu√©s automatiquement selon la p√©riode s√©lectionn√©e.`
        );
        
        if (!confirmation) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}