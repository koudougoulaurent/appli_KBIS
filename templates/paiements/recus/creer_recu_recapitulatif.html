{% extends 'base_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .recapitulatif-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-left: 4px solid #007bff;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .info-item {
        display: flex;
        flex-direction: column;
    }
    
    .info-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
        margin-bottom: 0.3rem;
    }
    
    .info-value {
        font-size: 1rem;
        color: #333;
        font-weight: 600;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 0.75rem;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .btn-group {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }
    
    .preview-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .preview-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 1rem;
    }
    
    .preview-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-{{ page_icon }}"></i>
                {{ page_title }}
            </h1>
            <p class="text-muted">
                Créer un reçu professionnel pour le récapitulatif mensuel
            </p>
        </div>
        <div>
            <a href="{% url 'paiements:detail_recapitulatif' recapitulatif.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour au récapitulatif
            </a>
        </div>
    </div>

    <!-- Informations du récapitulatif -->
    <div class="recapitulatif-info">
        <h5 class="mb-3">
            <i class="bi bi-file-earmark-text"></i>
            Récapitulatif de référence
        </h5>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Bailleur</div>
                <div class="info-value">{{ recapitulatif.bailleur.get_nom_complet }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Période</div>
                <div class="info-value">{{ recapitulatif.mois_recapitulatif|date:"F Y" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Type</div>
                <div class="info-value">{{ recapitulatif.get_type_recapitulatif_display }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Statut</div>
                <div class="info-value">
                    <span class="badge bg-{{ recapitulatif.get_statut_display_color }}">
                        {{ recapitulatif.get_statut_display }}
                    </span>
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">Date de création</div>
                <div class="info-value">{{ recapitulatif.date_creation|date:"d/m/Y H:i" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Gestionnaire</div>
                <div class="info-value">
                    {% if recapitulatif.gestionnaire %}
                        {{ recapitulatif.gestionnaire.get_full_name }}
                    {% else %}
                        Non assigné
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de création -->
    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div class="form-section">
            <div class="section-title">
                <i class="bi bi-gear"></i>
                Configuration du Reçu
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="type_recu" class="form-label">Type de reçu</label>
                        <select name="type_recu" id="type_recu" class="form-select" required>
                            {% for value, label in type_choices %}
                            <option value="{{ value }}" {% if value == 'recapitulatif' %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                            Veuillez sélectionner un type de reçu.
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="template_utilise" class="form-label">Template</label>
                        <select name="template_utilise" id="template_utilise" class="form-select" required>
                            {% for value, label in template_choices %}
                            <option value="{{ value }}" {% if value == 'professionnel' %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                            Veuillez sélectionner un template.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="format_impression" class="form-label">Format d'impression</label>
                        <select name="format_impression" id="format_impression" class="form-select" required>
                            {% for value, label in format_choices %}
                            <option value="{{ value }}" {% if value == 'A4_paysage' %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                            Veuillez sélectionner un format d'impression.
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="notes" class="form-label">Notes (optionnel)</label>
                        <textarea name="notes" id="notes" class="form-control" rows="3" 
                                  placeholder="Ajoutez des notes ou commentaires pour ce reçu..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aperçu des informations -->
        <div class="preview-section">
            <div class="preview-title">
                <i class="bi bi-eye"></i>
                Aperçu des informations du reçu
            </div>
            <div class="preview-info">
                <div class="info-item">
                    <div class="info-label">Numéro de reçu</div>
                    <div class="info-value">Généré automatiquement</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Bailleur</div>
                    <div class="info-value">{{ recapitulatif.bailleur.get_nom_complet }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Période</div>
                    <div class="info-value">{{ recapitulatif.mois_recapitulatif|date:"F Y" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Template</div>
                    <div class="info-value" id="preview-template">Professionnel</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Format</div>
                    <div class="info-value" id="preview-format">A4 Paysage</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Statut initial</div>
                    <div class="info-value">Brouillon</div>
                </div>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="btn-group">
            <a href="{% url 'paiements:detail_recapitulatif' recapitulatif.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Annuler
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Créer le Reçu
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validation des formulaires Bootstrap
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    // Mise à jour de l'aperçu en temps réel
    const templateSelect = document.getElementById('template_utilise');
    const formatSelect = document.getElementById('format_impression');
    const previewTemplate = document.getElementById('preview-template');
    const previewFormat = document.getElementById('preview-format');

    templateSelect.addEventListener('change', function() {
        previewTemplate.textContent = this.options[this.selectedIndex].text;
    });

    formatSelect.addEventListener('change', function() {
        previewFormat.textContent = this.options[this.selectedIndex].text;
    });
});
</script>
{% endblock %}
