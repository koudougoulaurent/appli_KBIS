{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .search-form {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .bailleur-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border-left: 4px solid transparent;
    }
    
    .bailleur-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-left-color: #0d6efd;
    }
    
    .bailleur-card.active {
        border-left-color: #198754;
        background-color: rgba(25, 135, 84, 0.05);
    }
    
    .search-highlight {
        background-color: #fff3cd;
        padding: 0.1em 0.2em;
        border-radius: 3px;
    }
    
    .no-results {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .search-stats {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-search text-primary me-2"></i>
                        {{ title }}
                    </h1>
                    <p class="text-muted mb-0">{{ subtitle }}</p>
                </div>
                <div>
                    <a href="{% url 'paiements:retrait_auto_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-2"></i>
                        Nouveau Retrait
                    </a>
                    <a href="{% url 'paiements:retrait_auto_create' %}" class="btn btn-outline-secondary ms-2">
                        <i class="bi bi-speedometer2 me-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de recherche -->
    <div class="search-form text-white">
        <form method="post" id="searchForm">
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.recherche.id_for_label }}" class="form-label fw-bold">
                        <i class="bi bi-search me-2"></i>
                        {{ form.recherche.label }}
                    </label>
                    {{ form.recherche }}
                    <div class="form-text text-white-50">{{ form.recherche.help_text }}</div>
                </div>
                
                <div class="col-md-3">
                    <label for="{{ form.statut.id_for_label }}" class="form-label fw-bold">
                        <i class="bi bi-person-check me-2"></i>
                        {{ form.statut.label }}
                    </label>
                    {{ form.statut }}
                </div>
                
                <div class="col-md-3">
                    <label for="{{ form.type_retrait.id_for_label }}" class="form-label fw-bold">
                        <i class="bi bi-arrow-up-circle me-2"></i>
                        {{ form.type_retrait.label }}
                    </label>
                    {{ form.type_retrait }}
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-light btn-lg me-2">
                        <i class="bi bi-search me-2"></i>
                        Rechercher
                    </button>
                    <button type="button" class="btn btn-outline-light btn-lg" onclick="resetSearch()">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Réinitialiser
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Résultats de recherche -->
    {% if recherche_effectuee %}
        <div class="search-stats">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Recherche effectuée
                    </h6>
                </div>
                <div class="col-md-6 text-end">
                    <span class="badge bg-primary fs-6">
                        {{ bailleurs|length }} résultat{{ bailleurs|length|pluralize:"s" }}
                    </span>
                </div>
            </div>
        </div>
        
        {% if bailleurs %}
            <div class="row">
                {% for bailleur in bailleurs %}
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card bailleur-card h-100" 
                             onclick="selectBailleur({{ bailleur.id }}, '{{ bailleur.get_nom_complet }}')">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-person-circle me-2"></i>
                                        {{ bailleur.get_nom_complet }}
                                    </h6>
                                    <span class="badge bg-light text-dark">
                                        {{ bailleur.code_bailleur }}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Email</small>
                                        <div class="fw-bold">
                                            {% if bailleur.email %}
                                                {{ bailleur.email|truncatechars:25 }}
                                            {% else %}
                                                <span class="text-muted">Non renseigné</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Téléphone</small>
                                        <div class="fw-bold">
                                            {% if bailleur.telephone %}
                                                {{ bailleur.telephone }}
                                            {% else %}
                                                <span class="text-muted">Non renseigné</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Statut</small>
                                        <div>
                                            <span class="badge {% if bailleur.est_actif %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if bailleur.est_actif %}Actif{% else %}Inactif{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Membre depuis</small>
                                        <div class="fw-bold">
                                            {% if bailleur.date_creation %}
                                                {{ bailleur.date_creation|date:"M Y" }}
                                            {% else %}
                                                <span class="text-muted">Non renseigné</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                {% if bailleur.adresse %}
                                    <div class="mb-3">
                                        <small class="text-muted">Adresse</small>
                                        <div class="fw-bold">
                                            {{ bailleur.adresse|truncatechars:50 }}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Cliquez pour voir le contexte
                                    </small>
                                    <div>
                                        <a href="{% url 'paiements:contexte_bailleur_rapide' bailleur.id %}" 
                                           class="btn btn-sm btn-outline-primary me-2">
                                            <i class="bi bi-eye me-1"></i>
                                            Contexte
                                        </a>
                                        <a href="{% url 'paiements:retrait_auto_create' %}?bailleur={{ bailleur.id }}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="bi bi-plus-lg me-1"></i>
                                            Retrait
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-results">
                <i class="bi bi-search fa-3x mb-3"></i>
                <h5>Aucun résultat trouvé</h5>
                <p class="text-muted">
                    Essayez de modifier vos critères de recherche ou utilisez des termes plus généraux.
                </p>
                <button type="button" class="btn btn-outline-primary" onclick="resetSearch()">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    Nouvelle recherche
                </button>
            </div>
        {% endif %}
    {% else %}
        <!-- Instructions de recherche -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-lightbulb me-2"></i>
                            Comment effectuer une recherche intelligente
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Conseils de recherche</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Utilisez le nom ou prénom du bailleur</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Recherchez par code bailleur</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Filtrez par statut (actif/inactif)</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Filtrez par type de retrait</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Combinez plusieurs critères</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Exemples de recherche</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-search text-info me-2"></i><code>Jean</code> - Trouve tous les Jean</li>
                                    <li><i class="bi bi-search text-info me-2"></i><code>DUP</code> - Trouve les noms commençant par DUP</li>
                                    <li><i class="bi bi-search text-info me-2"></i><code>@gmail.com</code> - Trouve les emails Gmail</li>
                                    <li><i class="bi bi-search text-info me-2"></i><code>+225</code> - Trouve les téléphones ivoiriens</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistiques de recherche -->
        <div class="row mt-4">
            <div class="col-md-4 mb-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary fa-2x mb-2"></i>
                        <h5 class="card-title">Recherche Rapide</h5>
                        <p class="card-text text-muted">
                            Trouvez instantanément un bailleur par son nom, code ou email
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <i class="bi bi-funnel-fill text-success fa-2x mb-2"></i>
                        <h5 class="card-title">Filtres Intelligents</h5>
                        <p class="card-text text-muted">
                            Utilisez des filtres avancés pour affiner vos résultats
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <i class="bi bi-arrow-up-circle text-info fa-2x mb-2"></i>
                        <h5 class="card-title">Création Directe</h5>
                        <p class="card-text text-muted">
                            Créez directement un retrait depuis les résultats de recherche
                        </p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal de sélection de bailleur -->
<div class="modal fade" id="bailleurModal" tabindex="-1" aria-labelledby="bailleurModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="bailleurModalLabel">
                    <i class="bi bi-person-circle me-2"></i>
                    Bailleur sélectionné
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="bailleurModalContent">
                    <!-- Le contenu sera chargé dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-2"></i>
                    Fermer
                </button>
                <a href="#" id="createRetraitBtn" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-2"></i>
                    Créer un Retrait
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let selectedBailleurId = null;
    let selectedBailleurName = null;
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser les composants Bootstrap
        initializeBootstrapComponents();
        
        // Gestionnaire de soumission du formulaire
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            // Validation basique
            const recherche = document.getElementById('{{ form.recherche.id_for_label }}').value.trim();
            if (recherche.length < 2) {
                e.preventDefault();
                alert('La recherche doit contenir au moins 2 caractères.');
                return false;
            }
        });
        
        // Auto-complétion de la recherche
        const rechercheInput = document.getElementById('{{ form.recherche.id_for_label }}');
        if (rechercheInput) {
            rechercheInput.addEventListener('input', function() {
                // Ici vous pourriez implémenter une auto-complétion en temps réel
                // en appelant une API avec les caractères saisis
            });
        }
    });
    
    // Initialiser les composants Bootstrap
    function initializeBootstrapComponents() {
        // Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Popovers
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    }
    
    // Sélectionner un bailleur
    function selectBailleur(bailleurId, bailleurName) {
        selectedBailleurId = bailleurId;
        selectedBailleurName = bailleurName;
        
        // Mettre à jour le modal
        document.getElementById('bailleurModalLabel').innerHTML = 
            `<i class="bi bi-person-circle me-2"></i>${bailleurName}`;
        
        // Mettre à jour le bouton de création de retrait
        document.getElementById('createRetraitBtn').href = 
            `{% url 'paiements:retrait_auto_create' %}?bailleur=${bailleurId}`;
        
        // Charger le contexte du bailleur
        loadBailleurContext(bailleurId);
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('bailleurModal'));
        modal.show();
        
        // Mettre en surbrillance la carte sélectionnée
        highlightSelectedCard(bailleurId);
    }
    
    // Charger le contexte d'un bailleur
    async function loadBailleurContext(bailleurId) {
        try {
            const response = await fetch(`/paiements/api/contexte-bailleur/${bailleurId}/`);
            const data = await response.json();
            
            if (data.success) {
                displayBailleurContext(data.data);
            } else {
                displayError('Erreur lors du chargement du contexte');
            }
        } catch (error) {
            console.error('Erreur:', error);
            displayError('Erreur de connexion');
        }
    }
    
    // Afficher le contexte du bailleur
    function displayBailleurContext(contexte) {
        const container = document.getElementById('bailleurModalContent');
        
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary">Informations Générales</h6>
                    <p><strong>Code:</strong> ${contexte.bailleur.code_bailleur}</p>
                    <p><strong>Email:</strong> ${contexte.bailleur.email || 'Non renseigné'}</p>
                    <p><strong>Téléphone:</strong> ${contexte.bailleur.telephone || 'Non renseigné'}</p>
                    <p><strong>Statut:</strong> 
                        <span class="badge ${contexte.bailleur.est_actif ? 'bg-success' : 'bg-danger'}">
                            ${contexte.bailleur.est_actif ? 'Actif' : 'Inactif'}
                        </span>
                    </p>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary">Statistiques</h6>
                    <p><strong>Propriétés:</strong> ${contexte.proprietes.total_proprietes}</p>
                    <p><strong>Contrats actifs:</strong> ${contexte.contrats_actifs.total_contrats}</p>
                    <p><strong>Loyer mensuel total:</strong> ${formatCurrency(contexte.contrats_actifs.total_loyer_mensuel)}</p>
                    <p><strong>Alertes:</strong> ${contexte.alertes.length}</p>
                </div>
            </div>
            
            <hr class="my-3">
            
            <div class="row">
                <div class="col-12">
                    <h6 class="text-primary">Calculs Automatiques - ${contexte.calculs_automatiques.mois_courant}</h6>
                    <div class="alert alert-${contexte.calculs_automatiques.peut_creer_retrait ? 'success' : 'warning'}">
                        <i class="bi bi-info-circle me-2"></i>
                        ${contexte.calculs_automatiques.peut_creer_retrait ? 
                            `Un retrait de ${formatCurrency(contexte.calculs_automatiques.montant_net_a_payer)} peut être créé` :
                            `Aucun retrait ne peut être créé (montant net: ${formatCurrency(contexte.calculs_automatiques.montant_net_a_payer)})`
                        }
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    // Afficher une erreur
    function displayError(message) {
        const container = document.getElementById('bailleurModalContent');
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
    }
    
    // Mettre en surbrillance la carte sélectionnée
    function highlightSelectedCard(bailleurId) {
        // Retirer la surbrillance de toutes les cartes
        document.querySelectorAll('.bailleur-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Ajouter la surbrillance à la carte sélectionnée
        const selectedCard = document.querySelector(`[onclick*="${bailleurId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }
    }
    
    // Réinitialiser la recherche
    function resetSearch() {
        document.getElementById('searchForm').reset();
        window.location.href = window.location.pathname;
    }
    
    // Formater la monnaie
    function formatCurrency(amount) {
        if (amount === null || amount === undefined) return '0 F CFA';
        return new Intl.NumberFormat('fr-FR', {
            style: 'currency',
            currency: 'F CFA',
            minimumFractionDigits: 0
        }).format(amount);
    }
    
    // Recherche en temps réel (optionnel)
    function setupRealTimeSearch() {
        const rechercheInput = document.getElementById('{{ form.recherche.id_for_label }}');
        let searchTimeout;
        
        rechercheInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Ici vous pourriez implémenter une recherche en temps réel
                // en appelant une API et affichant les suggestions
            }, 300);
        });
    }
</script>
{% endblock %}

