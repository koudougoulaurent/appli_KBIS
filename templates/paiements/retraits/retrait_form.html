{% extends 'base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }} - KBIS IMMOBILIER{% endblock %}

{% block content %}
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-pencil text-primary me-2"></i>
                        {{ title }}
                    </h1>
                    <p class="text-muted mb-0">
                        Modifier le retrait #{{ retrait.id }} - {{ retrait.bailleur.get_nom_complet }}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'paiements:retrait_detail' retrait.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i> Retour au détail
                    </a>
                    <a href="{% url 'paiements:retraits_liste' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-list me-2"></i> Liste des retraits
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Formulaire -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-edit me-2"></i> Modifier le Retrait
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row g-3">
                            <!-- Informations de base -->
                            <div class="col-md-6">
                                <label for="{{ form.bailleur.id_for_label }}" class="form-label fw-bold">
                                    {{ form.bailleur.label }}
                                </label>
                                {{ form.bailleur }}
                                {% if form.bailleur.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.bailleur.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.mois_retrait.id_for_label }}" class="form-label fw-bold">
                                    {{ form.mois_retrait.label }}
                                </label>
                                {{ form.mois_retrait }}
                                {% if form.mois_retrait.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.mois_retrait.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Type et mode -->
                            <div class="col-md-6">
                                <label for="{{ form.type_retrait.id_for_label }}" class="form-label fw-bold">
                                    {{ form.type_retrait.label }}
                                </label>
                                {{ form.type_retrait }}
                                {% if form.type_retrait.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.type_retrait.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.mode_retrait.id_for_label }}" class="form-label fw-bold">
                                    {{ form.mode_retrait.label }}
                                </label>
                                {{ form.mode_retrait }}
                                {% if form.mode_retrait.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.mode_retrait.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Montants -->
                            <div class="col-md-4">
                                <label for="{{ form.montant_loyers_bruts.id_for_label }}" class="form-label fw-bold">
                                    {{ form.montant_loyers_bruts.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.montant_loyers_bruts }}
                                    <span class="input-group-text">F CFA</span>
                                </div>
                                {% if form.montant_loyers_bruts.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.montant_loyers_bruts.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.montant_charges_deductibles.id_for_label }}" class="form-label fw-bold">
                                    {{ form.montant_charges_deductibles.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.montant_charges_deductibles }}
                                    <span class="input-group-text">F CFA</span>
                                </div>
                                {% if form.montant_charges_deductibles.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.montant_charges_deductibles.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.montant_net_a_payer.id_for_label }}" class="form-label fw-bold">
                                    {{ form.montant_net_a_payer.label }}
                                </label>
                                <div class="input-group">
                                    {{ form.montant_net_a_payer }}
                                    <span class="input-group-text">F CFA</span>
                                </div>
                                {% if form.montant_net_a_payer.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.montant_net_a_payer.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Dates -->
                            <div class="col-md-6">
                                <label for="{{ form.date_demande.id_for_label }}" class="form-label fw-bold">
                                    {{ form.date_demande.label }}
                                </label>
                                {{ form.date_demande }}
                                {% if form.date_demande.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.date_demande.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.date_versement.id_for_label }}" class="form-label fw-bold">
                                    {{ form.date_versement.label }}
                                </label>
                                {{ form.date_versement }}
                                {% if form.date_versement.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.date_versement.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Informations bancaires -->
                            {% if form.numero_cheque %}
                            <div class="col-md-6">
                                <label for="{{ form.numero_cheque.id_for_label }}" class="form-label fw-bold">
                                    {{ form.numero_cheque.label }}
                                </label>
                                {{ form.numero_cheque }}
                                {% if form.numero_cheque.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.numero_cheque.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            {% if form.reference_virement %}
                            <div class="col-md-6">
                                <label for="{{ form.reference_virement.id_for_label }}" class="form-label fw-bold">
                                    {{ form.reference_virement.label }}
                                </label>
                                {{ form.reference_virement }}
                                {% if form.reference_virement.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.reference_virement.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- Notes -->
                            <div class="col-12">
                                <label for="{{ form.notes.id_for_label }}" class="form-label fw-bold">
                                    {{ form.notes.label }}
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.notes.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i> Enregistrer les modifications
                            </button>
                            <a href="{% url 'paiements:retrait_detail' retrait.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i> Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Informations du retrait -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i> Informations actuelles
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>Statut:</strong> 
                        <span class="badge bg-{{ retrait.get_statut_display_color }}">
                            {{ retrait.get_statut_display }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <strong>Créé le:</strong> {{ retrait.date_creation|date:"d/m/Y H:i" }}
                    </div>
                    <div class="mb-2">
                        <strong>Dernière modification:</strong> {{ retrait.date_modification|date:"d/m/Y H:i" }}
                    </div>
                    {% if retrait.valide_par %}
                    <div class="mb-2">
                        <strong>Validé par:</strong> {{ retrait.valide_par.get_nom_complet }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Aide -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i> Aide
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        <strong>Note:</strong> Une fois le retrait validé, certaines modifications ne seront plus possibles.
                    </p>
                    <p class="small text-muted">
                        Les montants sont automatiquement calculés et mis à jour lors de la sauvegarde.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-control, .form-select {
    border-radius: 0.375rem;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}
</style>
{% endblock %}
