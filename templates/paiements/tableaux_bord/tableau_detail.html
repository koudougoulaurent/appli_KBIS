{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{{ title }} - {{ config.nom_entreprise|default:"Gestion Immobilière" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .stats-card .card-body {
        padding: 2rem;
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    .alert-card {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        border: none;
        border-radius: 15px;
    }
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .action-buttons .btn {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        margin: 0.25rem;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
    }
    .status-active { background-color: #28a745; color: white; }
    .status-inactive { background-color: #6c757d; color: white; }
    .status-alert { background-color: #dc3545; color: white; }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .info-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        border-left: 4px solid #007bff;
    }
    .info-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .info-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
    }
</style>
{% endblock %}

{% block content %}
    <!-- En-tête avec actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h2 mb-0">
                        <i class="bi bi-graph-up text-primary me-2"></i>
                        {{ tableau.nom }}
                    </h1>
                    <p class="text-muted mb-0">
                        {{ tableau.description|default:"Aucune description" }}
                    </p>
                </div>
                <div class="action-buttons">
                    <a href="{% url 'paiements:tableau_bord_update' tableau.pk %}" class="btn btn-primary">
                        <i class="bi bi-pencil me-2"></i>Modifier
                    </a>
                    <a href="{% url 'paiements:tableau_bord_export_pdf' tableau.pk %}" class="btn btn-success">
                        <i class="bi bi-file-pdf me-2"></i>Exporter PDF
                    </a>
                    <a href="{% url 'paiements:tableau_bord_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Retour
                    </a>
                </div>
            </div>
            
            <!-- Statut et informations générales -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="info-item">
                        <div class="info-label">Statut</div>
                        <div class="info-value">
                            <span class="status-badge status-{{ tableau.get_statut_display|lower }}">
                                {{ tableau.get_statut_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <div class="info-label">Période d'analyse</div>
                        <div class="info-value">{{ tableau.get_periode_display }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <div class="info-label">Propriétés incluses</div>
                        <div class="info-value">{{ tableau.get_nombre_proprietes }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-item">
                        <div class="info-label">Bailleurs inclus</div>
                        <div class="info-value">{{ tableau.get_nombre_bailleurs }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques principales -->
    <div class="row g-4 mb-4">
        {% if tableau.afficher_revenus %}
        <div class="col-md-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <i class="bi bi-cash-coin display-4 mb-3"></i>
                    <div class="metric-value">{{ stats.revenus|floatformat:0 }} {{ tableau.devise }}</div>
                    <div class="metric-label">Revenus</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if tableau.afficher_charges %}
        <div class="col-md-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <i class="bi bi-credit-card display-4 mb-3"></i>
                    <div class="metric-value">{{ stats.charges|floatformat:0 }} {{ tableau.devise }}</div>
                    <div class="metric-label">Charges</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if tableau.afficher_benefices %}
        <div class="col-md-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up-arrow display-4 mb-3"></i>
                    <div class="metric-value">{{ stats.benefices|floatformat:0 }} {{ tableau.devise }}</div>
                    <div class="metric-label">Bénéfices</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if tableau.afficher_taux_occupation %}
        <div class="col-md-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <i class="bi bi-house-check display-4 mb-3"></i>
                    <div class="metric-value">{{ stats.taux_occupation|floatformat:1 }}%</div>
                    <div class="metric-label">Taux d'occupation</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Alertes -->
    {% if tableau.is_alerte_active %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-card border-0">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle display-6 me-3"></i>
                    <div>
                        <h5 class="mb-1">Alerte financière</h5>
                        <p class="mb-0">
                            Les bénéfices ({{ stats.benefices|floatformat:0 }} {{ tableau.devise }}) 
                            sont inférieurs au seuil d'alerte ({{ tableau.seuil_alerte }} {{ tableau.devise }}).
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Graphiques et visualisations -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Graphique des revenus vs charges -->
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-bar-chart me-2"></i>
                    Évolution des revenus et charges
                </h5>
                <canvas id="revenueChart" height="100"></canvas>
            </div>

            <!-- Graphique du taux d'occupation -->
            {% if tableau.afficher_taux_occupation %}
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-pie-chart me-2"></i>
                    Taux d'occupation par propriété
                </h5>
                <canvas id="occupationChart" height="100"></canvas>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Détails des propriétés -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-building me-2"></i>
                        Propriétés incluses
                    </h6>
                </div>
                <div class="card-body">
                    {% if tableau.proprietes.all %}
                        <div class="list-group list-group-flush">
                            {% for propriete in tableau.proprietes.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                <div>
                                    <strong>{{ propriete.titre }}</strong>
                                    <br>
                                    <small class="text-muted">{{ propriete.adresse }}</small>
                                </div>
                                <span class="badge bg-primary rounded-pill">
                                    {{ propriete.get_type_bien_display }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Aucune propriété sélectionnée</p>
                    {% endif %}
                </div>
            </div>

            <!-- Détails des bailleurs -->
            {% if tableau.bailleurs.all %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-person me-2"></i>
                        Bailleurs inclus
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for bailleur in tableau.bailleurs.all %}
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <div>
                                <strong>{{ bailleur.nom }} {{ bailleur.prenom }}</strong>
                                <br>
                                <small class="text-muted">{{ bailleur.email|default:bailleur.telephone }}</small>
                            </div>
                            <span class="badge bg-info rounded-pill">
                                {{ bailleur.numero_bailleur }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Informations de configuration -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Configuration
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <small class="text-muted">Devise</small>
                            <div class="fw-bold">{{ tableau.devise }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Seuil d'alerte</small>
                            <div class="fw-bold">
                                {% if tableau.seuil_alerte %}
                                    {{ tableau.seuil_alerte }} {{ tableau.devise }}
                                {% else %}
                                    Non défini
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-12 mt-2">
                            <small class="text-muted">Couleur du thème</small>
                            <div class="d-flex align-items-center">
                                <div class="color-preview" style="background-color: {{ tableau.couleur_theme }};"></div>
                                <span class="ms-2 fw-bold">{{ tableau.couleur_theme }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métadonnées -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Informations
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <small class="text-muted">Créé par</small>
                            <div class="fw-bold">{{ tableau.cree_par.get_full_name|default:tableau.cree_par.username }}</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Date de création</small>
                            <div class="fw-bold">{{ tableau.date_creation|date:"d/m/Y H:i" }}</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Dernière modification</small>
                            <div class="fw-bold">{{ tableau.date_modification|date:"d/m/Y H:i" }}</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Période analysée</small>
                            <div class="fw-bold">
                                Du {{ stats.periode.debut|date:"d/m/Y" }} au {{ stats.periode.fin|date:"d/m/Y" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration des couleurs
    const colors = {
        primary: '{{ tableau.couleur_theme }}',
        secondary: '#6c757d',
        success: '#28a745',
        danger: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };

    // Graphique des revenus vs charges
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: ['Revenus', 'Charges', 'Bénéfices'],
            datasets: [{
                label: 'Montants ({{ tableau.devise }})',
                data: [
                    {{ stats.revenus|default:0 }},
                    {{ stats.charges|default:0 }},
                    {{ stats.benefices|default:0 }}
                ],
                backgroundColor: [
                    colors.success,
                    colors.danger,
                    colors.primary
                ],
                borderColor: [
                    colors.success,
                    colors.danger,
                    colors.primary
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' {{ tableau.devise }}';
                        }
                    }
                }
            }
        }
    });

    {% if tableau.afficher_taux_occupation %}
    // Graphique du taux d'occupation
    const occupationCtx = document.getElementById('occupationChart').getContext('2d');
    new Chart(occupationCtx, {
        type: 'doughnut',
        data: {
            labels: ['Occupées', 'Libres'],
            datasets: [{
                data: [
                    {{ stats.taux_occupation|default:0 }},
                    {{ 100|add:"-"|add:stats.taux_occupation|default:0 }}
                ],
                backgroundColor: [
                    colors.success,
                    colors.secondary
                ],
                borderColor: [
                    colors.success,
                    colors.secondary
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}
