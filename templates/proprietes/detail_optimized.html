{% extends 'base.html' %}
{% load static %}

{% block title %}{{ propriete.titre }} - Gestion Immobilière{% endblock %}

{% block extra_css %}
<style>
    .lazy-load {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    .lazy-load.loaded {
        opacity: 1;
    }
    .card-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Navigation optimisée -->
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'proprietes:liste' %}">Propriétés</a></li>
                    <li class="breadcrumb-item active">{{ propriete.titre|truncatechars:30 }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Informations principales - Chargement immédiat -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-info-circle"></i> Informations Générales</h5>
                    <div class="btn-group" role="group">
                        <a href="{% url 'proprietes:modifier' propriete.pk %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i> Modifier
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Type :</strong> {{ propriete.type_bien }}</p>
                            <p><strong>Surface :</strong> {{ propriete.surface|default:"N/A" }} m²</p>
                            <p><strong>Pièces :</strong> {{ propriete.nombre_pieces|default:"N/A" }} 
                                {% if propriete.nombre_chambres %}({{ propriete.nombre_chambres }} chambres{% endif %}
                                {% if propriete.nombre_salles_bain %}, {{ propriete.nombre_salles_bain }} SDB{% endif %})
                            </p>
                            <p><strong>État :</strong> 
                                <span class="badge bg-{% if propriete.etat == 'excellent' %}success{% elif propriete.etat == 'bon' %}primary{% elif propriete.etat == 'moyen' %}warning{% else %}danger{% endif %}">
                                    {{ propriete.get_etat_display }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Disponible :</strong> 
                                {% if propriete.disponible %}
                                    <span class="badge bg-success">Oui</span>
                                {% else %}
                                    <span class="badge bg-danger">Non</span>
                                {% endif %}
                            </p>
                            <p><strong>Bailleur :</strong> 
                                <a href="{% url 'proprietes:detail_bailleur' propriete.bailleur.pk %}">
                                    {{ propriete.bailleur.get_nom_complet }}
                                </a>
                            </p>
                            <p><strong>Type de gestion :</strong> 
                                <span class="badge bg-info">{{ propriete.get_type_gestion_display }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions rapides - Chargement immédiat -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-lightning"></i> Actions Rapides</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <a href="{% url 'proprietes:charges_bailleur_ajouter' propriete.pk %}" class="btn btn-warning w-100">
                                <i class="bi bi-plus"></i> Nouvelle Charge
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'proprietes:charges_bailleur_liste' %}?propriete={{ propriete.pk }}" class="btn btn-info w-100">
                                <i class="bi bi-list"></i> Gérer Charges
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'proprietes:modifier' propriete.pk %}" class="btn btn-primary w-100">
                                <i class="bi bi-pencil"></i> Modifier Propriété
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'proprietes:detail_bailleur' propriete.bailleur.pk %}" class="btn btn-secondary w-100">
                                <i class="bi bi-person"></i> Voir Bailleur
                            </a>
                        </div>
                        {% if propriete.type_gestion == 'unites_multiples' %}
                        <div class="col-md-4">
                            <a href="{% url 'proprietes:unite_create_propriete' propriete.pk %}" class="btn btn-outline-success w-100">
                                <i class="bi bi-plus"></i> Nouvelle Unité Locative
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'proprietes:gestion_pieces' propriete.pk %}" class="btn btn-outline-primary w-100">
                                <i class="bi bi-grid-3x3-gap"></i> Gestion des Pièces
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Chargement différé -->
        <div class="col-lg-4">
            <!-- Statistiques - Chargement différé -->
            <div class="card mb-4 lazy-load" data-load="stats">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up"></i> Statistiques</h5>
                </div>
                <div class="card-body card-skeleton" style="height: 200px;">
                    <!-- Skeleton loader -->
                </div>
            </div>

            <!-- Informations système - Chargement immédiat -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-gear"></i> Informations Système</h5>
                </div>
                <div class="card-body">
                    <p><strong>Créé le :</strong> {{ propriete.date_creation|date:"d/m/Y H:i" }}</p>
                    <p><strong>Modifié le :</strong> {{ propriete.date_modification|date:"d/m/Y H:i" }}</p>
                    <p><strong>Créé par :</strong> {{ propriete.cree_par.username }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu différé -->
    <div class="row">
        <div class="col-12">
            <!-- Contrats - Chargement différé -->
            <div class="card mb-4 lazy-load" data-load="contrats">
                <div class="card-header">
                    <h5><i class="bi bi-file-text"></i> Contrats Récents</h5>
                </div>
                <div class="card-body card-skeleton" style="height: 300px;">
                    <!-- Skeleton loader -->
                </div>
            </div>

            <!-- Paiements - Chargement différé -->
            <div class="card mb-4 lazy-load" data-load="paiements">
                <div class="card-header">
                    <h5><i class="bi bi-credit-card"></i> Paiements Récents</h5>
                </div>
                <div class="card-body card-skeleton" style="height: 300px;">
                    <!-- Skeleton loader -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lazy loading des sections
    const lazyElements = document.querySelectorAll('.lazy-load');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const element = entry.target;
                const loadType = element.dataset.load;
                
                // Charger le contenu via AJAX
                loadContent(loadType, element);
                observer.unobserve(element);
            }
        });
    });
    
    lazyElements.forEach(el => observer.observe(el));
    
    function loadContent(type, element) {
        const url = `{% url 'proprietes:detail' propriete.pk %}/ajax/${type}/`;
        
        fetch(url)
            .then(response => response.text())
            .then(html => {
                element.querySelector('.card-body').innerHTML = html;
                element.classList.add('loaded');
            })
            .catch(error => {
                console.error('Erreur lors du chargement:', error);
                element.querySelector('.card-body').innerHTML = 
                    '<div class="alert alert-warning">Erreur lors du chargement des données</div>';
            });
    }
});
</script>
{% endblock %}
