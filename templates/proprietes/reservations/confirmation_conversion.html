{% extends "base.html" %}
{% load static %}
{% load core_extras %}

{% block title %}Confirmer la conversion - Gestion Immobilière{% endblock %}

{% block extra_css %}
<style>
.conversion-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
}

.conversion-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #28a745;
}

.conversion-summary {
    background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
    border-radius: 10px;
    padding: 20px;
    border: 2px solid #28a745;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #c3e6cb;
}

.summary-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    font-weight: bold;
    font-size: 1.1rem;
    border-top: 2px solid #28a745;
    padding-top: 15px;
}

.btn-conversion {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    font-weight: 600;
    padding: 12px 30px;
    border-radius: 25px;
    transition: all 0.3s;
}

.btn-conversion:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    color: white;
}

.btn-cancel {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border: none;
    color: white;
    font-weight: 600;
    padding: 12px 30px;
    border-radius: 25px;
    transition: all 0.3s;
}

.btn-cancel:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
    color: white;
}

.alert-conversion {
    border: none;
    border-radius: 10px;
    padding: 15px 20px;
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 4px solid #ffc107;
}
</style>
{% endblock %}

{% block content %}
    <!-- En-tête -->
    <div class="conversion-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-sync-alt"></i> Convertir en Contrat</h2>
                <p class="mb-0 opacity-90">
                    Confirmer la conversion de la réservation en contrat de bail
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'proprietes:unite_detail' unite.pk %}" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Retour à l'unité
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Informations de la réservation -->
            <div class="conversion-card">
                <h5><i class="fas fa-calendar-check"></i> Informations de la Réservation</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Référence :</strong> #{{ reservation.pk }}</p>
                        <p><strong>Unité :</strong> {{ reservation.unite_locative.numero_unite }}</p>
                        <p><strong>Locataire :</strong> {{ reservation.locataire_potentiel.get_nom_complet }}</p>
                        <p><strong>Statut :</strong> 
                            <span class="badge bg-{% if reservation.statut == 'confirmee' %}success{% elif reservation.statut == 'en_attente' %}warning{% else %}secondary{% endif %}">
                                {{ reservation.get_statut_display }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Date de début souhaitée :</strong> {{ reservation.date_debut_souhaitee|date:"d/m/Y" }}</p>
                        {% if reservation.date_fin_prevue %}
                            <p><strong>Date de fin prévue :</strong> {{ reservation.date_fin_prevue|date:"d/m/Y" }}</p>
                        {% endif %}
                        <p><strong>Date d'expiration :</strong> {{ reservation.date_expiration|date:"d/m/Y H:i" }}</p>
                        {% if reservation.montant_reservation > 0 %}
                            <p><strong>Montant réservé :</strong> {{ reservation.montant_reservation|format_currency_fcfa }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Informations de l'unité -->
            <div class="conversion-card">
                <h5><i class="fas fa-home"></i> Informations de l'Unité</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Numéro :</strong> {{ unite.numero_unite }}</p>
                        <p><strong>Nom :</strong> {{ unite.nom }}</p>
                        <p><strong>Type :</strong> {{ unite.get_type_unite_display }}</p>
                        {% if unite.surface %}
                            <p><strong>Surface :</strong> {{ unite.surface }} m²</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p><strong>Loyer mensuel :</strong> {{ unite.loyer_mensuel|format_currency_fcfa }}</p>
                        {% if unite.charges_mensuelles > 0 %}
                            <p><strong>Charges mensuelles :</strong> {{ unite.charges_mensuelles|format_currency_fcfa }}</p>
                        {% endif %}
                        <p><strong>Total mensuel :</strong> <span class="text-success fw-bold">{{ unite.get_loyer_total|format_currency_fcfa }}</span></p>
                        <p><strong>Caution demandée :</strong> {{ unite.caution_demandee|format_currency_fcfa }}</p>
                    </div>
                </div>
            </div>

            <!-- Formulaire de confirmation -->
            <form method="post" class="text-center mt-4">
                {% csrf_token %}
                <p class="lead">
                    Êtes-vous sûr de vouloir convertir cette réservation en contrat de bail ?
                </p>
                <p class="text-muted">
                    Cette action créera un nouveau contrat avec les informations de la réservation.
                </p>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-conversion btn-lg me-3">
                        <i class="fas fa-check"></i> Confirmer la conversion
                    </button>
                    <a href="{% url 'proprietes:unite_detail' unite.pk %}" class="btn btn-cancel btn-lg">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Résumé de la conversion -->
            <div class="conversion-summary sticky-top">
                <h5><i class="fas fa-clipboard-check"></i> Résumé de la Conversion</h5>
                
                <div class="summary-item">
                    <span>Unité :</span>
                    <span class="fw-bold">{{ unite.numero_unite }}</span>
                </div>
                
                <div class="summary-item">
                    <span>Locataire :</span>
                    <span>{{ reservation.locataire_potentiel.get_nom_complet }}</span>
                </div>
                
                <div class="summary-item">
                    <span>Date de début :</span>
                    <span>{{ reservation.date_debut_souhaitee|date:"d/m/Y" }}</span>
                </div>
                
                {% if reservation.date_fin_prevue %}
                <div class="summary-item">
                    <span>Date de fin :</span>
                    <span>{{ reservation.date_fin_prevue|date:"d/m/Y" }}</span>
                </div>
                {% endif %}
                
                <div class="summary-item">
                    <span>Loyer mensuel :</span>
                    <span class="text-primary">{{ unite.loyer_mensuel|format_currency_fcfa }}</span>
                </div>
                
                <div class="summary-item">
                    <span>Caution :</span>
                    <span class="text-warning">{{ unite.caution_demandee|format_currency_fcfa }}</span>
                </div>
                
                <div class="summary-item">
                    <span><strong>Total à prévoir :</strong></span>
                    <span class="text-success"><strong>{{ unite.loyer_mensuel|add:unite.caution_demandee|format_currency_fcfa }}</strong></span>
                </div>
            </div>

            <!-- Avertissement -->
            <div class="alert alert-conversion">
                <h6><i class="fas fa-exclamation-triangle"></i> Avertissement Important</h6>
                <ul class="mb-0 ps-3">
                    <li>Cette action est irréversible</li>
                    <li>La réservation sera marquée comme "convertie"</li>
                    <li>L'unité sera marquée comme "occupée"</li>
                    <li>Un nouveau contrat sera créé</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}